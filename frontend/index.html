<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Case Study LMS - Leave Management System</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<!-- LOGIN PAGE -->
<div id="loginPage">
  <div class="login-container" id="loginContainer" style="max-width: 980px;">
    <h1 class="login-title">Case Study LMS</h1>
    <p class="login-subtitle">Leave Management System</p>
    <div id="loginPanel" style="display: block; max-width: 420px; margin: 0 auto 1.75rem auto;">
    <form id="loginForm">
      <div class="form-group">
        <label class="form-label" for="loginEmail">Email or Staff Code</label>
        <input 
          type="text" 
          id="loginEmail" 
          class="form-input" 
          placeholder="email@example.com or RT001"
          required
        />
      </div>
      
      <div class="form-group">
        <label class="form-label" for="loginPassword">Password</label>
        <input 
          type="password" 
          id="loginPassword" 
          class="form-input" 
          placeholder="Enter your password"
          required
        />
      </div>
      
      <button id="loginSubmitBtn" type="submit" class="btn btn-primary login-submit-btn" style="width: 100%;">
        Login
      </button>
      <div id="loginFeedback" class="login-feedback" aria-live="polite"></div>
    </form>
    <div style="margin-top: 0.75rem; text-align: center;">
      <button type="button" class="btn" onclick="handleForgotPassword()" style="background: #e5e7eb; color: #374151; padding: 0.5rem 1rem; font-size: 0.875rem; width: 100%;">
        Forgot Password
      </button>
    </div>
    
    <div style="margin-top: 1.5rem; text-align: center; font-size: 0.875rem; color: #6b7280;">
      <p style="margin-bottom: 0.5rem;">Test Accounts (default password = staff code + &quot;lms&quot;):</p>
      <p><strong>Employee:</strong> mary@example.com | OF001lms</p>
      <p><strong>Approver:</strong> john@example.com | MG001lms</p>
      <p><strong>Admin:</strong> leave@example.com | ADMINlms</p>
	  <p><strong>Retail Supervisor:</strong> supervisor@example.com | DJ001lms</p>
      <p><strong>Retail:</strong> RT001 | RT001lms</p>
    </div>
    </div>

    <div id="loginCalendarPanel" style="margin-top: 0.25rem; text-align: left;">
      <h3 style="margin: 0 0 0.75rem 0; color: #374151; text-align: center;">Team Leave Calendar</h3>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
        <button class="btn" onclick="changePublicMonth(-1)" style="padding: 0.4rem 0.75rem;">‚Äπ Prev</button>
        <span id="loginCalendarMonth" style="font-weight: 600;"></span>
        <button class="btn" onclick="changePublicMonth(1)" style="padding: 0.4rem 0.75rem;">Next ‚Ä∫</button>
      </div>
      <div class="calendar">
        <div class="calendar-grid" style="margin-bottom: 0.25rem;">
          <div style="font-weight: 600; text-align: center; color: #6b7280;">Sun</div>
          <div style="font-weight: 600; text-align: center; color: #6b7280;">Mon</div>
          <div style="font-weight: 600; text-align: center; color: #6b7280;">Tue</div>
          <div style="font-weight: 600; text-align: center; color: #6b7280;">Wed</div>
          <div style="font-weight: 600; text-align: center; color: #6b7280;">Thu</div>
          <div style="font-weight: 600; text-align: center; color: #6b7280;">Fri</div>
          <div style="font-weight: 600; text-align: center; color: #6b7280;">Sat</div>
        </div>
        <div class="calendar-grid" id="loginCalendarDays"></div>
      </div>
      <div style="margin-top: 0.75rem; display: flex; gap: 1.5rem; font-size: 0.75rem; color: #6b7280; justify-content: center;">
        <div><span style="display: inline-block; width: 14px; height: 14px; background: #d1fae5; border-radius: 3px; vertical-align: middle;"></span> Approved Leave</div>
        <div><span style="display: inline-block; width: 14px; height: 14px; background: #fee2e2; border-radius: 3px; vertical-align: middle;"></span> Public Holiday</div>
        <div><span style="display: inline-block; width: 14px; height: 14px; background: #fef3c7; border-radius: 3px; vertical-align: middle; border: 1px solid #f59e0b;"></span> HR Remark</div>
      </div>
    </div>
    <div class="credit-note credit-note-login">
      Engineering Team | Powered by OpenAI Codex
    </div>
  </div>
</div>

<!-- MAIN APPLICATION -->
<div id="appPage" style="display: none;">
  
<!-- Navigation Bar -->
<nav class="navbar">
  <div class="navbar-top">
    <div class="brand-wrap">
      <h2 style="color: #0F766E; font-size: 1.5rem; margin: 0;">Case Study LMS</h2>
    </div>
    <button id="navMenuToggle" type="button" class="btn nav-menu-toggle" onclick="toggleNavMenu()" aria-expanded="false" aria-controls="navTabsWrap">
      Menu
    </button>
    <div class="navbar-actions">
      <span id="userNameDisplay" style="font-weight: 500;"></span>
      <button id="changePasswordBtn" class="btn" onclick="openChangePasswordModal()" style="padding: 0.5rem 1rem; background: #e5e7eb; color: #374151;">Change Password</button>
      <button class="btn btn-danger" onclick="handleLogout()" style="padding: 0.5rem 1rem;">Logout</button>
    </div>
  </div>
  <div class="nav-tabs-wrap" id="navTabsWrap">
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showPage('dashboard')">Dashboard</button>
      <button class="nav-tab" onclick="showPage('submitLeave')">Submit Leave</button>
      <button class="nav-tab" onclick="showPage('myRequests')">My Requests</button>
      <button class="nav-tab" id="approvalsTab" onclick="showPage('approvals')" style="display: none;">Pending Approvals</button>
      <button class="nav-tab" id="adminPendingTab" onclick="showPage('adminPending')" style="display: none;">Pending Requests</button>
      <button class="nav-tab" id="employeeMgmtTab" onclick="showPage('employeeMgmt')" style="display: none;">Employee Management</button>
      <button class="nav-tab" id="holidayMgmtTab" onclick="showPage('holidayMgmt')" style="display: none;">Holiday Management</button>
      <button class="nav-tab" id="carryOverTab" onclick="showPage('carryOver')" style="display: none;">System Settings</button>
      <button class="nav-tab" id="smtpSettingsTab" onclick="showPage('smtpSettings')" style="display: none;">SMTP Settings</button>
      <button class="nav-tab" id="reportsTab" onclick="showPage('reports')" style="display: none;">Report Exports</button>
      <button class="nav-tab" id="auditLogsTab" onclick="showPage('auditLogs')" style="display: none;">Audit Logs</button>
    </div>
  </div>
</nav>

<!-- DASHBOARD PAGE -->
<div id="dashboardPage" class="page-content" style="padding: 2rem;">

<h2 style="margin-bottom: 1.5rem; color: #111827;">Dashboard</h2>

<!-- Leave Balance Stats -->
<div class="stat-grid" id="statsGrid">
  <!-- Will be populated by JavaScript -->
</div>

<!-- Calendar Widget - LARGER -->
<div style="margin-bottom: 2rem;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
	<h3 style="color: #374151;">Leave Calendar</h3>
	<div style="display: flex; gap: 0.5rem; align-items: center;">
	  <button class="btn" onclick="changeMonth(-1)" style="padding: 0.5rem 1rem;">‚Äπ Prev</button>
	  <span id="calendarMonth" style="padding: 0.5rem 1rem; font-weight: 500;"></span>
	  <button class="btn" onclick="changeMonth(1)" style="padding: 0.5rem 1rem;">Next ‚Ä∫</button>
	</div>
  </div>
  
  <div class="calendar">
	<div class="calendar-grid" style="margin-bottom: 0.5rem;">
	  <div style="font-weight: 600; text-align: center; color: #6b7280;">Sun</div>
	  <div style="font-weight: 600; text-align: center; color: #6b7280;">Mon</div>
	  <div style="font-weight: 600; text-align: center; color: #6b7280;">Tue</div>
	  <div style="font-weight: 600; text-align: center; color: #6b7280;">Wed</div>
	  <div style="font-weight: 600; text-align: center; color: #6b7280;">Thu</div>
	  <div style="font-weight: 600; text-align: center; color: #6b7280;">Fri</div>
	  <div style="font-weight: 600; text-align: center; color: #6b7280;">Sat</div>
	</div>
	<div class="calendar-grid" id="calendarDays">
	  <!-- Will be populated by JavaScript -->
	</div>
  </div>
  
  <div style="margin-top: 1rem; display: flex; gap: 2rem; font-size: 0.875rem;">
	<div><span style="display: inline-block; width: 20px; height: 20px; background: #d1fae5; border-radius: 4px; vertical-align: middle;"></span> Approved Leave</div>
	<div><span style="display: inline-block; width: 20px; height: 20px; background: #fee2e2; border-radius: 4px; vertical-align: middle;"></span> Public Holiday</div>
  <div><span style="display: inline-block; width: 20px; height: 20px; background: #fef3c7; border-radius: 4px; vertical-align: middle; border: 1px solid #f59e0b;"></span> HR Remark</div>
  </div>
</div>

<!-- Recent Requests -->
<div>
  <h3 style="margin-bottom: 1rem; color: #374151;">Recent Requests</h3>
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Employee</th>
          <th>Type</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Days</th>
          <th>Status</th>
          <th>Submitted</th>
        </tr>
      </thead>
      <tbody id="recentRequestsTable">
        <tr>
          <td colspan="7" style="text-align: center; color: #6b7280; padding: 2rem;">Loading...</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

</div>  <!-- ‚Üê THIS should close the Dashboard Page -->

<!-- SUBMIT LEAVE PAGE -->
<div id="submitLeavePage" class="page-content" style="display: none; padding: 2rem;">
  
  <div style="max-width: 1000px; margin: 0 auto;">
    <h2 style="margin-bottom: 1.5rem; color: #111827;">Submit Leave Request</h2>
    
    <!-- WARNING MESSAGE -->
    <div style="background: #EEF7FB; border-left: 4px solid #0F766E; padding: 1rem; margin-bottom: 1.5rem; border-radius: 0.5rem;">
      <div style="display: flex; gap: 0.75rem;">
        <div style="color: #0F766E; font-size: 1.25rem;">‚ö†Ô∏è</div>
        <div>
          <div style="font-weight: 600; color: #0F4C81; margin-bottom: 0.25rem;">Important: Consecutive Dates Only ÈáçË¶ÅÔºöÂÉÖÈôêÈÄ£Á∫åÊó•Êúü</div>
          <div style="font-size: 0.875rem; color: #6b7280;">
            Each leave request must use <strong>consecutive dates</strong> (continuous date range). This ensures accurate calculation of working days and leave balance. For non-consecutive dates, please submit separate leave requests.
          </div>
        </div>
      </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 350px; gap: 2rem;">
      
      <!-- LEFT: FORM -->
      <div style="background: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <form id="leaveRequestForm">
          
          <!-- Leave Type -->
          <div class="form-group">
            <label class="form-label" for="leaveType">Leave Type</label>
            <select id="leaveType" class="form-select" required>
              <option value="">Select leave type</option>
              <option value="AL">Annual Leave (AL) ÊúâËñ™Âπ¥ÂÅá</option>
              <option value="BL">Birthday Leave (BL) ÁîüÊó•ÂÅá</option>
              <option value="CL">Casual Leave (CL) ‰∫ãÂÅá</option>
              <option value="CPL">Compensation Leave (CPL) Ë£úÂÅá</option>
              <option value="DC">Doctor Consultation ÈÜ´Ë®∫</option>
              <option value="ML">Maternity Leave (ML) Áî¢ÂÅá</option>
              <option value="PL">Paternity Leave (PL) ‰æçÁî¢ÂÅá</option>
              <option value="SL">Sick Leave (SL) ÁóÖÂÅá</option>
              <option value="OTHER">Others ÂÖ∂‰ªñ</option>
            </select>
          </div>
          
          <!-- Start Date & Duration -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
              <label class="form-label" for="startDate">Start Date</label>
              <input type="date" id="startDate" class="form-input" required onchange="calculateDays(); updateMiniCalendar();">
            </div>
            
            <div class="form-group">
              <label class="form-label">Start Duration</label>
              <div class="duration-group">
                <button type="button" class="duration-btn active" onclick="setDuration('start', 'FULL')">Full Day</button>
                <button type="button" class="duration-btn" onclick="setDuration('start', 'AM')">AM</button>
                <button type="button" class="duration-btn" onclick="setDuration('start', 'PM')">PM</button>
              </div>
              <input type="hidden" id="startDurationType" value="FULL">
            </div>
          </div>
          
          <!-- End Date & Duration -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
              <label class="form-label" for="endDate">End Date</label>
              <input type="date" id="endDate" class="form-input" required onchange="calculateDays(); updateMiniCalendar();">
            </div>
            
            <div class="form-group">
              <label class="form-label">End Duration</label>
              <div class="duration-group">
                <button type="button" class="duration-btn active" onclick="setDuration('end', 'FULL')">Full Day</button>
                <button type="button" class="duration-btn" onclick="setDuration('end', 'AM')">AM</button>
                <button type="button" class="duration-btn" onclick="setDuration('end', 'PM')">PM</button>
              </div>
              <input type="hidden" id="endDurationType" value="FULL">
            </div>
          </div>
          
          <!-- Days Preview -->
          <div style="background: #EEF7FB; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border: 1px solid #BFDBFE;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <span style="color: #6b7280; font-size: 0.875rem;">Total Working Days</span>
                <span id="daysPreview" style="font-size: 1.5rem; font-weight: 700; color: #0F766E; margin-left: 0.5rem;">0</span>
              </div>
              <div>
                <span style="color: #6b7280; font-size: 0.875rem;">Remaining Balance</span>
                <span id="balancePreview" style="font-size: 1.25rem; font-weight: 600; color: #059669; margin-left: 0.5rem;">-</span>
              </div>
            </div>
          </div>
          
          <!-- Remarks -->
          <div class="form-group">
            <label class="form-label" for="remarks">Remarks (Optional)</label>
            <textarea id="remarks" class="form-input" rows="3" placeholder="Reason for leave or additional notes..."></textarea>
          </div>
          
          <!-- File Upload -->
          <div class="form-group">
            <label class="form-label">Upload Attachment (Optional)</label>
            <div class="file-upload-area">
              <input type="file" id="documentUpload" multiple accept=".pdf,.jpg,.jpeg,.png" style="display: none;" onchange="handleFileSelect(event)">
              <label for="documentUpload" style="cursor: pointer;">
                <div style="color: #6b7280;">
                  <p style="font-weight: 500; margin-bottom: 0.25rem;">üìé Click to upload documents</p>
                  <p style="font-size: 0.875rem;">PDF, JPG, PNG | Max 10 files, 5MB each</p>
                </div>
              </label>
            </div>
            <div id="fileList" class="file-list"></div>
          </div>
          
          <!-- Submit Button -->
          <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button id="leaveResetBtn" type="button" class="btn" onclick="resetLeaveForm()" style="background: #e5e7eb; color: #374151;">
              Reset
            </button>
            <button id="leaveSubmitBtn" type="submit" class="btn btn-primary">
              Submit Request
            </button>
          </div>
          
        </form>
      </div>
      
      <!-- RIGHT: MINI CALENDAR VISUALIZER -->
      <div style="background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); height: fit-content; position: sticky; top: 2rem;">
        <h4 style="margin-bottom: 1rem; color: #374151; font-size: 1rem;">Date Range Preview</h4>
        
        <div id="miniCalendarContainer">
          <div style="text-align: center; color: #6b7280; padding: 2rem; font-size: 0.875rem;">
            Select start and end dates to preview your leave period
          </div>
        </div>
        
        <!-- Legend -->
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
          <div style="font-size: 0.75rem; font-weight: 600; color: #6b7280; margin-bottom: 0.5rem;">Legend</div>
          <div style="display: grid; gap: 0.5rem; font-size: 0.75rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="display: inline-block; width: 16px; height: 16px; background: #0F766E; border-radius: 3px;"></span>
              <span>Full Working Day</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="display: inline-block; width: 16px; height: 16px; background: #BFDBFE; border-radius: 3px;"></span>
              <span>Partial Day (AM/PM)</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="display: inline-block; width: 16px; height: 16px; background: #fee2e2; border-radius: 3px;"></span>
              <span>Weekend/Holiday</span>
            </div>
          </div>
        </div>
      </div>
      
    </div>
  </div>
</div>

<!-- MY REQUESTS PAGE -->
<div id="myRequestsPage" class="page-content" style="display: none; padding: 2rem;">

<h2 style="margin-bottom: 1.5rem; color: #111827;">My Leave Requests</h2>

<!-- Tabs -->
<div style="margin-bottom: 1.5rem; border-bottom: 2px solid #e5e7eb;">
  <div style="display: flex; gap: 1rem;">
	<button class="tab-btn active" onclick="switchRequestTab('all')" data-tab="all">
	  All Requests
	</button>
	<button class="tab-btn" onclick="switchRequestTab('pending')" data-tab="pending">
	  Pending
	</button>
	<button class="tab-btn" onclick="switchRequestTab('approved')" data-tab="approved">
	  Approved
	</button>
	<button class="tab-btn" onclick="switchRequestTab('rejected')" data-tab="rejected">
	  Rejected
	</button>
  </div>
</div>

<!-- All Requests Tab -->
<div id="allRequestsTab" class="tab-content">
  <div class="table-container">
	<table>
	  <thead>
		<tr>
		  <th>Request ID</th>
		  <th>Type</th>
		  <th>Start Date</th>
		  <th>End Date</th>
		  <th>Days</th>
		  <th>Status</th>
		  <th>Submitted</th>
		  <th>Action</th>
		</tr>
	  </thead>
	  <tbody id="allRequestsTable">
		<tr>
		  <td colspan="8" style="text-align: center; color: #6b7280; padding: 2rem;">
			Loading...
		  </td>
		</tr>
	  </tbody>
	</table>
  </div>
</div>

<!-- Pending Tab -->
<div id="pendingRequestsTab" class="tab-content" style="display: none;">
  <div class="table-container">
	<table>
	  <thead>
		<tr>
		  <th>Request ID</th>
		  <th>Type</th>
		  <th>Start Date</th>
		  <th>End Date</th>
		  <th>Days</th>
		  <th>Submitted</th>
		  <th>Action</th>
		</tr>
	  </thead>
	  <tbody id="pendingRequestsTable">
		<tr>
		  <td colspan="7" style="text-align: center; color: #6b7280; padding: 2rem;">
			Loading...
		  </td>
		</tr>
	  </tbody>
	</table>
  </div>
</div>

<!-- Approved Tab -->
<div id="approvedRequestsTab" class="tab-content" style="display: none;">
  <div class="table-container">
	<table>
	  <thead>
		<tr>
		  <th>Request ID</th>
		  <th>Type</th>
		  <th>Start Date</th>
		  <th>End Date</th>
		  <th>Days</th>
		  <th>Approved By</th>
		  <th>Approved Date</th>
		  <th>Action</th>
		</tr>
	  </thead>
	  <tbody id="approvedRequestsTable">
		<tr>
		  <td colspan="8" style="text-align: center; color: #6b7280; padding: 2rem;">
			Loading...
		  </td>
		</tr>
	  </tbody>
	</table>
  </div>
</div>

<!-- Rejected Tab -->
<div id="rejectedRequestsTab" class="tab-content" style="display: none;">
  <div class="table-container">
	<table>
	  <thead>
		<tr>
		  <th>Request ID</th>
		  <th>Type</th>
		  <th>Start Date</th>
		  <th>End Date</th>
		  <th>Days</th>
		  <th>Rejected By</th>
		  <th>Reason</th>
		  <th>Action</th>
		</tr>
	  </thead>
	  <tbody id="rejectedRequestsTable">
		<tr>
		  <td colspan="8" style="text-align: center; color: #6b7280; padding: 2rem;">
			Loading...
		  </td>
		</tr>
	  </tbody>
	</table>
  </div>
</div>
</div>

<!-- PENDING APPROVALS PAGE (For Approvers/Admin) -->
<div id="approvalsPage" class="page-content" style="display: none; padding: 2rem;">
  
  <h2 id="approvalsTitle" style="margin-bottom: 1.5rem; color: #111827;">Pending Approvals</h2>

  <div id="approvalsAdminControls" style="display: none; margin-bottom: 1rem; align-items: center; gap: 0.75rem;">
    <label for="approvalsHistoryMonth" style="font-weight: 600; color: #374151;">Month</label>
    <input type="month" id="approvalsHistoryMonth" class="form-input" style="max-width: 220px;">
    <button class="btn btn-primary" type="button" onclick="loadPendingApprovals()" style="padding: 0.5rem 1rem;">Load</button>
  </div>

  <div id="approvalsSummary" style="display: none; margin-bottom: 1rem;"></div>
  
  <div class="table-container">
    <table>
      <thead id="pendingApprovalsHeader">
        <tr>
          <th>Request ID</th>
          <th>Employee</th>
          <th>Type</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Days</th>
          <th>Submitted</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="pendingApprovalsTable">
        <tr>
          <td colspan="8" style="text-align: center; color: #6b7280; padding: 2rem;">
            Loading...
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  
</div>

<!-- ADMIN PENDING REQUESTS PAGE (Admin/Superadmin) -->
<div id="adminPendingPage" class="page-content" style="display: none; padding: 2rem;">
  <h2 style="margin-bottom: 1.5rem; color: #111827;">Pending Requests</h2>
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Request ID</th>
          <th>Employee</th>
          <th>Type</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Days</th>
          <th>Submitted</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="adminPendingTable">
        <tr>
          <td colspan="8" style="text-align: center; color: #6b7280; padding: 2rem;">
            Loading...
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- EMPLOYEE MANAGEMENT PAGE (Admin Only) -->
<div id="employeeMgmtPage" class="page-content" style="display: none; padding: 2rem;">
  
  <h2 style="margin-bottom: 1.5rem; color: #111827;">Employee Management</h2>
    
  <!-- Add New Employee Button -->
  <div style="margin-bottom: 1.5rem; display: flex; gap: 0.75rem; flex-wrap: wrap;">
    <button class="btn btn-primary" onclick="openAddEmployeeModal()">
      ‚ûï Add New Employee
    </button>
    <button type="button" class="btn" onclick="exportAllStaffInfoCsv()" style="background: #e5e7eb; color: #374151;">
      Export Staff Directory
    </button>
  </div>

  <!-- CSV Import Section -->
  <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1.25rem;">
    <div style="display: flex; justify-content: space-between; gap: 1rem; flex-wrap: wrap; align-items: center;">
      <div>
        <h3 style="margin: 0 0 0.25rem 0; color: #374151; font-size: 1rem;">CSV Batch Import</h3>
        <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Batch add or edit employee records via CSV.</p>
      </div>
      <button type="button" class="btn" onclick="downloadEmployeeImportTemplate()" style="background: #e5e7eb; color: #374151;">
        Download CSV Template
      </button>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.75rem; margin-top: 0.9rem;">
      <select id="employeeImportMode" class="form-select">
        <option value="add">Batch Add</option>
        <option value="edit">Batch Edit</option>
      </select>
      <input id="employeeImportFile" type="file" class="form-input" accept=".csv,text/csv">
      <button id="employeeImportBtn" type="button" class="btn btn-primary" onclick="importEmployeesFromCsv()">Import CSV</button>
    </div>

    <div id="employeeImportStatus" style="display: none; margin-top: 0.75rem; padding: 0.75rem 1rem; border-radius: 0.5rem; font-size: 0.875rem;"></div>
  </div>

  <div style="margin-bottom: 1rem; max-width: 420px;">
    <input
      type="text"
      id="employeeSearchInput"
      class="form-input"
      placeholder="Search by employee name..."
      oninput="filterEmployeeManagementTable()"
    >
  </div>
  
	<!-- Employee List Table -->
	<div class="table-container" style="overflow-x: auto;">
	  <table style="min-width: 1400px;">
		<thead>
		  <tr>
			<th>Staff Code</th>
			<th>Name</th>
			<th>Department</th>
			<th>Role</th>
			<th>Type</th>
			<th>AL Base</th>
			<th>AL</th>
			<th>AL Carry</th>
			<th>SL</th>
			<th>Status</th>
			<th>Action</th>
		  </tr>
		</thead>
		<tbody id="employeeListTable">
		  <tr>
			<td colspan="11" style="text-align: center; color: #6b7280; padding: 2rem;">
			  Loading...
			</td>
		  </tr>
		</tbody>
	  </table>
	</div>


</div>

<!-- HOLIDAY MANAGEMENT PAGE (Admin Only) -->
<div id="holidayMgmtPage" class="page-content" style="display: none; padding: 2rem;">
  <h2 style="margin-bottom: 1.5rem; color: #111827;">Holiday Management</h2>

  <div style="background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1rem; margin-bottom: 1rem;">
    <h3 style="margin: 0 0 0.75rem 0; color: #374151; font-size: 1rem;">Add Holiday</h3>
    <div class="holiday-form-row" style="display: grid; grid-template-columns: 220px 1fr auto; gap: 0.75rem;">
      <input id="holidayDateInput" type="date" class="form-input">
      <input id="holidayNameInput" type="text" class="form-input" placeholder="Holiday name">
      <button class="btn btn-primary" type="button" onclick="addHoliday()">Add Holiday</button>
    </div>
    <p style="margin: 0.6rem 0 0 0; font-size: 0.82rem; color: #6b7280;">
      You can add upcoming public holidays manually (e.g., year 2027).
    </p>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Holiday Name</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="holidayListTable">
        <tr>
          <td colspan="3" style="text-align: center; color: #6b7280; padding: 2rem;">Loading...</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- SYSTEM SETTINGS PAGE (Admin Only) -->
<div id="carryOverPage" class="page-content" style="display: none; padding: 2rem;">
  <div style="max-width: 1200px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
      <h2 style="margin: 0; color: #111827;">‚öôÔ∏è System Settings</h2>
      <div style="display: flex; gap: 0.5rem;">
        <button class="btn" onclick="loadCarryOverSettings()" style="background: #6b7280; color: white; padding: 0.5rem 1rem;">
          Refresh
        </button>
        <button class="btn btn-primary" onclick="saveCarryOverSettings()" style="padding: 0.5rem 1rem;">
          Save Settings
        </button>
      </div>
    </div>
    <p style="margin: 0 0 1.5rem 0; color: #6b7280; font-size: 0.9rem;">
      Configure carry over policy, Jan-1 resets, and approval cancellation controls.
    </p>

    <div style="background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1.25rem;">
      <h3 style="color: #374151; margin: 0 0 1rem 0;">Carry Over & Approval Controls</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem 1.5rem;">
        <div class="form-group">
          <label class="form-label">Enable AL Carry Over</label>
          <select id="carryOverEnabled" class="form-select">
            <option value="true">Enabled</option>
            <option value="false">Disabled</option>
          </select>
          <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">Turn on/off annual leave carry over globally.</p>
        </div>

        <div class="form-group">
          <label class="form-label">Max Transfer Days (Last Year's AL)</label>
          <input type="number" id="carryOverMaxDays" class="form-input" min="0" max="99" step="1" value="99">
          <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">Set <strong style="color: #059669;">99</strong> for unlimited transfer from last year.</p>
        </div>

        <div class="form-group">
          <label class="form-label">Approved Leave Cancellation Window (Days)</label>
          <input type="number" id="approvedLeaveDeleteWindowDays" class="form-input" min="0" max="365" step="1" value="14">
          <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">Admin can cancel approved leave only within this many days after approval. Set <strong>0</strong> for no limit.</p>
        </div>

        <div class="form-group">
          <label class="form-label">Expiration Deadline Month</label>
          <select id="carryOverDeadlineMonth" class="form-select">
            <option value="1">January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10" selected>October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Expiration Deadline Day</label>
          <input type="number" id="carryOverDeadlineDay" class="form-input" min="1" max="31" step="1" value="31">
          <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">Last day to use carry over balance.</p>
        </div>

        <div class="form-group">
          <label class="form-label">Hard Forfeit After Deadline</label>
          <select id="carryOverForfeitEnabled" class="form-select">
            <option value="false">Disabled (Recommended)</option>
            <option value="true">Enabled</option>
          </select>
          <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">When disabled, carry over remains usable after deadline.</p>
        </div>
      </div>
    </div>

    <div style="background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1.25rem;">
      <h3 style="color: #374151; margin: 0 0 1rem 0;">Jan-1 Reset by Leave Type</h3>
      <p style="font-size: 0.8rem; color: #6b7280; margin: 0 0 0.75rem 0;">Tick each leave type that should reset automatically every January 1.</p>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.6rem;">
        <label style="display: flex; align-items: center; gap: 0.5rem; color: #374151;">
          <input type="checkbox" id="jan1ResetBlEnabled">
          <span>BL reset to 1</span>
        </label>
        <label style="display: flex; align-items: center; gap: 0.5rem; color: #374151;">
          <input type="checkbox" id="jan1ResetClEnabled">
          <span>CL reset to 0</span>
        </label>
        <label style="display: flex; align-items: center; gap: 0.5rem; color: #374151;">
          <input type="checkbox" id="jan1ResetCplEnabled">
          <span>CPL reset to 0</span>
        </label>
        <label style="display: flex; align-items: center; gap: 0.5rem; color: #374151;">
          <input type="checkbox" id="jan1ResetDcEnabled">
          <span>DC reset to 0</span>
        </label>
        <label style="display: flex; align-items: center; gap: 0.5rem; color: #374151;">
          <input type="checkbox" id="jan1ResetMlEnabled">
          <span>ML reset to 0</span>
        </label>
        <label style="display: flex; align-items: center; gap: 0.5rem; color: #374151;">
          <input type="checkbox" id="jan1ResetPlEnabled">
          <span>PL reset to 0</span>
        </label>
        <label style="display: flex; align-items: center; gap: 0.5rem; color: #374151;">
          <input type="checkbox" id="jan1ResetSlEnabled">
          <span>SL reset to 0</span>
        </label>
      </div>
    </div>

    <div style="background: #DBEAFE; border: 2px solid #0E7490; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.25rem;">
      <h3 style="color: #0F4C81; margin: 0 0 0.75rem 0;">Manual Rollover Control</h3>
      <p style="color: #1E3A8A; margin-bottom: 1rem;">
        Use this only for maintenance or testing. It manually triggers year-end AL carry over for all active employees.
      </p>
      <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
        <button class="btn" onclick="triggerManualRollover()" style="background: #0E7490; color: white; padding: 0.75rem 1.5rem; font-weight: 600;">
          Trigger Year-End Rollover Now
        </button>
        <span style="color: #6b7280; font-size: 0.875rem;">This transfers unused AL into carry over balances.</span>
      </div>
    </div>

    <div style="background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 0.75rem; padding: 1.25rem; margin-bottom: 1.25rem;">
      <h3 style="color: #1e40af; margin: 0 0 0.75rem 0;">Carry Over Policy Guide</h3>
      <ul style="margin: 0; padding-left: 1.25rem; color: #4b5563; line-height: 1.7;">
        <li>On January 1, unused annual leave can transfer to carry over based on max transfer settings.</li>
        <li>Carry over is deducted first when annual leave is approved.</li>
        <li>Deadline month/day controls when carry over expires if hard forfeit is enabled.</li>
        <li>Current year annual leave and carry over are tracked separately.</li>
      </ul>
    </div>

    <div style="background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem;">
      <h3 style="color: #374151; margin: 0 0 1rem 0;">Recent Rollover History</h3>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Action</th>
              <th>Details</th>
              <th>Triggered By</th>
            </tr>
          </thead>
          <tbody id="rolloverHistoryTable">
            <tr>
              <td colspan="4" style="text-align: center; color: #6b7280; padding: 2rem;">
                Loading rollover history...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- AUDIT LOGS PAGE (Admin Only) -->
<div id="auditLogsPage" class="page-content" style="display: none; padding: 2rem;">
  
  <h2 style="margin-bottom: 1.5rem; color: #111827;">üîç Audit Trail Logs</h2>
  
  <!-- Info Box -->
  <div style="background: #EEF7FB; border-left: 4px solid #0F766E; padding: 1rem; margin-bottom: 1.5rem; border-radius: 0.5rem;">
    <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">
      <strong>System Audit Trail:</strong> All administrative actions are logged with timestamp, user, IP address, and details for security and compliance.
    </p>
    <p style="margin: 0.5rem 0 0 0; font-size: 0.82rem; color: #6b7280;">
      <strong>Retention:</strong> Leave attachments follow a 7-year retention policy. Automated purge activity is recorded under action code <code>ATTACHMENT_PURGE_7Y</code>.
    </p>
  </div>
  
  <!-- Filters -->
  <div style="background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1.5rem;">
    <h3 style="margin: 0 0 1rem 0; color: #374151; font-size: 1rem;">Filters</h3>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; align-items: end;">
      <div class="form-group" style="margin-bottom: 0;">
        <label class="form-label">Action Type</label>
        <select id="filterAction" class="form-select" onchange="loadAuditLogs()">
          <option value="">All Actions</option>
          <option value="Login">Login</option>
          <option value="EDIT_EMPLOYEE">Edit Employee</option>
          <option value="ADD_EMPLOYEE">Add Employee</option>
          <option value="Toggle inactive">Toggle Status</option>
          <option value="Submit leave">Submit Leave</option>
          <option value="APPROVE">Approve Request</option>
          <option value="REJECT">Reject Request</option>
          <option value="DELETE">Delete Request</option>
        </select>
      </div>
      
      <div class="form-group" style="margin-bottom: 0;">
        <label class="form-label">User Email</label>
        <input type="text" id="filterUserEmail" class="form-input" placeholder="user@example.com" onchange="loadAuditLogs()">
      </div>
      
      <div class="form-group" style="margin-bottom: 0;">
        <label class="form-label">Start Date</label>
        <input type="date" id="filterStartDate" class="form-input" onchange="loadAuditLogs()">
      </div>
      
      <div class="form-group" style="margin-bottom: 0;">
        <label class="form-label">End Date</label>
        <input type="date" id="filterEndDate" class="form-input" onchange="loadAuditLogs()">
      </div>
      <div class="form-group" style="margin-bottom: 0;">
        <label class="form-label">&nbsp;</label>
        <button class="btn" onclick="resetAuditFilters()" style="background: #e5e7eb; color: #374151; width: 100%;">Clear Filters</button>
      </div>
    </div>
  </div>
  
  <!-- Audit Logs Table -->
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Timestamp</th>
          <th>User</th>
          <th>Action</th>
          <th>Details</th>
          <th>IP Address</th>
          <th>User Agent</th>
        </tr>
      </thead>
      <tbody id="auditLogsTable">
        <tr>
          <td colspan="7" style="text-align: center; color: #6b7280; padding: 2rem;">
            Loading audit logs...
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <!-- Pagination -->
  <div id="auditPagination" style="margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
    <div id="auditPaginationInfo" style="color: #6b7280; font-size: 0.875rem;"></div>
    <div style="display: flex; gap: 0.5rem;">
      <button id="auditPrevBtn" class="btn" onclick="loadAuditLogsPage('prev')" style="padding: 0.5rem 1rem; background: #e5e7eb; color: #374151;" disabled>Previous</button>
      <button id="auditNextBtn" class="btn" onclick="loadAuditLogsPage('next')" style="padding: 0.5rem 1rem; background: #e5e7eb; color: #374151;" disabled>Next</button>
    </div>
  </div>

</div>

<!-- SMTP SETTINGS PAGE (Admin Only) -->
<div id="smtpSettingsPage" class="page-content" style="display: none; padding: 2rem;">
  <div style="max-width: 960px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h2 style="margin: 0; color: #111827;">SMTP Settings</h2>
      <div id="smtpActionButtons" style="display: flex; gap: 0.5rem;">
        <button class="btn" onclick="loadSMTPConfig()" style="background: #6b7280; color: white;">Refresh</button>
        <button id="smtpTestBtn" class="btn" onclick="testSMTPSettings()" style="background: #0ea5e9; color: white;">Test SMTP</button>
        <button id="smtpSaveBtn" class="btn btn-primary" onclick="saveSMTPSettings()">Save SMTP</button>
      </div>
    </div>

    <div id="smtpReadOnlyNotice" style="display: none; background: #EFF6FF; border-left: 4px solid #0F766E; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
      <p style="margin: 0; color: #0F4C81; font-size: 0.9rem;">
        SMTP settings are visible only. Only superadmin can change them. Please contact IT (`it@example.com`) for updates.
      </p>
    </div>

    <div id="smtpSettingsContent">
    <div style="background: #f0f9ff; border-left: 4px solid #3b82f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
      <p style="margin: 0; color: #1e3a8a; font-size: 0.9rem;">
        Configure one mailbox for notifications. Leave submission and approval/rejection emails use this configuration.
      </p>
    </div>

    <div style="background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem;">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
        <div class="form-group">
          <label class="form-label">SMTP Host</label>
          <input id="smtpHost" class="form-input" placeholder="smtp.office365.com">
        </div>
        <div class="form-group">
          <label class="form-label">SMTP Port</label>
          <select id="smtpPort" class="form-select">
            <option value="587">587 (STARTTLS)</option>
            <option value="465">465 (SSL/TLS)</option>
            <option value="25">25 (Relay)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">SMTP Enabled</label>
          <select id="smtpEnabled" class="form-select">
            <option value="true">Enabled</option>
            <option value="false">Disabled</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Use Auth</label>
          <select id="smtpUseAuth" class="form-select" onchange="toggleSMTPAuthFields()">
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Username</label>
          <input id="smtpUsername" class="form-input" placeholder="mailbox@example.com">
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input id="smtpPassword" class="form-input" type="password" placeholder="App password">
        </div>
        <div class="form-group">
          <label class="form-label">From Email</label>
          <input id="smtpFromEmail" class="form-input" type="email" placeholder="leave@example.com">
        </div>
      </div>
    </div>
    </div>
  </div>
</div>

<!-- REPORT EXPORTS PAGE (Admin Only) -->
<div id="reportsPage" class="page-content" style="display: none; padding: 2rem;">
  <div style="max-width: 960px; margin: 0 auto;">
    <h2 style="margin-bottom: 1.5rem; color: #111827;">Report Exports</h2>

    <div style="background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem;">
      <h3 style="margin: 0 0 0.75rem 0; color: #374151;">HR Reports</h3>
      <p style="color: #6b7280; margin-bottom: 1rem;">Daily operations and payroll checking.</p>
      <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
        <button class="btn btn-primary" onclick="exportReport('leave-balance')">Export Leave Balance CSV</button>
        <button class="btn btn-primary" onclick="exportReport('leave-history')">Export Leave History CSV</button>
      </div>

      <hr style="border: 0; border-top: 1px solid #e5e7eb; margin: 1.25rem 0;">

      <h3 style="margin: 0 0 0.75rem 0; color: #374151;">Audit Reports</h3>
      <p style="color: #6b7280; margin-bottom: 1rem;">Security and traceability review.</p>
      <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
        <button class="btn btn-primary" onclick="exportReport('audit-logs')">Export Audit Logs CSV</button>
        <button class="btn btn-primary" onclick="exportReport('pending-aging')">Export Pending Aging CSV</button>
      </div>

      <hr style="border: 0; border-top: 1px solid #e5e7eb; margin: 1.25rem 0;">

      <h3 style="margin: 0 0 0.75rem 0; color: #374151;">Management Reports</h3>
      <p style="color: #6b7280; margin-bottom: 1rem;">YTD utilization snapshot for managements review.</p>
      <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
        <button class="btn btn-primary" onclick="exportReport('leave-usage-summary')">Export Leave Usage Summary CSV</button>
      </div>
      <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: end; margin-top: 0.75rem;">
        <div style="min-width: 220px;">
          <label class="form-label" for="monthlyApprovedReportMonth">Month</label>
          <input id="monthlyApprovedReportMonth" type="month" class="form-input">
        </div>
        <button class="btn btn-primary" onclick="exportMonthlyIndividualApprovedLeaveReport()">
          Export Monthly Individual Approved Leave CSV
        </button>
      </div>
    </div>
  </div>
</div>

<!-- CHANGE PASSWORD MODAL -->
<div id="changePasswordModal" class="modal">
  <div class="modal-content" style="max-width: 520px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem;">
      <h3 style="color: #111827;">Change Password</h3>
      <button onclick="closeModal('changePasswordModal')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">√ó</button>
    </div>

    <form id="changePasswordForm">
      <div class="form-group">
        <label class="form-label">Current Password</label>
        <input type="password" id="currentPasswordInput" class="form-input" required>
      </div>
      <div class="form-group">
        <label class="form-label">New Password</label>
        <input type="password" id="newPasswordInput" class="form-input" minlength="6" required>
      </div>
      <div class="form-group">
        <label class="form-label">Confirm New Password</label>
        <input type="password" id="confirmNewPasswordInput" class="form-input" minlength="6" required>
      </div>
      <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
        <button type="button" class="btn" onclick="closeModal('changePasswordModal')" style="background: #e5e7eb; color: #374151;">Cancel</button>
        <button type="submit" class="btn btn-primary">Update Password</button>
      </div>
    </form>
  </div>
</div>

<!-- REQUEST DETAILS MODAL -->
<div id="requestDetailsModal" class="modal">
  <div class="modal-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h3 style="color: #111827;">Request Details</h3>
      <button onclick="closeModal('requestDetailsModal')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">√ó</button>
    </div>
    
    <div id="requestDetailsContent">
      <!-- Will be populated by JavaScript -->
    </div>
    
    <div style="margin-top: 1.5rem; text-align: right;">
      <button class="btn" onclick="closeModal('requestDetailsModal')" style="background: #e5e7eb; color: #374151;">
        Close
      </button>
    </div>
  </div>
</div>

<!-- ADD EMPLOYEE MODAL -->
<div id="addEmployeeModal" class="modal">
  <div class="modal-content">
	<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
	  <h3 style="color: #111827;">Add New Employee</h3>
	  <button onclick="closeModal('addEmployeeModal')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">√ó</button>
	</div>
	
	<form id="addEmployeeForm">
	  <div class="form-group">
		<label class="form-label">Email *</label>
		<input type="email" id="newEmployeeEmail" class="form-input" required placeholder="john@example.com">
	  </div>
	  
	  <div class="form-group">
		<label class="form-label">Full Name *</label>
		<input type="text" id="newEmployeeName" class="form-input" required placeholder="John Smith">
	  </div>
	  
	  <div class="form-group">
		<label class="form-label">Staff Code *</label>
		<input type="text" id="newEmployeeStaffCode" class="form-input" required placeholder="EMP003 or RT002">
	  </div>
	  
	  <div class="form-group">
		<label class="form-label">Role</label>
		<select id="newEmployeeRole" class="form-select">
		  <option value="employee">Employee</option>
		  <option value="approver">Approver/Manager</option>
		</select>
	  </div>
	  
		  <div class="form-group">
			<label class="form-label">Department</label>
			<input type="text" id="newEmployeeDepartment" class="form-input" placeholder="Sales, HR, Retail, etc.">
		  </div>
		  
		  <div class="form-group">
			<label class="form-label">Location</label>
			<input type="text" id="newEmployeeLocation" class="form-input" placeholder="HQ or Store name">
		  </div>

		  <div class="form-group">
			<label class="form-label">Employee Type</label>
			<select id="newEmployeeType" class="form-select">
			  <option value="true">Office Staff (Weekends OFF)</option>
			  <option value="false">Retail Staff (Works Weekends)</option>
			</select>
			<p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">Determines if weekends count as working days</p>
		  </div>
		  
		  <div class="form-group">
			<label class="form-label">Manager Email (Optional)</label>
			<input type="email" id="newEmployeeManager" class="form-input" placeholder="manager@example.com">
		  </div>

		  <div class="form-group">
			<label class="form-label">Join Date *</label>
			<input type="date" id="newEmployeeHireDate" class="form-input" required>
		  </div>

		  <div class="form-group">
			<label class="form-label">Annual Leave Base (Days per year)</label>
			<input type="number" id="newEmployeeAnnualLeaveBase" class="form-input" min="0" max="30" step="1" value="12">
		  </div>
	  
	  <div style="background: #EEF7FB; border-left: 4px solid #0F766E; padding: 1rem; margin-bottom: 1rem; border-radius: 0.5rem;">
		<p style="font-size: 0.875rem; color: #6b7280; margin: 0;">
		  ‚ÑπÔ∏è Default password will be set to <strong>Staff Code + "lms"</strong>. Employee can change it after first login (retail staff excluded).
		</p>
	  </div>
	  
	  <div style="display: flex; gap: 1rem; justify-content: flex-end;">
		<button type="button" class="btn" onclick="closeModal('addEmployeeModal')" style="background: #e5e7eb; color: #374151;">
		  Cancel
		</button>
		<button type="submit" class="btn btn-primary">
		  Add Employee
		</button>
	  </div>
	</form>
  </div>
</div>

<!-- EDIT EMPLOYEE MODAL -->
<div id="editEmployeeModal" class="modal">
  <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h3 style="color: #111827;">Edit Employee</h3>
      <button onclick="closeModal('editEmployeeModal')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">√ó</button>
    </div>
    
    <form id="editEmployeeForm">
      <input type="hidden" id="editEmployeeEmail">
      <input type="hidden" id="editOriginalHireDate">
      <input type="hidden" id="editOriginalAnnualLeaveBase">
      
      <!-- Basic Information -->
      <div style="background: #f9fafb; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
        <h4 style="margin: 0 0 1rem 0; color: #374151;">Basic Information</h4>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label class="form-label">Email (Cannot be changed)</label>
            <input type="email" id="editEmployeeEmailDisplay" class="form-input" disabled>
          </div>
          
          <div class="form-group">
            <label class="form-label">Full Name *</label>
            <input type="text" id="editEmployeeName" class="form-input" required>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label class="form-label">Staff Code</label>
            <input type="text" id="editEmployeeStaffCode" class="form-input">
          </div>
          
          <div class="form-group">
            <label class="form-label">Role</label>
            <select id="editEmployeeRole" class="form-select">
              <option value="employee">Employee</option>
              <option value="approver">Approver/Manager</option>
            </select>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label class="form-label">Department</label>
            <input type="text" id="editEmployeeDepartment" class="form-input">
          </div>
          
          <div class="form-group">
            <label class="form-label">Location</label>
            <input type="text" id="editEmployeeLocation" class="form-input">
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Manager Email (Approver)</label>
          <input type="email" id="editEmployeeManager" class="form-input" placeholder="manager@example.com">
        </div>
      </div>
      
		  <div class="form-group">
	  <label class="form-label">Employee Type</label>
	  <select id="editEmployeeType" class="form-select">
		<option value="true">Office Staff (Weekends OFF)</option>
		<option value="false">Retail Staff (Works Weekends)</option>
	  </select>
	  <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">Determines if weekends count as working days</p>
	</div>

	  
      <!-- Annual Leave Configuration -->
      <div style="background: #EEF7FB; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid #0F766E;">
        <h4 style="margin: 0 0 1rem 0; color: #0F4C81;">üìÖ Annual Leave Configuration</h4>

        <div class="form-group">
          <label class="form-label">Join Date</label>
          <input type="date" id="editEmployeeHireDate" class="form-input">
          <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">AL is auto-calculated from this date</p>
        </div>
        
        <div class="form-group">
          <label class="form-label">Annual Leave Base (Days per year)</label>
          <input type="number" id="editAnnualLeaveBase" class="form-input" min="0" max="30" step="1" value="13">
          <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">Default entitlement per year</p>
        </div>
        <p id="editProRatedPreview" style="font-size: 0.8rem; color: #0F4C81; margin-top: 0.5rem;"></p>
      </div>
      
		  <div class="form-group">
	  <label class="form-label">Carry Over Reset Month</label>
	  <select id="editCarryOverResetMonth" class="form-select">
		<option value="1">January</option>
		<option value="2">February</option>
		<option value="3">March</option>
		<option value="4">April</option>
		<option value="5">May</option>
		<option value="6">June</option>
		<option value="7">July</option>
		<option value="8">August</option>
		<option value="9">September</option>
		<option value="10">October (Default)</option>
		<option value="11">November</option>
		<option value="12">December</option>
	  </select>
	  <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">Last month to use previous year's carry over AL</p>
	</div>

	  
      <!-- Leave Balance Adjustments -->
      <div style="background: #f0fdf4; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid #10b981;">
        <h4 style="margin: 0 0 0.5rem 0; color: #065f46;">üí∞ Leave Balance Adjustments</h4>
        <p style="font-size: 0.875rem; color: #6b7280; margin: 0 0 1rem 0;">
          ‚ö†Ô∏è <strong>Warning:</strong> Adjust with caution - all changes are logged in audit trail with your IP address
        </p>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
          <div class="form-group">
            <label class="form-label">Annual Leave (AL)</label>
            <input type="number" id="editBalanceAl" class="form-input" step="0.01" min="0">
          </div>
          
          <div class="form-group">
            <label class="form-label">AL Carry Over</label>
            <input type="number" id="editBalanceAlCarryOver" class="form-input" step="0.01" min="0">
          </div>
          
          <div class="form-group">
            <label class="form-label">Birthday Leave (BL)</label>
            <input type="number" id="editBalanceBl" class="form-input" step="0.5" min="0">
          </div>
          
          <div class="form-group">
            <label class="form-label">Casual Leave (CL)</label>
            <input type="number" id="editBalanceCl" class="form-input" step="0.5" min="0">
          </div>
          
          <div class="form-group">
            <label class="form-label">Compensation (CPL)</label>
            <input type="number" id="editBalanceCpl" class="form-input" step="0.5" min="0">
          </div>
          
          <div class="form-group">
            <label class="form-label">Doctor Consult (DC)</label>
            <input type="number" id="editBalanceDc" class="form-input" step="0.5" min="0">
          </div>
          
          <div class="form-group">
            <label class="form-label">Maternity Leave (ML)</label>
            <input type="number" id="editBalanceMl" class="form-input" step="0.5" min="0">
          </div>
          
          <div class="form-group">
            <label class="form-label">Paternity Leave (PL)</label>
            <input type="number" id="editBalancePl" class="form-input" step="0.5" min="0">
          </div>
          
          <div class="form-group">
            <label class="form-label">Sick Leave (SL)</label>
            <input type="number" id="editBalanceSl" class="form-input" step="0.5" min="0">
          </div>
        </div>
      </div>
      
      <!-- Action Buttons -->
      <div style="display: flex; gap: 1rem; justify-content: flex-end; border-top: 1px solid #e5e7eb; padding-top: 1rem;">
        <button type="button" class="btn" onclick="closeModal('editEmployeeModal')" style="background: #e5e7eb; color: #374151;">
          Cancel
        </button>
        <button type="submit" class="btn btn-primary">
          üíæ Save Changes
        </button>
      </div>
    </form>
  </div>
</div>

<div class="credit-note" style="padding: 0 2rem 1.5rem 2rem;">
  Engineering Team | Powered by OpenAI Codex
</div>

</div>

<!-- GLOBAL PRETTY DIALOG -->
<div id="uiDialogModal" class="modal">
  <div class="modal-content" style="max-width: 520px;">
    <h3 id="uiDialogTitle" style="margin-bottom: 0.75rem; color: #111827;">Notice</h3>
    <div id="uiDialogMessage" style="color: #374151; white-space: pre-wrap;"></div>
    <input id="uiDialogInput" class="form-input" style="display: none; margin-top: 1rem;" />
    <div class="ui-dialog-actions">
      <button id="uiDialogCancel" type="button" class="btn" style="background: #e5e7eb; color: #374151;">Cancel</button>
      <button id="uiDialogOk" type="button" class="btn btn-primary">OK</button>
    </div>
  </div>
</div>

<div id="calendarDayModal" class="modal">
  <div class="modal-content" style="max-width: 620px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h3 id="calendarDayTitle" style="color: #111827;">Calendar Details</h3>
      <button onclick="closeModal('calendarDayModal')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">√ó</button>
    </div>
    <div id="calendarDayDetailsContent"></div>
    <div style="margin-top: 1rem; text-align: right;">
      <button class="btn" onclick="closeModal('calendarDayModal')" style="background: #e5e7eb; color: #374151;">Close</button>
    </div>
  </div>
</div>

<!-- LEAVE SUBMIT PROCESSING POPUP -->
<div id="leaveSubmitProcessingModal" class="modal">
  <div class="modal-content" style="max-width: 420px; text-align: center;">
    <div class="loading-spinner" style="margin: 0 auto 0.75rem auto;"></div>
    <h3 style="color: #111827; margin-bottom: 0.5rem;">Processing Request</h3>
    <p id="leaveSubmitProcessingText" style="color: #6b7280; font-size: 0.92rem; margin: 0;">
      Please wait...
    </p>
  </div>
</div>

<script>
const HKT_TIMEZONE = 'Asia/Hong_Kong';
const HKT_DATE_PARTS_FORMATTER = new Intl.DateTimeFormat('en-GB', {
  timeZone: HKT_TIMEZONE,
  year: 'numeric',
  month: '2-digit',
  day: '2-digit'
});

function getHktDateParts(value = new Date()) {
  const d = value instanceof Date ? value : new Date(value);
  if (Number.isNaN(d.getTime())) return null;
  const parts = HKT_DATE_PARTS_FORMATTER.formatToParts(d);
  const year = Number(parts.find((part) => part.type === 'year')?.value);
  const month = Number(parts.find((part) => part.type === 'month')?.value);
  const day = Number(parts.find((part) => part.type === 'day')?.value);
  if (!year || !month || !day) return null;
  return { year, month, day };
}

const browserNow = new Date();
const hktNowParts = getHktDateParts(browserNow) || {
  year: browserNow.getFullYear(),
  month: browserNow.getMonth() + 1,
  day: browserNow.getDate()
};

// ===== Global Variables =====
let currentUser = null;
let currentMonth = hktNowParts.month - 1;
let currentYear = hktNowParts.year;
let allLeaveRequests = [];
let holidayDates = [];
let approvedLeaves = [];
let calendarRemarks = [];
let publicApprovedLeaves = [];
let publicHolidayDates = [];
let publicCalendarRemarks = [];
let publicCurrentMonth = hktNowParts.month - 1;
let publicCurrentYear = hktNowParts.year;
let selectedFiles = [];
let employeeManagementData = [];
let holidayManagementData = [];
let isLeaveSubmitting = false;
let employeeImportInProgress = false;

// API Configuration
const API_BASE = '/api';

function getAuthHeaders() {
  const token = localStorage.getItem('token');
  return {
    'Content-Type': 'application/json',
    'Authorization': token ? `Bearer ${token}` : ''
  };
}

function dateOnly(value) {
  if (!value) return '';
  const match = String(value).match(/(\d{4}-\d{2}-\d{2})/);
  return match ? match[1] : '';
}

function formatLocalDateYMD(value = new Date()) {
  const parts = getHktDateParts(value);
  if (!parts) return '';
  return `${parts.year}-${String(parts.month).padStart(2, '0')}-${String(parts.day).padStart(2, '0')}`;
}

function getCurrentHktMonthValue() {
  const parts = getHktDateParts(new Date());
  if (!parts) return '';
  return `${parts.year}-${String(parts.month).padStart(2, '0')}`;
}

function escapeHtml(value) {
  return String(value === null || value === undefined ? '' : value)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function sortLeavesByDepartment(leaves) {
  return [...(leaves || [])].sort((a, b) => {
    const deptA = String(a.department || 'ZZZ').toLowerCase();
    const deptB = String(b.department || 'ZZZ').toLowerCase();
    if (deptA !== deptB) return deptA.localeCompare(deptB);
    const nameA = String(a.employee || '').toLowerCase();
    const nameB = String(b.employee || '').toLowerCase();
    return nameA.localeCompare(nameB);
  });
}

function formatLeavePersonLabel(leave) {
  const department = leave.department || 'N/A';
  const employee = leave.employee || '-';
  return `${department} - ${employee}`;
}

function normalizeDurationCode(value) {
  const v = String(value || '').toUpperCase();
  if (v === 'AM') return 'AM';
  if (v === 'PM') return 'PM';
  return 'FT';
}

function getLeaveDurationCodeForDate(leave, dateStr) {
  const startDate = dateOnly(leave.startDate);
  const endDate = dateOnly(leave.endDate);
  const startDurRaw = String(leave.startDurationType || leave.start_duration_type || 'FULL').toUpperCase();
  const endDurRaw = String(leave.endDurationType || leave.end_duration_type || 'FULL').toUpperCase();

  const startDur = normalizeDurationCode(startDurRaw);
  const endDur = normalizeDurationCode(endDurRaw);
  if (!startDate || !endDate) return 'FT';
  if (dateStr < startDate || dateStr > endDate) return 'FT';

  if (startDate === endDate) {
    const fullDayCombo =
      (startDurRaw === 'FULL' && endDurRaw === 'FULL') ||
      (startDurRaw === 'AM' && endDurRaw === 'PM') ||
      (startDurRaw === 'PM' && endDurRaw === 'AM');
    if (fullDayCombo) return 'FT';
    if (startDur === 'AM' || endDur === 'AM') return 'AM';
    if (startDur === 'PM' || endDur === 'PM') return 'PM';
    return 'FT';
  }

  if (dateStr === startDate) return startDur;
  if (dateStr === endDate) return endDur;
  return 'FT';
}

function formatLeaveDurationLabel(leave, dateStr) {
  const code = getLeaveDurationCodeForDate(leave, dateStr);
  if (code === 'AM') return 'AM';
  if (code === 'PM') return 'PM';
  return 'FT';
}

function isAdminAccount() {
  return !!currentUser && (currentUser.role === 'admin' || currentUser.role === 'superadmin');
}

function getCalendarHolidayName(dateStr) {
  const holiday = (holidayDates || []).find((item) => dateOnly(item.date) === dateStr);
  return holiday ? String(holiday.name || '') : '';
}

function getCalendarRemarkByDate(dateStr) {
  return (calendarRemarks || []).find((item) => dateOnly(item.date) === dateStr) || null;
}

function getCalendarLeavesOnDate(dateStr) {
  const holidaySet = new Set((holidayDates || []).map((h) => dateOnly(h.date)).filter(Boolean));
  const leavesOnDay = (approvedLeaves || []).filter((leave) => {
    const startDate = dateOnly(leave.startDate);
    const endDate = dateOnly(leave.endDate);
    if (!startDate || !endDate) return false;
    if (!(dateStr >= startDate && dateStr <= endDate)) return false;

    const isOfficeStaff = leave.isOfficeStaff !== false;
    if (!isOfficeStaff) return true;

    const currentDate = new Date(`${dateStr}T00:00:00`);
    const dayOfWeek = currentDate.getDay();
    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
    return !isWeekend && !holidaySet.has(dateStr);
  });
  return sortLeavesByDepartment(leavesOnDay);
}

function reopenCalendarDayModal(dateStr) {
  openCalendarDayModal(
    dateStr,
    getCalendarLeavesOnDate(dateStr),
    getCalendarHolidayName(dateStr),
    getCalendarRemarkByDate(dateStr)
  );
}

function setLoginButtonBusy(isBusy) {
  const btn = document.getElementById('loginSubmitBtn');
  if (!btn) return;
  btn.disabled = isBusy;
  if (isBusy) {
    btn.dataset.originalText = btn.textContent;
    btn.textContent = 'Logging in...';
    btn.classList.add('is-busy');
  } else {
    btn.textContent = btn.dataset.originalText || 'Login';
    btn.classList.remove('is-busy');
  }
}

function resetLoginButtonState() {
  const btn = document.getElementById('loginSubmitBtn');
  if (!btn) return;
  btn.disabled = false;
  btn.classList.remove('is-busy', 'is-success');
  btn.textContent = 'Login';
  delete btn.dataset.originalText;
  setLoginFeedback('');
}

function setLoginFeedback(message) {
  const feedbackEl = document.getElementById('loginFeedback');
  if (!feedbackEl) return;
  feedbackEl.textContent = message || '';
  feedbackEl.classList.toggle('active', !!message);
}

async function playLoginSuccessAnimation() {
  const btn = document.getElementById('loginSubmitBtn');
  if (!btn) return;
  btn.classList.remove('is-busy');
  btn.classList.add('is-success');
  btn.textContent = 'Welcome';
  await new Promise(resolve => setTimeout(resolve, 520));
}

async function playLoginFailureAnimation(message) {
  const btn = document.getElementById('loginSubmitBtn');
  if (!btn) return;
  btn.classList.remove('is-busy', 'is-success');
  btn.classList.add('is-error');
  btn.disabled = true;
  btn.textContent = 'Try Again';
  setLoginFeedback(message || 'Login failed');
  await new Promise(resolve => setTimeout(resolve, 460));
  btn.classList.remove('is-error');
  btn.disabled = false;
  btn.textContent = 'Login';
}

function openCalendarDayModal(dateStr, leavesOnDay, holidayName, remarkEntry = null) {
  const titleEl = document.getElementById('calendarDayTitle');
  const contentEl = document.getElementById('calendarDayDetailsContent');
  if (!titleEl || !contentEl) return;

  const titleDate = formatDate(dateStr);
  titleEl.textContent = `Calendar Details - ${titleDate}`;

  const holidayBlock = holidayName
    ? `<div style="background: #EFF6FF; border-left: 4px solid #0E7490; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.75rem;">
         <div style="font-size: 0.8rem; color: #0F4C81; font-weight: 700;">Public Holiday</div>
         <div style="color: #1E3A8A;">${escapeHtml(holidayName)}</div>
       </div>`
    : '';

  const remarkText = String((remarkEntry && remarkEntry.remark) || '').trim();
  const hasRemark = !!remarkText;
  const canManageRemarks = isAdminAccount();
  const dateArg = escapeHtml(JSON.stringify(dateStr));
  const remarkArg = escapeHtml(JSON.stringify(remarkText));

  const remarkBlock = (hasRemark || canManageRemarks)
    ? `<div style="background: #FFFBEB; border-left: 4px solid #F59E0B; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.75rem;">
         <div style="font-size: 0.8rem; color: #111827; font-weight: 700;">HR Remark</div>
         <div style="color: #111827; white-space: pre-wrap;">${hasRemark ? escapeHtml(remarkText) : 'No remark on this day.'}</div>
         ${canManageRemarks
           ? `<div style="margin-top: 0.65rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button class="btn btn-primary" type="button" onclick='promptCalendarRemark(${dateArg}, ${remarkArg})' style="padding: 0.45rem 0.8rem; font-size: 0.82rem;">
                  ${hasRemark ? 'Edit Remark' : 'Add Remark'}
                </button>
                ${hasRemark
                  ? `<button class="btn btn-danger" type="button" onclick='deleteCalendarRemark(${dateArg})' style="padding: 0.45rem 0.8rem; font-size: 0.82rem;">Delete Remark</button>`
                  : ''}
              </div>`
           : ''}
       </div>`
    : '';

  const sortedLeaves = sortLeavesByDepartment(leavesOnDay);
  const rows = sortedLeaves.map((l) => (
    (() => {
      const durationLabel = formatLeaveDurationLabel(l, dateStr);
      return (
	    `<div style="padding: 0.65rem 0.75rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 0.5rem;">
	      <div style="font-weight: 600; color: #111827;">${escapeHtml(formatLeavePersonLabel(l))}</div>
	      <div style="font-size: 0.86rem; color: #374151;">${escapeHtml(getLeaveTypeName(l.type))} (${escapeHtml(l.type || '')}) - ${escapeHtml(durationLabel)}</div>
	    </div>`
	      );
	    })()
  )).join('');

  contentEl.innerHTML = `${holidayBlock}${remarkBlock}${rows || '<div style="color:#6b7280;">No approved leave on this day.</div>'}`;
  openModal('calendarDayModal');
}

function showDialog({ title = 'Notice', message = '', mode = 'alert', defaultValue = '', placeholder = '' }) {
  return new Promise(resolve => {
    const modal = document.getElementById('uiDialogModal');
    const titleEl = document.getElementById('uiDialogTitle');
    const msgEl = document.getElementById('uiDialogMessage');
    const inputEl = document.getElementById('uiDialogInput');
    const okBtn = document.getElementById('uiDialogOk');
    const cancelBtn = document.getElementById('uiDialogCancel');

    if (!modal || !titleEl || !msgEl || !inputEl || !okBtn || !cancelBtn) {
      resolve(mode === 'prompt' ? null : mode !== 'confirm');
      return;
    }

    titleEl.textContent = title;
    msgEl.textContent = message || '';
    inputEl.value = defaultValue || '';
    inputEl.placeholder = placeholder || '';
    inputEl.style.display = mode === 'prompt' ? 'block' : 'none';
    cancelBtn.style.display = mode === 'alert' ? 'none' : 'inline-block';

    const cleanup = () => {
      okBtn.onclick = null;
      cancelBtn.onclick = null;
      modal.classList.remove('active');
    };

    okBtn.onclick = () => {
      const val = inputEl.value;
      cleanup();
      if (mode === 'confirm') return resolve(true);
      if (mode === 'prompt') return resolve(val);
      resolve(true);
    };

    cancelBtn.onclick = () => {
      cleanup();
      if (mode === 'confirm') return resolve(false);
      if (mode === 'prompt') return resolve(null);
      resolve(false);
    };

    modal.classList.add('active');
    if (mode === 'prompt') inputEl.focus();
    else okBtn.focus();
  });
}

async function uiAlert(message, title = 'Notice') {
  await showDialog({ title, message, mode: 'alert' });
}

async function uiConfirm(message, title = 'Confirm') {
  return await showDialog({ title, message, mode: 'confirm' });
}

async function uiPrompt(message, options = {}) {
  const title = options.title || 'Input';
  const defaultValue = options.defaultValue || '';
  const placeholder = options.placeholder || '';
  return await showDialog({ title, message, mode: 'prompt', defaultValue, placeholder });
}

async function promptCalendarRemark(dateStr, existingRemark = '') {
  if (!isAdminAccount()) {
    await uiAlert('Only admin can manage calendar remarks.');
    return;
  }

  const remark = await uiPrompt('Add remark for this day:', {
    title: `Calendar Remark - ${formatDate(dateStr)}`,
    defaultValue: existingRemark || '',
    placeholder: 'Example: Mary called in sick this morning'
  });

  if (remark === null) return;

  const safeRemark = String(remark || '').trim();
  if (!safeRemark) {
    await uiAlert('Remark cannot be empty.');
    return;
  }

  await saveCalendarRemark(dateStr, safeRemark);
}

async function saveCalendarRemark(dateStr, remark) {
  try {
    const response = await fetch(`${API_BASE}/admin/calendar/remarks`, {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify({ date: dateStr, remark })
    });
    const raw = await response.text();
    let result = {};
    try {
      result = raw ? JSON.parse(raw) : {};
    } catch (_) {
      result = {};
    }
    if (!response.ok) {
      const message = result.error || raw || `Failed to save calendar remark (HTTP ${response.status}).`;
      await uiAlert(message);
      return;
    }

    await loadCalendar();
    reopenCalendarDayModal(dateStr);
  } catch (error) {
    console.error('Save calendar remark error:', error);
    await uiAlert('Failed to save calendar remark. Please try again.');
  }
}

async function deleteCalendarRemark(dateStr) {
  if (!isAdminAccount()) {
    await uiAlert('Only admin can delete calendar remarks.');
    return;
  }

  if (!(await uiConfirm(`Delete remark on ${formatDate(dateStr)}?`))) return;

  try {
    const response = await fetch(`${API_BASE}/admin/calendar/remarks/${encodeURIComponent(dateStr)}`, {
      method: 'DELETE',
      headers: getAuthHeaders()
    });
    const raw = await response.text();
    let result = {};
    try {
      result = raw ? JSON.parse(raw) : {};
    } catch (_) {
      result = {};
    }
    if (!response.ok) {
      const message = result.error || raw || `Failed to delete calendar remark (HTTP ${response.status}).`;
      await uiAlert(message);
      return;
    }

    await loadCalendar();
    reopenCalendarDayModal(dateStr);
  } catch (error) {
    console.error('Delete calendar remark error:', error);
    await uiAlert('Failed to delete calendar remark. Please try again.');
  }
}

function isSuperAdmin() {
  return !!currentUser && String(currentUser.email || '').toLowerCase() === 'it@example.com';
}

function buildRoleOptionsHtml(includeAdmin) {
  let html = '<option value="employee">Employee</option><option value="approver">Approver/Manager</option>';
  if (includeAdmin) {
    html += '<option value="admin">Admin</option>';
  }
  return html;
}

// ===== Initialize App =====
window.addEventListener('DOMContentLoaded', () => {
  const token = localStorage.getItem('token');
  const userStr = localStorage.getItem('user');
  
  if (token && userStr) {
    try {
      currentUser = JSON.parse(userStr);
      showAppPage();
    } catch (e) {
      console.error('Invalid user data:', e);
      showLoginPage();
    }
  } else {
    showLoginPage();
  }
  
  // Set today's date as default for leave form
  const today = formatLocalDateYMD(new Date());
  if (document.getElementById('startDate')) {
    document.getElementById('startDate').value = today;
    document.getElementById('endDate').value = today;
  }
  setMonthlyApprovedReportMonthDefault();
});

// ===== Authentication Functions =====
document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  setLoginFeedback('');
  
  if (!email || !password) {
    await playLoginFailureAnimation('Please enter both email/staff code and password');
    return;
  }
  
  try {
    setLoginButtonBusy(true);
    const response = await fetch(`${API_BASE}/login`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ email, password })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      await playLoginFailureAnimation(data.error || 'Login failed');
      return;
    }
    
    // Save token and user info
    localStorage.setItem('token', data.token);
    localStorage.setItem('user', JSON.stringify(data.user));
    currentUser = data.user;
    setLoginFeedback('');

    await playLoginSuccessAnimation();
    showAppPage();
    
  } catch (error) {
    console.error('Login error:', error);
    await playLoginFailureAnimation('Login failed. Please check your connection and try again.');
  } finally {
    const btn = document.getElementById('loginSubmitBtn');
    if (btn && !btn.classList.contains('is-success')) {
      setLoginButtonBusy(false);
    }
  }
});

async function handleLogout() {
  if (await uiConfirm('Are you sure you want to logout?')) {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    currentUser = null;
    showLoginPage();
  }
}

async function handleForgotPassword() {
  const input = await uiPrompt(
    'Enter your login email to receive a temporary password:',
    { title: 'Forgot Password' }
  );
  if (input === null) return;

  const email = String(input || '').trim().toLowerCase();
  if (!email) {
    await uiAlert('Email is required.');
    return;
  }

  if (!(await uiConfirm(`Send temporary password to ${email}?\n\nRetail staff passwords are managed by IT.`))) {
    return;
  }

  try {
    const response = await fetch(`${API_BASE}/forgot-password`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email })
    });
    const result = await response.json();
    if (!response.ok) {
      await uiAlert(result.error || 'Failed to process forgot password.');
      return;
    }
    await uiAlert(result.message || 'Temporary password sent to your email.', 'Success');
  } catch (error) {
    console.error('Forgot password error:', error);
    await uiAlert('Failed to process forgot password. Please try again.');
  }
}

function openChangePasswordModal() {
  const location = String((currentUser && currentUser.location) || '').toLowerCase();
  const staffCode = String((currentUser && currentUser.staffCode) || '').toUpperCase();
  const isRetail = location.includes('retail') || staffCode.startsWith('RT') || staffCode === 'DJ001';
  if (isRetail) {
    uiAlert('Retail staff cannot change password in system. Please contact IT.');
    return;
  }

  const currentEl = document.getElementById('currentPasswordInput');
  const newEl = document.getElementById('newPasswordInput');
  const confirmEl = document.getElementById('confirmNewPasswordInput');
  if (currentEl) currentEl.value = '';
  if (newEl) newEl.value = '';
  if (confirmEl) confirmEl.value = '';
  openModal('changePasswordModal');
  if (currentEl) currentEl.focus();
}

function showLoginPage() {
  document.getElementById('loginPage').style.display = 'flex';
  document.getElementById('appPage').style.display = 'none';
  resetLoginButtonState();
}

const NAV_MENU_MOBILE_BREAKPOINT = 1024;

function toggleNavMenu(forceOpen) {
  const navTabsWrap = document.getElementById('navTabsWrap');
  const toggleBtn = document.getElementById('navMenuToggle');
  if (!navTabsWrap || !toggleBtn) return;

  const shouldOpen = typeof forceOpen === 'boolean'
    ? forceOpen
    : !navTabsWrap.classList.contains('open');

  navTabsWrap.classList.toggle('open', shouldOpen);
  toggleBtn.setAttribute('aria-expanded', shouldOpen ? 'true' : 'false');
}

function closeNavMenuOnMobile() {
  if (window.innerWidth <= NAV_MENU_MOBILE_BREAKPOINT) {
    toggleNavMenu(false);
  }
}

window.addEventListener('resize', () => {
  if (window.innerWidth > NAV_MENU_MOBILE_BREAKPOINT) {
    toggleNavMenu(false);
  }
});

function showAppPage() {
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('appPage').style.display = 'block';
  document.getElementById('userNameDisplay').textContent = currentUser.name;
  toggleNavMenu(false);
  const changePasswordBtn = document.getElementById('changePasswordBtn');
  if (changePasswordBtn) {
    const location = String((currentUser && currentUser.location) || '').toLowerCase();
    const staffCode = String((currentUser && currentUser.staffCode) || '').toUpperCase();
    const isRetail = location.includes('retail') || staffCode.startsWith('RT') || staffCode === 'DJ001';
    changePasswordBtn.disabled = isRetail;
    changePasswordBtn.title = isRetail ? 'Retail staff password is managed by IT' : '';
  }
  
  // Show/hide tabs based on role
  if (currentUser.role === 'admin' || currentUser.role === 'superadmin') {
    // Admin: Hide Submit Leave and My Requests, Show Approvals, Employee Management, System Settings, and Audit Logs
    const submitTab = document.querySelector(`[onclick="showPage('submitLeave')"]`);
    const requestsTab = document.querySelector(`[onclick="showPage('myRequests')"]`);
    const approvalsTab = document.getElementById('approvalsTab');
    const adminPendingTab = document.getElementById('adminPendingTab');
    const employeeMgmtTab = document.getElementById('employeeMgmtTab');
    const holidayMgmtTab = document.getElementById('holidayMgmtTab');
    const carryOverTab = document.getElementById('carryOverTab');
    const auditLogsTab = document.getElementById('auditLogsTab');
    const smtpSettingsTab = document.getElementById('smtpSettingsTab');
    const reportsTab = document.getElementById('reportsTab');
    
    if (submitTab) submitTab.style.display = 'none';
    if (requestsTab) requestsTab.style.display = 'none';
    if (approvalsTab) {
      approvalsTab.style.display = 'block';
      approvalsTab.textContent = 'Approval History';
    }
    if (adminPendingTab) adminPendingTab.style.display = 'block';
    if (employeeMgmtTab) employeeMgmtTab.style.display = 'block';
    if (holidayMgmtTab) holidayMgmtTab.style.display = 'block';
    if (carryOverTab) carryOverTab.style.display = 'block';
    if (auditLogsTab) auditLogsTab.style.display = 'block';
    if (smtpSettingsTab) smtpSettingsTab.style.display = 'block';
    if (reportsTab) reportsTab.style.display = 'block';
    
    showPage('dashboard');
  } else if (currentUser.role === 'approver') {
    // Approver: Show all tabs except Employee Management and System Settings
    const submitTab = document.querySelector(`[onclick="showPage('submitLeave')"]`);
    const requestsTab = document.querySelector(`[onclick="showPage('myRequests')"]`);
    const approvalsTab = document.getElementById('approvalsTab');
    const adminPendingTab = document.getElementById('adminPendingTab');
    const employeeMgmtTab = document.getElementById('employeeMgmtTab');
    const holidayMgmtTab = document.getElementById('holidayMgmtTab');
    const carryOverTab = document.getElementById('carryOverTab');
    const auditLogsTab = document.getElementById('auditLogsTab');
    const smtpSettingsTab = document.getElementById('smtpSettingsTab'); 
    const reportsTab = document.getElementById('reportsTab');
    
    if (submitTab) submitTab.style.display = 'block';
    if (requestsTab) requestsTab.style.display = 'block';
    if (approvalsTab) {
      approvalsTab.style.display = 'block';
      approvalsTab.textContent = 'Pending Approvals';
    }
    if (adminPendingTab) adminPendingTab.style.display = 'none';
    if (employeeMgmtTab) employeeMgmtTab.style.display = 'none';
    if (holidayMgmtTab) holidayMgmtTab.style.display = 'none';
    if (carryOverTab) carryOverTab.style.display = 'none';
    if (auditLogsTab) auditLogsTab.style.display = 'none'; 
    if (smtpSettingsTab) smtpSettingsTab.style.display = 'none'; 
    if (reportsTab) reportsTab.style.display = 'none'; 
    
    showPage('dashboard');
  } else {
    // Employee: Show Submit Leave and My Requests only
    const submitTab = document.querySelector(`[onclick="showPage('submitLeave')"]`);
    const requestsTab = document.querySelector(`[onclick="showPage('myRequests')"]`);
    const approvalsTab = document.getElementById('approvalsTab');
    const adminPendingTab = document.getElementById('adminPendingTab');
    const employeeMgmtTab = document.getElementById('employeeMgmtTab');
    const holidayMgmtTab = document.getElementById('holidayMgmtTab');
    const carryOverTab = document.getElementById('carryOverTab');
    const auditLogsTab = document.getElementById('auditLogsTab'); 
    const smtpSettingsTab = document.getElementById('smtpSettingsTab'); 
    const reportsTab = document.getElementById('reportsTab');
    
    if (submitTab) submitTab.style.display = 'block';
    if (requestsTab) requestsTab.style.display = 'block';
    if (approvalsTab) approvalsTab.style.display = 'none';
    if (adminPendingTab) adminPendingTab.style.display = 'none';
    if (employeeMgmtTab) employeeMgmtTab.style.display = 'none';
    if (holidayMgmtTab) holidayMgmtTab.style.display = 'none';
    if (carryOverTab) carryOverTab.style.display = 'none';
    if (auditLogsTab) auditLogsTab.style.display = 'none'; 
    if (smtpSettingsTab) smtpSettingsTab.style.display = 'none'; 
    if (reportsTab) reportsTab.style.display = 'none'; 
    
    showPage('dashboard');
  }
}



// ===== Navigation Functions =====
function showPage(pageName) {
  closeNavMenuOnMobile();

  // Hide all pages and remove active class from all tabs
  const pages = ['dashboardPage', 'submitLeavePage', 'myRequestsPage', 'approvalsPage', 'adminPendingPage', 'employeeMgmtPage', 'holidayMgmtPage', 'carryOverPage', 'smtpSettingsPage', 'reportsPage', 'auditLogsPage'];
  const tabs = ['dashboardTab', 'submitLeaveTab', 'myRequestsTab', 'approvalsTab', 'adminPendingTab', 'employeeMgmtTab', 'holidayMgmtTab', 'carryOverTab', 'smtpSettingsTab', 'reportsTab', 'auditLogsTab'];
  
  // Safely hide all pages
  pages.forEach(pageId => {
    const element = document.getElementById(pageId);
    if (element) element.style.display = 'none';
  });
  
	// Remove active class from ALL nav-tab buttons
	const allNavTabs = document.querySelectorAll('.nav-tab');
	allNavTabs.forEach(tab => {
		tab.classList.remove('active');
	});
  
  // Show selected page
  if (pageName === 'dashboard') {
    document.getElementById('dashboardPage').style.display = 'block';
    const tab = document.querySelector('.nav-tab[onclick="showPage(\'dashboard\')"]');
    if (tab) tab.classList.add('active');
    loadDashboard();
  } else if (pageName === 'submitLeave') {
    document.getElementById('submitLeavePage').style.display = 'block';
    const tab = document.querySelector('.nav-tab[onclick="showPage(\'submitLeave\')"]');
    if (tab) tab.classList.add('active');
    loadLeaveBalance();
  } else if (pageName === 'myRequests') {
    document.getElementById('myRequestsPage').style.display = 'block';
    const tab = document.querySelector('.nav-tab[onclick="showPage(\'myRequests\')"]');
    if (tab) tab.classList.add('active');
    loadMyRequests();
  } else if (pageName === 'approvals') {
    document.getElementById('approvalsPage').style.display = 'block';
    const tab = document.querySelector('.nav-tab[onclick="showPage(\'approvals\')"]');
    if (tab) tab.classList.add('active');
    loadPendingApprovals();
  } else if (pageName === 'adminPending') {
    document.getElementById('adminPendingPage').style.display = 'block';
    const tab = document.querySelector('.nav-tab[onclick="showPage(\'adminPending\')"]');
    if (tab) tab.classList.add('active');
    loadAdminPendingRequests();
  } else if (pageName === 'employeeMgmt') {
    document.getElementById('employeeMgmtPage').style.display = 'block';
    const tab = document.querySelector('.nav-tab[onclick="showPage(\'employeeMgmt\')"]');
    if (tab) tab.classList.add('active');
    loadEmployeeManagement();
  } else if (pageName === 'holidayMgmt') {
    document.getElementById('holidayMgmtPage').style.display = 'block';
    const tab = document.querySelector('.nav-tab[onclick="showPage(\'holidayMgmt\')"]');
    if (tab) tab.classList.add('active');
    loadHolidayManagement();
  } else if (pageName === 'carryOver') {
    const page = document.getElementById('carryOverPage');
    const tab = document.querySelector('.nav-tab[onclick="showPage(\'carryOver\')"]');
    if (page) page.style.display = 'block';
    if (tab) tab.classList.add('active');
    if (typeof loadCarryOverSettings === 'function') {
      loadCarryOverSettings();
    }
  } else if (pageName === 'auditLogs') {
    document.getElementById('auditLogsPage').style.display = 'block';
    const tab = document.querySelector('.nav-tab[onclick="showPage(\'auditLogs\')"]');
    if (tab) tab.classList.add('active');
    loadAuditLogs();
  } else if (pageName === 'smtpSettings') {
    const page = document.getElementById('smtpSettingsPage');
    const tab = document.querySelector('.nav-tab[onclick="showPage(\'smtpSettings\')"]');
    if (page) page.style.display = 'block';
    if (tab) tab.classList.add('active');
    loadSMTPConfig();
  } else if (pageName === 'reports') {
    const page = document.getElementById('reportsPage');
    const tab = document.querySelector('.nav-tab[onclick="showPage(\'reports\')"]');
    if (page) page.style.display = 'block';
    if (tab) tab.classList.add('active');
    setMonthlyApprovedReportMonthDefault();
  }
}


// ===== Dashboard Functions =====
async function loadDashboard() {
  await loadLeaveBalance();
  await loadCalendar();
  await loadRecentRequests();
}

async function loadLeaveBalance() {
  try {
    const response = await fetch(`${API_BASE}/user/balance`, {
      headers: getAuthHeaders()
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error || 'Failed to load balance');
    }
    
    // Store for later use
    window.userBalance = data;
    
    // HIDE BALANCE FOR ADMIN
    if (currentUser.role === 'admin' || currentUser.role === 'superadmin') {
      const statsGrid = document.getElementById('statsGrid');
      const balanceTitle = document.querySelector('.balance-title');
      
      if (statsGrid) statsGrid.style.display = 'none';
      if (balanceTitle) balanceTitle.style.display = 'none';
      
      return; // Exit early for admin
    }
    
    const annualBalance = Number(data.balance_al) || 0;
    const birthdayBalance = Number(data.balance_bl) || 0;
    const carryOver = Number(data.balance_al_carry_over) || 0;
    const annualColor = annualBalance < 0 ? '#dc2626' : '#0F766E';
    const birthdayColor = birthdayBalance < 0 ? '#dc2626' : '#0E7490';
    const carryOverColor = carryOver < 0 ? '#dc2626' : '#10b981';
    
    // Render stats grid with title
    const statsGrid = document.getElementById('statsGrid');
    
    // Add title above stats grid
    const dashboardSection = document.getElementById('dashboardPage');
    const existingTitle = dashboardSection.querySelector('.balance-title');
    if (!existingTitle) {
      const titleDiv = document.createElement('div');
      titleDiv.className = 'balance-title';
      titleDiv.innerHTML = `
        <h3 style="color: #374151; font-size: 1.125rem; margin-bottom: 1.5rem; padding-bottom: 0.75rem; border-bottom: 2px solid #0F766E;">
          üìä Leave Balance Overview ÂÅáÊúüÈ§òÈ°ç
        </h3>
      `;
      statsGrid.parentNode.insertBefore(titleDiv, statsGrid);
    }
    
    statsGrid.innerHTML = `
      <div class="stat-card">
        <div class="stat-label">Annual Leave Âπ¥ÂÅá</div>
        <div class="stat-value" style="color: ${annualColor};">${formatBalanceDisplay(annualBalance)}</div>
        <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">Days Remaining Ââ©È§òÂ§©Êï∏</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Birthday Leave ÁîüÊó•ÂÅá</div>
        <div class="stat-value" style="color: ${birthdayColor};">${formatBalanceDisplay(birthdayBalance)}</div>
        <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">Days Remaining Ââ©È§òÂ§©Êï∏</div>
      </div>
      <div class="stat-card" style="border-left-color: #10b981;">
        <div class="stat-label">Carry Over AL Âπ¥ÂÅáÁµêËΩâ</div>
        <div class="stat-value" style="color: ${carryOverColor};">${formatBalanceDisplay(carryOver)}</div>
        <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">From Previous Year ‰∏äÂπ¥Â∫¶ÁµêËΩâ</div>
      </div>
    `;
    
  } catch (error) {
    console.error('Error loading balance:', error);
    // Don't alert for admin
    if (currentUser.role !== 'admin' && currentUser.role !== 'superadmin') {
      await uiAlert('Failed to load leave balance');
    }
  }
}

async function loadCalendar() {
  try {
    const [leavesResponse, holidaysResponse, remarksResponse] = await Promise.all([
      fetch(`${API_BASE}/calendar/leaves`, {
        headers: getAuthHeaders()
      }),
      fetch(`${API_BASE}/holidays`, {
        headers: getAuthHeaders()
      }),
      fetch(`${API_BASE}/calendar/remarks`, {
        headers: getAuthHeaders()
      })
    ]);

    if (!leavesResponse.ok) {
      throw new Error('Failed to load calendar leaves');
    }
    if (!holidaysResponse.ok) {
      throw new Error('Failed to load holidays');
    }

    approvedLeaves = await leavesResponse.json();
    holidayDates = await holidaysResponse.json();
    calendarRemarks = remarksResponse.ok ? await remarksResponse.json() : [];

    renderCalendar();
  } catch (error) {
    console.error('Error loading calendar:', error);
  }
}

async function loadPublicCalendar() {
  try {
    const [leavesResponse, holidaysResponse, remarksResponse] = await Promise.all([
      fetch(`${API_BASE}/public/calendar/leaves`, { cache: 'no-store' }),
      fetch(`${API_BASE}/public/holidays`, { cache: 'no-store' }),
      fetch(`${API_BASE}/public/calendar/remarks`, { cache: 'no-store' })
    ]);
    publicApprovedLeaves = await leavesResponse.json();
    publicHolidayDates = await holidaysResponse.json();
    publicCalendarRemarks = remarksResponse.ok ? await remarksResponse.json() : [];

    renderPublicCalendar();
  } catch (error) {
    console.error('Error loading public calendar:', error);
  }
}

function renderCalendar() {
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  const monthEl = document.getElementById('calendarMonth');
  const calendarDays = document.getElementById('calendarDays');
  if (!monthEl || !calendarDays) return;

  monthEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;
  const holidaySet = new Set((holidayDates || []).map(h => dateOnly(h.date)).filter(Boolean));
  const remarkByDate = new Map(
    (calendarRemarks || [])
      .map((item) => [dateOnly(item.date), item])
      .filter(([date]) => !!date)
  );
  const canManageRemarks = isAdminAccount();
  const todayHkt = getHktDateParts(new Date());
  
  const firstDay = new Date(currentYear, currentMonth, 1).getDay();
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
  calendarDays.innerHTML = '';
  
  // Empty cells before first day
  for (let i = 0; i < firstDay; i++) {
    const emptyCell = document.createElement('div');
    emptyCell.className = 'calendar-day';
    calendarDays.appendChild(emptyCell);
  }
  
  // Days of the month
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const dayCell = document.createElement('div');
    dayCell.className = 'calendar-day';
    
    // Check if today
    if (todayHkt && day === todayHkt.day && currentMonth === todayHkt.month - 1 && currentYear === todayHkt.year) {
      dayCell.classList.add('today');
    }
    
    // Check if holiday
    const isHoliday = holidaySet.has(dateStr);
    let holidayName = '';
    if (isHoliday) {
      dayCell.classList.add('holiday');
      const holiday = holidayDates.find(h => dateOnly(h.date) === dateStr);
      holidayName = holiday ? holiday.name : '';
    }

    const remarkEntry = remarkByDate.get(dateStr) || null;
    const remarkText = String((remarkEntry && remarkEntry.remark) || '').trim();
    const hasRemark = !!remarkText;
    if (hasRemark) {
      dayCell.classList.add('has-remark');
    }
    const remarkLabelHtml = hasRemark
      ? `<div class="calendar-remark-preview">üìù ${escapeHtml(remarkText)}</div>`
      : '';
    
	// Check if someone is on leave - Use string comparison
	const leavesOnDay = approvedLeaves.filter(leave => {
	  const startDate = dateOnly(leave.startDate);
	  const endDate = dateOnly(leave.endDate);
      if (!startDate || !endDate) return false;
      if (!(dateStr >= startDate && dateStr <= endDate)) return false;

      const isOfficeStaff = leave.isOfficeStaff !== false;
      if (!isOfficeStaff) {
        return true;
      }

      const currentDate = new Date(`${dateStr}T00:00:00`);
      const dayOfWeek = currentDate.getDay();
      const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
      return !isWeekend && !holidaySet.has(dateStr);
	});
    const sortedLeavesOnDay = sortLeavesByDepartment(leavesOnDay);
	const hasLeave = sortedLeavesOnDay.length > 0;

    const holidayLabelHtml = isHoliday && holidayName
      ? `<div style="font-size: 0.58rem; color: #DC2626; font-weight: 700; line-height: 1.05; margin-bottom: 2px; text-align: center; white-space: normal; word-break: break-word; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${escapeHtml(holidayName)}</div>`
      : '';

    const leaveTitle = sortedLeavesOnDay
      .map((l) => `${formatLeavePersonLabel(l)} (${l.type}) - ${formatLeaveDurationLabel(l, dateStr)}`)
      .join('\n');
    const tooltipParts = [];
    if (isHoliday && holidayName) tooltipParts.push(holidayName);
    if (hasRemark) tooltipParts.push(`Remark: ${remarkText}`);
    if (leaveTitle) tooltipParts.push(leaveTitle);
    if (tooltipParts.length === 0 && canManageRemarks) {
      tooltipParts.push('Click to add temporary HR remark');
    }
    if (tooltipParts.length > 0) {
      dayCell.title = tooltipParts.join('\n');
    }

    const shouldBeClickable = hasLeave || isHoliday || hasRemark || canManageRemarks;
    if (shouldBeClickable) {
      dayCell.style.cursor = 'pointer';
      dayCell.addEventListener('click', () => openCalendarDayModal(dateStr, sortedLeavesOnDay, holidayName, remarkEntry));
    }

    if (hasLeave) {
	  dayCell.classList.add('has-leave');

		  const previewRows = sortedLeavesOnDay
			.slice(0, 2)
			.map((l) => escapeHtml(`${l.department || 'N/A'} - ${l.employee} (${l.type}) - ${formatLeaveDurationLabel(l, dateStr)}`));
	  const overflowCount = sortedLeavesOnDay.length - previewRows.length;
	  const overflowLine = overflowCount > 0 ? `+${overflowCount} more` : '';

	  dayCell.innerHTML = `
        ${holidayLabelHtml}
		<div style="font-weight: 700;">${day}</div>
		<div style="font-size: 0.62rem; line-height: 1.1; margin-top: 2px; text-align: center;">
		  ${previewRows.map(r => `<div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${r}</div>`).join('')}
		  ${overflowLine ? `<div style="font-weight: 700;">${overflowLine}</div>` : ''}
		</div>
    ${remarkLabelHtml}
	  `;
	} else {
	  if (holidayLabelHtml || hasRemark) {
        dayCell.innerHTML = `${holidayLabelHtml}<div style="font-weight: 700; text-align: center;">${day}</div>${remarkLabelHtml}`;
      } else {
        dayCell.textContent = day;
      }
	}

    
    calendarDays.appendChild(dayCell);
  }
}



function changeMonth(delta) {
  currentMonth += delta;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  } else if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  renderCalendar();
}

function renderPublicCalendar() {
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  const monthEl = document.getElementById('loginCalendarMonth');
  const daysEl = document.getElementById('loginCalendarDays');
  if (!monthEl || !daysEl) return;

  monthEl.textContent = `${monthNames[publicCurrentMonth]} ${publicCurrentYear}`;
  const holidaySet = new Set((publicHolidayDates || []).map(h => dateOnly(h.date)).filter(Boolean));
  const remarkByDate = new Map(
    (publicCalendarRemarks || [])
      .map((item) => [dateOnly(item.date), item])
      .filter(([date]) => !!date)
  );

  const firstDay = new Date(publicCurrentYear, publicCurrentMonth, 1).getDay();
  const daysInMonth = new Date(publicCurrentYear, publicCurrentMonth + 1, 0).getDate();
  daysEl.innerHTML = '';

  for (let i = 0; i < firstDay; i++) {
    const emptyCell = document.createElement('div');
    emptyCell.className = 'calendar-day';
    daysEl.appendChild(emptyCell);
  }

  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${publicCurrentYear}-${String(publicCurrentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const dayCell = document.createElement('div');
    dayCell.className = 'calendar-day';

    const isHoliday = holidaySet.has(dateStr);
    let holidayName = '';
    if (isHoliday) {
      dayCell.classList.add('holiday');
      const holiday = publicHolidayDates.find(h => dateOnly(h.date) === dateStr);
      holidayName = holiday ? holiday.name : '';
    }

    const holidayLabelHtml = isHoliday && holidayName
      ? `<div style="font-size: 0.58rem; color: #DC2626; font-weight: 700; line-height: 1.05; margin-bottom: 2px; text-align: center; white-space: normal; word-break: break-word; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${escapeHtml(holidayName)}</div>`
      : '';

    const remarkEntry = remarkByDate.get(dateStr) || null;
    const remarkText = String((remarkEntry && remarkEntry.remark) || '').trim();
    const hasRemark = !!remarkText;
    if (hasRemark) {
      dayCell.classList.add('has-remark');
    }
    const remarkLabelHtml = hasRemark
      ? `<div class="calendar-remark-preview">üìù ${escapeHtml(remarkText)}</div>`
      : '';

    const leavesOnDay = publicApprovedLeaves.filter(leave => {
      const startDate = dateOnly(leave.startDate);
      const endDate = dateOnly(leave.endDate);
      if (!startDate || !endDate) return false;
      if (!(dateStr >= startDate && dateStr <= endDate)) return false;

      const isOfficeStaff = leave.isOfficeStaff !== false;
      if (!isOfficeStaff) {
        return true;
      }

      const currentDate = new Date(`${dateStr}T00:00:00`);
      const dayOfWeek = currentDate.getDay();
      const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
      return !isWeekend && !holidaySet.has(dateStr);
    });

    const sortedLeavesOnDay = sortLeavesByDepartment(leavesOnDay);
    const hasLeave = sortedLeavesOnDay.length > 0;
    const leaveTitle = sortedLeavesOnDay
      .map((l) => `${formatLeavePersonLabel(l)} (${l.type}) - ${formatLeaveDurationLabel(l, dateStr)}`)
      .join('\n');
    const tooltipParts = [];
    if (isHoliday && holidayName) tooltipParts.push(holidayName);
    if (hasRemark) tooltipParts.push(`Remark: ${remarkText}`);
    if (leaveTitle) tooltipParts.push(leaveTitle);
    if (tooltipParts.length > 0) {
      dayCell.title = tooltipParts.join('\n');
    }

    const shouldBeClickable = hasLeave || isHoliday || hasRemark;
    if (shouldBeClickable) {
      dayCell.style.cursor = 'pointer';
      dayCell.addEventListener('click', () => openCalendarDayModal(dateStr, sortedLeavesOnDay, holidayName, remarkEntry));
    }

    if (hasLeave) {
      dayCell.classList.add('has-leave');

      const previewRows = sortedLeavesOnDay
        .slice(0, 2)
        .map((l) => escapeHtml(`${l.department || 'N/A'} - ${l.employee} (${l.type}) - ${formatLeaveDurationLabel(l, dateStr)}`));
      const overflowCount = sortedLeavesOnDay.length - previewRows.length;
      const overflowLine = overflowCount > 0 ? `+${overflowCount} more` : '';

      dayCell.innerHTML = `
        ${holidayLabelHtml}
        <div style="font-weight: 700;">${day}</div>
        <div style="font-size: 0.62rem; line-height: 1.1; margin-top: 2px; text-align: center;">
          ${previewRows.map(r => `<div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${r}</div>`).join('')}
          ${overflowLine ? `<div style="font-weight: 700;">${overflowLine}</div>` : ''}
        </div>
        ${remarkLabelHtml}
      `;
    } else {
      if (holidayLabelHtml || hasRemark) {
        dayCell.innerHTML = `${holidayLabelHtml}<div style="font-weight: 700; text-align: center;">${day}</div>${remarkLabelHtml}`;
      } else {
        dayCell.textContent = day;
      }
    }

    daysEl.appendChild(dayCell);
  }
}

function changePublicMonth(delta) {
  publicCurrentMonth += delta;
  if (publicCurrentMonth < 0) {
    publicCurrentMonth = 11;
    publicCurrentYear--;
  } else if (publicCurrentMonth > 11) {
    publicCurrentMonth = 0;
    publicCurrentYear++;
  }
  renderPublicCalendar();
}


async function loadRecentRequests() {
  try {
    // Admin should see ALL recent requests, not just their own
    let apiUrl = `${API_BASE}/leave-requests?limit=5`;
    
    // If user is admin, fetch all requests instead
    if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'superadmin')) {
      apiUrl = `${API_BASE}/admin/all-leave-requests?limit=5`;
    }
    
    const response = await fetch(apiUrl, {
      headers: getAuthHeaders()
    });
    
    if (!response.ok) {
      throw new Error('Failed to load recent requests');
    }
    
    const requests = await response.json();
    const tableBody = document.getElementById('recentRequestsTable');
    
    if (!tableBody) {
      console.error('Recent requests table body not found');
      return;
    }
    
    if (requests.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: #6b7280; padding: 2rem;">No leave requests yet</td></tr>`;
      return;
    }
    
    tableBody.innerHTML = requests.map(req => `
      <tr>
        <td>${escapeHtml(req.employee_name || currentUser.name || req.employee_email || '-')}</td>
        <td>${escapeHtml(req.type || '')}</td>
        <td>${escapeHtml(formatDate(req.start_date || req.startdate))}</td>
        <td>${escapeHtml(formatDate(req.end_date || req.enddate))}</td>
        <td>${escapeHtml(req.days)}</td>
        <td>${getStatusBadge(req.status)}</td>
        <td>${escapeHtml(formatDate(req.submitted_at || req.submittedat))}</td>
      </tr>
    `).join('');
    
  } catch (error) {
    console.error('Error loading recent requests:', error);
    const tableBody = document.getElementById('recentRequestsTable');
    if (tableBody) {
      tableBody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: #dc2626; padding: 2rem;">Failed to load recent requests</td></tr>`;
    }
  }
}


// ===== File Upload Functions =====
function handleFileSelect(event) {
  const files = Array.from(event.target.files);
  selectedFiles = files;
  
  const fileList = document.getElementById('fileList');
  
  if (files.length > 0) {
    const fileItems = files.map(f => {
      const sizeKB = (f.size / 1024).toFixed(1);
      return `<li>üìÑ ${escapeHtml(f.name)} (${sizeKB} KB)</li>`;
    }).join('');
    
    fileList.innerHTML = `
      <p style="margin-top: 0.5rem;"><strong>Selected files:</strong></p>
      <ul style="list-style: none; padding: 0;">
        ${fileItems}
      </ul>
    `;
  } else {
    fileList.innerHTML = '';
  }
}


// ===== Leave Request Submission =====
function setLeaveSubmitProcessingMessage(message) {
  const textEl = document.getElementById('leaveSubmitProcessingText');
  if (textEl) {
    textEl.textContent = message || 'Please wait...';
  }
}

function setLeaveSubmittingState(isSubmitting, message = '') {
  const submitBtn = document.getElementById('leaveSubmitBtn');
  const resetBtn = document.getElementById('leaveResetBtn');
  const fileInput = document.getElementById('documentUpload');

  isLeaveSubmitting = isSubmitting;

  if (submitBtn) {
    submitBtn.disabled = isSubmitting;
    submitBtn.textContent = isSubmitting ? 'Submitting...' : 'Submit Request';
  }
  if (resetBtn) resetBtn.disabled = isSubmitting;
  if (fileInput) fileInput.disabled = isSubmitting;

  const processingModal = document.getElementById('leaveSubmitProcessingModal');
  if (!processingModal) return;

  if (isSubmitting) {
    setLeaveSubmitProcessingMessage(message || 'Submitting leave request. Please wait...');
    processingModal.classList.add('active');
  } else {
    processingModal.classList.remove('active');
  }
}

document.getElementById('leaveRequestForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  if (isLeaveSubmitting) return;
  
  const type = document.getElementById('leaveType').value;
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  const startDurationType = document.getElementById('startDurationType').value;
  const endDurationType = document.getElementById('endDurationType').value;
  const remarks = document.getElementById('remarks').value;
  
  if (!type || !startDate || !endDate) {
    await uiAlert('Please fill in all required fields');
    return;
  }
  
  const days = parseFloat(document.getElementById('daysPreview').textContent);
  if (days <= 0) {
    await uiAlert('Invalid leave duration. Please check your dates.');
    return;
  }

  if (type === 'BL') {
    if (days > 1) {
      await uiAlert('Birthday Leave (BL) cannot exceed 1 day per request. Half-day BL is allowed.');
      return;
    }

    const leaveYear = Number.parseInt(String(startDate || '').slice(0, 4), 10);
    if (!Number.isFinite(leaveYear)) {
      await uiAlert('Invalid BL start date.');
      return;
    }

    try {
      const existingRes = await fetch(`${API_BASE}/leave-requests`, { headers: getAuthHeaders() });
      if (existingRes.ok) {
        const existingRequests = await existingRes.json();
        const usedBlDays = (Array.isArray(existingRequests) ? existingRequests : [])
          .filter(r =>
            String(r.type || '').toUpperCase() === 'BL' &&
            (r.status === 'pending' || r.status === 'approved') &&
            String(r.start_date || '').slice(0, 4) === String(leaveYear)
          )
          .reduce((sum, r) => sum + (parseFloat(r.days) || 0), 0);

        const totalAfterSubmit = Math.round((usedBlDays + days) * 100) / 100;
        if (totalAfterSubmit > 1) {
          await uiAlert(`Birthday Leave limit exceeded. You already requested ${usedBlDays.toFixed(1)} day(s) in ${leaveYear}. Max is 1.0 day per year (half-day allowed).`);
          return;
        }
      }
    } catch (blCheckError) {
      console.warn('BL yearly limit pre-check failed, server will validate:', blCheckError);
    }
  }
  
  try {
    setLeaveSubmittingState(true, 'Submitting leave request. Please wait while notification email is being processed...');

    // First, submit the leave request
    const response = await fetch(`${API_BASE}/leave-requests`, {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify({
        type,
        startDate,
        endDate,
        startDurationType,
        endDurationType,
        remarks,
        hasAttachment: selectedFiles.length > 0,
        attachmentCount: selectedFiles.length
      })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      setLeaveSubmittingState(false);
      await uiAlert(data.error || 'Failed to submit request');
      return;
    }
    
    // If files are selected, upload them
    if (selectedFiles.length > 0) {
      setLeaveSubmittingState(true, `Request submitted. Uploading ${selectedFiles.length} attachment(s)...`);
      const formData = new FormData();
      selectedFiles.forEach(file => {
        formData.append('files', file);
      });
      
      const uploadResponse = await fetch(`${API_BASE}/leave-requests/${data.requestId}/documents`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: formData
      });
      
      if (!uploadResponse.ok) {
        console.error('File upload failed');
      }
    }

    setLeaveSubmittingState(false);
    if (data && data.emailSent === false) {
      await uiAlert(
        `Leave request ${data.requestId} was submitted, but notification email failed to send.\n\nPlease contact IT (it@example.com).`,
        'Email Delivery Failed'
      );
    } else {
      await uiAlert(`Leave request ${data.requestId} submitted successfully and notification email sent.`, 'Success');
    }
    resetLeaveForm();

    // Stay on Submit Leave page (no auto-redirect)
  } catch (error) {
    console.error('Error submitting request:', error);
    setLeaveSubmittingState(false);
    await uiAlert('Failed to submit request. Please try again.');
  } finally {
    setLeaveSubmittingState(false);
  }
});

function setDuration(which, duration) {
  // Update hidden input
  document.getElementById(`${which}DurationType`).value = duration;
  
  // Update button states
  const parentGroup = document.getElementById(`${which}DurationType`).parentElement;
  const buttons = parentGroup.querySelectorAll('.duration-btn');
  buttons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  // Recalculate days
  calculateDays();
}

// ===== Calculate Working Days =====
async function calculateDays() {
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  const startDurationType = document.getElementById('startDurationType').value;
  const endDurationType = document.getElementById('endDurationType').value;
  const leaveType = document.getElementById('leaveType').value;
  
  const daysPreview = document.getElementById('daysPreview');
  const balancePreview = document.getElementById('balancePreview');
  
  if (!startDate || !endDate) {
    daysPreview.textContent = '0';
    balancePreview.textContent = '-';
    return;
  }
  
  try {
    // Call backend API to calculate working days
    const response = await fetch(`${API_BASE}/calculate-working-days`, {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify({
        startdate: startDate,
        enddate: endDate,
        startdurationtype: startDurationType,
        enddurationtype: endDurationType
      })
    });
    
    if (!response.ok) {
      throw new Error('Failed to calculate days');
    }
    
    const result = await response.json();
    const days = result.days || 0;
    
    daysPreview.textContent = days;
    
    // Update balance preview if leave type is selected
    if (leaveType && currentUser) {
      const balanceResponse = await fetch(`${API_BASE}/user/balance`, {
        headers: getAuthHeaders()
      });
      
      if (balanceResponse.ok) {
        const balanceData = await balanceResponse.json();
        
        const balanceMap = {
          'AL': (parseFloat(balanceData.balance_al) || 0) + (parseFloat(balanceData.balance_al_carry_over) || 0),
          'BL': balanceData.balance_bl,
          'CL': balanceData.balance_cl,
          'CPL': balanceData.balance_cpl,
          'DC': balanceData.balance_dc,
          'ML': balanceData.balance_ml,
          'PL': balanceData.balance_pl,
          'SL': balanceData.balance_sl
        };
        
        const currentBalance = balanceMap[leaveType];
        
        if (currentBalance !== undefined) {
          const newBalance = currentBalance - days;
          balancePreview.textContent = newBalance.toFixed(1);
          
          // Color code the balance
          if (newBalance < 0) {
            balancePreview.style.color = '#dc2626'; // Red
          } else if (newBalance <= 2) {
            balancePreview.style.color = '#0E7490'; // Teal
          } else {
            balancePreview.style.color = '#059669'; // Green
          }
        } else {
          balancePreview.textContent = 'N/A';
          balancePreview.style.color = '#6b7280';
        }
      }
    } else {
      balancePreview.textContent = '-';
      balancePreview.style.color = '#6b7280';
    }
	
    // Sync mini calendar with the calculated value
    updateMiniCalendar();
	
  } catch (error) {
    console.error('Error calculating days:', error);
    daysPreview.textContent = 'Error';
    balancePreview.textContent = '-';
  }
}

// ===== Set Duration =====
function setDuration(type, value) {
  const hiddenInput = document.getElementById(type + 'DurationType');
  hiddenInput.value = value;
  
  // Update button styles
  const buttons = document.querySelectorAll(`.duration-group button`);
  buttons.forEach(btn => {
    if (btn.closest(`.form-group`).querySelector('label').textContent.includes(type === 'start' ? 'Start' : 'End')) {
      btn.classList.remove('active');
      if (btn.textContent.includes(value) || (value === 'FULL' && btn.textContent === 'Full Day')) {
        btn.classList.add('active');
      }
    }
  });
  
  calculateDays();
  updateMiniCalendar();
}


// Update balance preview when leave type changes
document.getElementById('leaveType').addEventListener('change', calculateDays);

function resetLeaveForm() {
  document.getElementById('leaveRequestForm').reset();
  setLeaveSubmittingState(false);
  
  // Reset duration buttons
  const durationBtns = document.querySelectorAll('.duration-btn');
  durationBtns.forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.duration-group')[0].querySelector('.duration-btn').classList.add('active');
  document.querySelectorAll('.duration-group')[1].querySelector('.duration-btn').classList.add('active');
  
  document.getElementById('startDurationType').value = 'FULL';
  document.getElementById('endDurationType').value = 'FULL';
  
  const today = formatLocalDateYMD(new Date());
  document.getElementById('startDate').value = today;
  document.getElementById('endDate').value = today;
  
  document.getElementById('daysPreview').textContent = '0';
  document.getElementById('balancePreview').textContent = '-';
  
  // Reset file upload
  selectedFiles = [];
  document.getElementById('fileList').innerHTML = '';
  document.getElementById('documentUpload').value = '';
}

// ===== My Requests Functions =====
async function loadMyRequests() {
  try {
    const response = await fetch(`${API_BASE}/leave-requests`, {
      headers: getAuthHeaders()
    });
    
    allLeaveRequests = await response.json();
    
    // Populate all tabs
    populateRequestsTable('all', allLeaveRequests);
    populateRequestsTable('pending', allLeaveRequests.filter(r => r.status === 'pending'));
    populateRequestsTable('approved', allLeaveRequests.filter(r => r.status === 'approved'));
    populateRequestsTable('rejected', allLeaveRequests.filter(r => r.status === 'rejected'));
    
  } catch (error) {
    console.error('Error loading requests:', error);
    await uiAlert('Failed to load requests');
  }
}

// Delete Request Function - ADD THIS
async function deleteRequest(requestId) {
  const isAdminAccount = currentUser && (currentUser.role === 'admin' || currentUser.role === 'superadmin');
  const confirmMessage = isAdminAccount
    ? 'Are you sure you want to delete this request?\n\nIf this request belongs to another employee, an email notification will be sent to that employee.'
    : 'Are you sure you want to delete this request?';
  if (!(await uiConfirm(confirmMessage))) {
    return;
  }
  
  try {
    const response = await fetch(`${API_BASE}/leave-requests/${requestId}`, {
      method: 'DELETE',
      headers: getAuthHeaders()
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      await uiAlert(data.error || 'Failed to delete request');
      return;
    }
    
    await uiAlert(data.message || 'Request deleted successfully!');
    // Reload the requests list
    loadMyRequests();
  } catch (error) {
    console.error('Error deleting request:', error);
    await uiAlert('Failed to delete request. Please try again.');
  }
}

async function cancelApprovedLeaveByAdmin(requestId) {
  const isAdmin = currentUser && (currentUser.role === 'admin' || currentUser.role === 'superadmin');
  if (!isAdmin) {
    await uiAlert('Only admin can cancel approved leave requests.');
    return;
  }

  const reason = await uiPrompt(
    'Cancellation reason is required (minimum 3 characters):',
    { title: 'Cancel Approved Leave', placeholder: 'Reason for cancellation...' }
  );
  if (reason === null) return;

  const trimmedReason = String(reason || '').trim();
  if (trimmedReason.length < 3) {
    await uiAlert('Please enter a reason with at least 3 characters.');
    return;
  }

  const confirmed = await uiConfirm(
    `Cancel approved leave request ${requestId}?\n\n` +
    `The employee balance will be credited back automatically.\n` +
    `An email notification will be sent to the employee.`,
    'Confirm Cancellation'
  );
  if (!confirmed) return;

  try {
    const response = await fetch(`${API_BASE}/leave-requests/${requestId}`, {
      method: 'DELETE',
      headers: getAuthHeaders(),
      body: JSON.stringify({ cancelReason: trimmedReason })
    });

    const data = await response.json();
    if (!response.ok) {
      await uiAlert(data.error || 'Failed to cancel approved leave');
      return;
    }

    const successText = data.emailQueued
      ? `${data.message || 'Approved leave cancelled successfully!'}\n\nEmployee email notification has been queued.`
      : (data.message || 'Approved leave cancelled successfully!');
    await uiAlert(successText, 'Success');
    await refreshApprovalViews(requestId);
  } catch (error) {
    console.error('Error cancelling approved leave:', error);
    await uiAlert('Failed to cancel approved leave. Please try again.');
  }
}


function populateRequestsTable(tab, requests) {
  let tableId = '';
  
  if (tab === 'all') {
    tableId = 'allRequestsTable';
  } else if (tab === 'pending') {
    tableId = 'pendingRequestsTable';
  } else if (tab === 'approved') {
    tableId = 'approvedRequestsTable';
  } else if (tab === 'rejected') {
    tableId = 'rejectedRequestsTable';
  }
  
  const tableBody = document.getElementById(tableId);
  
  if (requests.length === 0) {
    const colspan = tab === 'pending' ? 7 : 8;
    tableBody.innerHTML = `
      <tr>
        <td colspan="${colspan}" style="text-align: center; color: #6b7280; padding: 2rem;">
          No ${tab !== 'all' ? tab : ''} requests found
        </td>
      </tr>
    `;
    return;
  }
  
  let tableRows = '';
  
  if (tab === 'all') {
    tableRows = requests.map(req => {
      const requestId = String(req.id || '');
      const requestIdArg = escapeHtml(JSON.stringify(requestId));
      const deleteBtn = req.status === 'pending' 
        ? '<button class="btn btn-danger" onclick=\'deleteRequest(' + requestIdArg + ')\' style="padding: 0.5rem 1rem; font-size: 0.875rem;">Delete</button>'
        : '';
      
      return `
        <tr>
          <td>${escapeHtml(requestId)}</td>
          <td>${escapeHtml(req.type || '')}</td>
          <td>${escapeHtml(formatDate(req.start_date))}</td>
          <td>${escapeHtml(formatDate(req.end_date))}</td>
          <td>${escapeHtml(req.days)}</td>
          <td>${getStatusBadge(req.status)}</td>
          <td>${escapeHtml(formatDate(req.submitted_at))}</td>
          <td>
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn" onclick='viewRequestDetails(${requestIdArg})' style="padding: 0.5rem 1rem; font-size: 0.875rem;">View</button>
              ${deleteBtn}
            </div>
          </td>
        </tr>
      `;
    }).join('');
  } else if (tab === 'pending') {
    tableRows = requests.map(req => {
      const requestId = String(req.id || '');
      const requestIdArg = escapeHtml(JSON.stringify(requestId));
      return `
        <tr>
          <td>${escapeHtml(requestId)}</td>
          <td>${escapeHtml(req.type || '')}</td>
          <td>${escapeHtml(formatDate(req.start_date))}</td>
          <td>${escapeHtml(formatDate(req.end_date))}</td>
          <td>${escapeHtml(req.days)}</td>
          <td>${escapeHtml(formatDate(req.submitted_at))}</td>
          <td>
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn" onclick='viewRequestDetails(${requestIdArg})' style="padding: 0.5rem 1rem; font-size: 0.875rem;">View</button>
              <button class="btn btn-danger" onclick='deleteRequest(${requestIdArg})' style="padding: 0.5rem 1rem; font-size: 0.875rem;">Delete</button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  } else if (tab === 'approved') {
    tableRows = requests.map(req => {
      const requestId = String(req.id || '');
      const requestIdArg = escapeHtml(JSON.stringify(requestId));
      return `
        <tr>
          <td>${escapeHtml(requestId)}</td>
          <td>${escapeHtml(req.type || '')}</td>
          <td>${escapeHtml(formatDate(req.start_date))}</td>
          <td>${escapeHtml(formatDate(req.end_date))}</td>
          <td>${escapeHtml(req.days)}</td>
          <td>${escapeHtml(req.approved_by || '-')}</td>
          <td>${escapeHtml(req.approved_at ? formatDate(req.approved_at) : '-')}</td>
          <td>
            <button class="btn" onclick='viewRequestDetails(${requestIdArg})' style="padding: 0.5rem 1rem; font-size: 0.875rem;">View</button>
          </td>
        </tr>
      `;
    }).join('');
  } else if (tab === 'rejected') {
    tableRows = requests.map(req => {
      const requestId = String(req.id || '');
      const requestIdArg = escapeHtml(JSON.stringify(requestId));
      return `
        <tr>
          <td>${escapeHtml(requestId)}</td>
          <td>${escapeHtml(req.type || '')}</td>
          <td>${escapeHtml(formatDate(req.start_date))}</td>
          <td>${escapeHtml(formatDate(req.end_date))}</td>
          <td>${escapeHtml(req.days)}</td>
          <td>${escapeHtml(req.approved_by || '-')}</td>
          <td>${escapeHtml(req.manager_notes || 'No reason provided')}</td>
          <td>
            <button class="btn" onclick='viewRequestDetails(${requestIdArg})' style="padding: 0.5rem 1rem; font-size: 0.875rem;">View</button>
          </td>
        </tr>
      `;
    }).join('');
  }
  
  tableBody.innerHTML = tableRows;
}


function switchRequestTab(tabName) {
  // Hide all tab content
  const tabs = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => tab.style.display = 'none');
  
  // Remove active class from all buttons
  const buttons = document.querySelectorAll('.tab-btn');
  buttons.forEach(btn => btn.classList.remove('active'));
  
  // Show selected tab
  if (tabName === 'all') {
    document.getElementById('allRequestsTab').style.display = 'block';
    document.querySelector('[data-tab="all"]').classList.add('active');
  } else if (tabName === 'pending') {
    document.getElementById('pendingRequestsTab').style.display = 'block';
    document.querySelector('[data-tab="pending"]').classList.add('active');
  } else if (tabName === 'approved') {
    document.getElementById('approvedRequestsTab').style.display = 'block';
    document.querySelector('[data-tab="approved"]').classList.add('active');
  } else if (tabName === 'rejected') {
    document.getElementById('rejectedRequestsTab').style.display = 'block';
    document.querySelector('[data-tab="rejected"]').classList.add('active');
  }
}

async function loadAdminPendingRequests() {
  try {
    const response = await fetch(`${API_BASE}/pending-requests`, {
      headers: getAuthHeaders(),
      cache: 'no-store'
    });
    if (!response.ok) throw new Error('Failed to load pending requests');

    const requests = await response.json();
    const tableBody = document.getElementById('adminPendingTable');

    if (!tableBody) return;

    if (requests.length === 0) {
      tableBody.innerHTML = `
        <tr>
          <td colspan="8" style="text-align: center; color: #6b7280; padding: 2rem;">
            No pending requests
          </td>
        </tr>
      `;
      return;
    }

    tableBody.innerHTML = requests.map(req => {
      const requestId = String(req.id || '');
      const requestIdArg = escapeHtml(JSON.stringify(requestId));
      const hasAttachment = req.documents && req.documents.length > 0;
      const viewButton = hasAttachment
        ? '<button class="btn" onclick=\'viewRequestDetails(' + requestIdArg + ')\' style="padding: 0.5rem 1rem; font-size: 0.875rem; background: #93c5fd; color: #1e40af;">üìé View</button>'
        : '<button class="btn" onclick=\'viewRequestDetails(' + requestIdArg + ')\' style="padding: 0.5rem 1rem; font-size: 0.875rem; background: #d1d5db; color: #374151;">View</button>';

      return `
        <tr data-request-id="${escapeHtml(requestId)}">
          <td>${escapeHtml(requestId)}</td>
          <td>${escapeHtml(req.name || '-')} (${escapeHtml(req.employee_email || '-')})</td>
          <td>${escapeHtml(req.type || '')}</td>
          <td>${escapeHtml(formatDate(req.start_date))}</td>
          <td>${escapeHtml(formatDate(req.end_date))}</td>
          <td>${escapeHtml(req.days)}</td>
          <td>${escapeHtml(formatDate(req.submitted_at))}</td>
          <td>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
              ${viewButton}
              <button class="btn btn-success" onclick='approveRequest(${requestIdArg})' style="padding: 0.5rem 1rem; font-size: 0.875rem;">Approve</button>
              <button class="btn btn-danger" onclick='rejectRequest(${requestIdArg})' style="padding: 0.5rem 1rem; font-size: 0.875rem;">Reject</button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  } catch (error) {
    console.error('Error loading admin pending requests:', error);
    uiAlert('Failed to load pending requests');
  }
}

// ===== Pending Approvals (FIXED with Attachment Button) =====
async function loadPendingApprovals() {
  try {
    const tableBody = document.getElementById('pendingApprovalsTable');
    const titleEl = document.getElementById('approvalsTitle');
    const adminControls = document.getElementById('approvalsAdminControls');
    const summaryEl = document.getElementById('approvalsSummary');
    const headerEl = document.getElementById('pendingApprovalsHeader');
    const isAdminAccount = currentUser && (currentUser.role === 'admin' || currentUser.role === 'superadmin');

    if (isAdminAccount) {
      if (titleEl) titleEl.textContent = 'Approval History (Monthly)';
      if (adminControls) adminControls.style.display = 'flex';

      const monthInput = document.getElementById('approvalsHistoryMonth');
      const defaultMonth = getCurrentHktMonthValue();
      if (monthInput && !monthInput.value) monthInput.value = defaultMonth;
      const targetMonth = (monthInput && monthInput.value) ? monthInput.value : defaultMonth;

      if (headerEl) {
        headerEl.innerHTML = `
          <tr>
            <th>Request ID</th>
            <th>Employee</th>
            <th>Type</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Days</th>
            <th>Status</th>
            <th>Processed By</th>
            <th>Processed At</th>
            <th>Action</th>
          </tr>
        `;
      }

      const response = await fetch(`${API_BASE}/admin/approval-history-monthly?month=${encodeURIComponent(targetMonth)}&limit=1000`, {
        headers: getAuthHeaders()
      });
      if (!response.ok) throw new Error('Failed to load monthly approval history');

      const data = await response.json();
      const records = data.records || [];
      const approvedCount = records.filter(r => r.status === 'approved').length;
      const rejectedCount = records.filter(r => r.status === 'rejected').length;
      if (summaryEl) {
        summaryEl.style.display = 'flex';
        summaryEl.style.gap = '0.75rem';
        summaryEl.style.flexWrap = 'wrap';
        summaryEl.innerHTML =
          `<div style="padding: 0.5rem 0.75rem; background: #f3f4f6; border-radius: 0.5rem; font-weight: 600;">Total: ${records.length}</div>` +
          `<div style="padding: 0.5rem 0.75rem; background: #d1fae5; color: #065f46; border-radius: 0.5rem; font-weight: 600;">Approved: ${approvedCount}</div>` +
          `<div style="padding: 0.5rem 0.75rem; background: #fee2e2; color: #991b1b; border-radius: 0.5rem; font-weight: 600;">Rejected: ${rejectedCount}</div>`;
      }

      if (records.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="10" style="text-align: center; color: #6b7280; padding: 2rem;">
              No approval history for ${targetMonth}
            </td>
          </tr>
        `;
        return;
      }

      tableBody.innerHTML = records.map(req => {
        const requestId = String(req.id || '');
        const requestIdArg = escapeHtml(JSON.stringify(requestId));
        const canCancel = req.status === 'approved';
        const cancelBtn = canCancel
          ? `<button class="btn btn-danger" onclick='cancelApprovedLeaveByAdmin(${requestIdArg})' style="padding: 0.5rem 1rem; font-size: 0.875rem;">Cancel</button>`
          : '';

        return `
          <tr>
            <td>${escapeHtml(requestId)}</td>
            <td>${escapeHtml(req.employee_name || '-')} (${escapeHtml(req.employee_email || '-')})</td>
            <td>${escapeHtml(req.type || '')}</td>
            <td>${escapeHtml(formatDate(req.start_date))}</td>
            <td>${escapeHtml(formatDate(req.end_date))}</td>
            <td>${escapeHtml(req.days)}</td>
            <td>${getStatusBadge(req.status)}</td>
            <td>${escapeHtml(req.approved_by || '-')}</td>
            <td>${escapeHtml(req.approved_at ? formatDate(req.approved_at) : '-')}</td>
            <td>
              <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button class="btn" onclick='viewRequestDetails(${requestIdArg})' style="padding: 0.5rem 1rem; font-size: 0.875rem;">View</button>
                ${cancelBtn}
              </div>
            </td>
          </tr>
        `;
      }).join('');
      return;
    }

    if (titleEl) titleEl.textContent = 'Pending Approvals';
    if (adminControls) adminControls.style.display = 'none';
    if (summaryEl) summaryEl.style.display = 'none';
    if (headerEl) {
      headerEl.innerHTML = `
        <tr>
          <th>Request ID</th>
          <th>Employee</th>
          <th>Type</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Days</th>
          <th>Submitted</th>
          <th>Action</th>
        </tr>
      `;
    }

    const response = await fetch(`${API_BASE}/pending-requests`, {
      headers: getAuthHeaders(),
      cache: 'no-store'
    });
    if (!response.ok) throw new Error('Failed to load pending approvals');
    const requests = await response.json();

    if (requests.length === 0) {
      tableBody.innerHTML = `
        <tr>
          <td colspan="8" style="text-align: center; color: #6b7280; padding: 2rem;">
            No pending approvals
          </td>
        </tr>
      `;
      return;
    }

    const tableRows = requests.map(req => {
      const requestId = String(req.id || '');
      const requestIdArg = escapeHtml(JSON.stringify(requestId));
      const hasAttachment = req.documents && req.documents.length > 0;
      const viewButton = hasAttachment
        ? '<button class="btn" onclick=\'viewRequestDetails(' + requestIdArg + ')\' style="padding: 0.5rem 1rem; font-size: 0.875rem; background: #93c5fd; color: #1e40af;">üìé View</button>'
        : '<button class="btn" onclick=\'viewRequestDetails(' + requestIdArg + ')\' style="padding: 0.5rem 1rem; font-size: 0.875rem; background: #d1d5db; color: #374151;">View</button>';

      return `
        <tr data-request-id="${escapeHtml(requestId)}">
          <td>${escapeHtml(requestId)}</td>
          <td>${escapeHtml(req.name || '-')} (${escapeHtml(req.employee_email || '-')})</td>
          <td>${escapeHtml(req.type || '')}</td>
          <td>${escapeHtml(formatDate(req.start_date))}</td>
          <td>${escapeHtml(formatDate(req.end_date))}</td>
          <td>${escapeHtml(req.days)}</td>
          <td>${escapeHtml(formatDate(req.submitted_at))}</td>
          <td>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
              ${viewButton}
              <button class="btn btn-success" onclick='approveRequest(${requestIdArg})' style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                Approve
              </button>
              <button class="btn btn-danger" onclick='rejectRequest(${requestIdArg})' style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                Reject
              </button>
            </div>
          </td>
        </tr>
      `;
    }).join('');

    tableBody.innerHTML = tableRows;
  } catch (error) {
    console.error('Error loading pending approvals:', error);
    await uiAlert('Failed to load approvals data');
  }
}


async function approveRequest(requestId) {
  const notes = await uiPrompt('Approval notes (optional):', { title: 'Approve Request' });
  if (notes === null) return; // User cancelled
  
  try {
    const response = await fetch(`${API_BASE}/leave-requests/${requestId}`, {
      method: 'PATCH',
      headers: getAuthHeaders(),
      body: JSON.stringify({
        action: 'approve',
        managerNotes: notes
      })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      await uiAlert(data.error || 'Failed to approve request');
      return;
    }
    
    removeProcessedRequestRow(requestId);
    await uiAlert('Request approved successfully!');
    await refreshApprovalViews(requestId);
    
  } catch (error) {
    console.error('Error approving request:', error);
    await uiAlert('Failed to approve request. Please try again.');
  }
}

async function rejectRequest(requestId) {
  const notes = await uiPrompt('Rejection reason (required):', { title: 'Reject Request' });
  if (!notes || notes.trim() === '') {
    await uiAlert('Rejection reason is required');
    return;
  }
  
  try {
    const response = await fetch(`${API_BASE}/leave-requests/${requestId}`, {
      method: 'PATCH',
      headers: getAuthHeaders(),
      body: JSON.stringify({
        action: 'reject',
        managerNotes: notes
      })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      await uiAlert(data.error || 'Failed to reject request');
      return;
    }
    
    removeProcessedRequestRow(requestId);
    await uiAlert('Request rejected');
    await refreshApprovalViews(requestId);
    
  } catch (error) {
    console.error('Error rejecting request:', error);
    await uiAlert('Failed to reject request. Please try again.');
  }
}

function removeProcessedRequestRow(requestId) {
  const pendingTables = ['pendingApprovalsTable', 'adminPendingTable'];
  pendingTables.forEach((tableId) => {
    const tableBody = document.getElementById(tableId);
    if (!tableBody) return;

    const rows = Array.from(tableBody.querySelectorAll('tr'));
    rows.forEach((row) => {
      const byDataset = String(row.getAttribute('data-request-id') || '').trim();
      const firstCell = row.querySelector('td');
      const byFirstCell = firstCell ? String(firstCell.textContent || '').trim() : '';
      if (byDataset === String(requestId) || byFirstCell === String(requestId)) {
        row.remove();
      }
    });

    const hasDataRows = Array.from(tableBody.querySelectorAll('tr')).some((row) => {
      const cell = row.querySelector('td');
      return cell && (cell.getAttribute('colspan') === null || cell.getAttribute('colspan') === '1');
    });

    if (!hasDataRows) {
      tableBody.innerHTML = `
        <tr>
          <td colspan="8" style="text-align: center; color: #6b7280; padding: 2rem;">
            No pending requests
          </td>
        </tr>
      `;
    }
  });
}

async function refreshApprovalViews(processedRequestId) {
  if (processedRequestId) {
    removeProcessedRequestRow(processedRequestId);
  }

  // Force refresh in case DOM state is stale or a page isn't currently visible.
  try {
    await Promise.all([
      loadAdminPendingRequests(),
      loadPendingApprovals(),
      loadRecentRequests()
    ]);
  } catch (_) {
    // best-effort refresh
  }
}

// ===== View Request Details (FIXED with Multiple Attachments) =====
async function viewRequestDetails(requestId) {
  try {
    const response = await fetch(`${API_BASE}/leave-requests/${requestId}`, {
      headers: getAuthHeaders()
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Failed to load request details');
    }
    
    const request = await response.json();
    
    const content = document.getElementById('requestDetailsContent');
    
    // Build remarks section
    const remarksSection = request.remarks 
      ? '<div><div style="font-weight: 600; color: #6b7280; font-size: 0.875rem;">Remarks</div><div style="padding: 0.75rem; background: #f3f4f6; border-radius: 0.5rem;">' + escapeHtml(request.remarks) + '</div></div>'
      : '';
    
    // Build manager notes section
    const managerNotesSection = request.manager_notes
      ? '<div><div style="font-weight: 600; color: #6b7280; font-size: 0.875rem;">Manager Notes</div><div style="padding: 0.75rem; background: #f3f4f6; border-radius: 0.5rem;">' + escapeHtml(request.manager_notes) + '</div></div>'
      : '';
    
    // Build approved/rejected by section
    const approverSection = request.approved_by
      ? '<div><div style="font-weight: 600; color: #6b7280; font-size: 0.875rem;">' + (request.status === 'approved' ? 'Approved By' : 'Rejected By') + '</div><div>' + escapeHtml(request.approved_by) + '</div><div style="color: #6b7280; font-size: 0.875rem;">' + escapeHtml(formatDate(request.approved_at)) + '</div></div>'
      : '';

    let remainingBalanceSection = '';
    if (request.remaining_balance_for_type !== null && request.remaining_balance_for_type !== undefined) {
      const remaining = Number(request.remaining_balance_for_type) || 0;
      const remainingColor = remaining < 0 ? '#dc2626' : '#0F766E';
      let detailText = '';
      if (request.type === 'AL' && request.remaining_balance_breakdown) {
        const regular = Number(request.remaining_balance_breakdown.regular) || 0;
        const carryOver = Number(request.remaining_balance_breakdown.carryOver) || 0;
        detailText = `<div style="color: #6b7280; font-size: 0.8rem; margin-top: 0.35rem;">Regular AL: ${formatBalanceDisplay(regular)}, Carry Over: ${formatBalanceDisplay(carryOver)}</div>`;
      }
      remainingBalanceSection =
        '<div>' +
        '<div style="font-weight: 600; color: #6b7280; font-size: 0.875rem;">Remaining Balance (' + escapeHtml(request.type || '') + ')</div>' +
        '<div style="font-size: 1.125rem; font-weight: 700; color: ' + remainingColor + ';">' + formatBalanceDisplay(remaining) + '</div>' +
        detailText +
        '</div>';
    }
    
    // Build attachments section - FIXED for multiple files
    let attachmentsSection = '';
    if (request.documents && request.documents.length > 0) {
      let attachmentButtonsHTML = '';
      
      // Loop through each document
      for (let i = 0; i < request.documents.length; i++) {
        const doc = request.documents[i];
        const sizeKB = (doc.size / 1024).toFixed(1);
        const onClick = escapeHtml(`downloadDocument(${JSON.stringify(request.id || '')}, ${JSON.stringify(doc.storedName || '')}, ${JSON.stringify(doc.originalName || '')})`);
        
        attachmentButtonsHTML += 
          '<button onclick=\'' + onClick + '\' ' +
          'style="background: #f3f4f6; border: 1px solid #e5e7eb; padding: 0.5rem 0.75rem; border-radius: 0.375rem; ' +
          'cursor: pointer; text-align: left; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem; ' +
          'transition: background 0.2s; width: 100%;" ' +
          'onmouseover="this.style.background=\'#e5e7eb\'" onmouseout="this.style.background=\'#f3f4f6\'">' +
          '<span style="color: #0F766E;">üìé</span>' +
          '<span style="color: #374151;">' + escapeHtml(doc.originalName || '-') + '</span>' +
          '<span style="color: #6b7280; margin-left: auto;">(' + sizeKB + ' KB)</span>' +
          '</button>';
      }
      
      attachmentsSection = 
        '<div>' +
        '<div style="font-weight: 600; color: #6b7280; font-size: 0.875rem; margin-bottom: 0.5rem;">Attachments (' + request.documents.length + ' file' + (request.documents.length > 1 ? 's' : '') + ')</div>' +
        '<div style="display: flex; flex-direction: column; gap: 0.5rem;">' +
        attachmentButtonsHTML +
        '</div>' +
        '</div>';
    }
    
    content.innerHTML = 
      '<div style="display: grid; gap: 1rem;">' +
      '<div>' +
      '<div style="font-weight: 600; color: #6b7280; font-size: 0.875rem;">Request ID</div>' +
      '<div style="font-size: 1.125rem;">' + escapeHtml(request.id || '') + '</div>' +
      '</div>' +
      '<div>' +
      '<div style="font-weight: 600; color: #6b7280; font-size: 0.875rem;">Leave Type</div>' +
      '<div style="font-size: 1.125rem;">' + escapeHtml(getLeaveTypeName(request.type)) + '</div>' +
      '</div>' +
      '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">' +
      '<div>' +
      '<div style="font-weight: 600; color: #6b7280; font-size: 0.875rem;">Start Date</div>' +
      '<div>' + escapeHtml(formatDate(request.start_date)) + '</div>' +
      '<div style="color: #6b7280; font-size: 0.875rem;">' + escapeHtml(request.start_duration_type !== 'FULL' ? request.start_duration_type : '') + '</div>' +
      '</div>' +
      '<div>' +
      '<div style="font-weight: 600; color: #6b7280; font-size: 0.875rem;">End Date</div>' +
      '<div>' + escapeHtml(formatDate(request.end_date)) + '</div>' +
      '<div style="color: #6b7280; font-size: 0.875rem;">' + escapeHtml(request.end_duration_type !== 'FULL' ? request.end_duration_type : '') + '</div>' +
      '</div>' +
      '</div>' +
      '<div>' +
      '<div style="font-weight: 600; color: #6b7280; font-size: 0.875rem;">Total Days</div>' +
      '<div style="font-size: 1.5rem; font-weight: 700; color: #0F766E;">' + escapeHtml(request.days) + '</div>' +
      '</div>' +
      '<div>' +
      '<div style="font-weight: 600; color: #6b7280; font-size: 0.875rem;">Status</div>' +
      '<div>' + getStatusBadge(request.status) + '</div>' +
      '</div>' +
      remainingBalanceSection +
      remarksSection +
      managerNotesSection +
      approverSection +
      attachmentsSection +
      '<div>' +
      '<div style="font-weight: 600; color: #6b7280; font-size: 0.875rem;">Submitted</div>' +
      '<div>' + escapeHtml(formatDate(request.submitted_at)) + '</div>' +
      '</div>' +
      '</div>';
    
    openModal('requestDetailsModal');
    
  } catch (error) {
    console.error('Error loading request details:', error);
    await uiAlert(error.message || 'Failed to load request details. Please try again.');
  }
}


// ===== Utility Functions =====
function formatDate(dateStr) {
  if (!dateStr) return '-';
  const ymd = dateOnly(dateStr);
  const date = ymd ? new Date(`${ymd}T00:00:00+08:00`) : new Date(dateStr);
  if (!date || Number.isNaN(date.getTime())) return String(dateStr);
  return date.toLocaleDateString('en-GB', {
    timeZone: HKT_TIMEZONE,
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}

function getStatusBadge(status) {
  const badges = {
    'pending': '<span class="status-badge status-pending">Pending</span>',
    'approved': '<span class="status-badge status-approved">Approved</span>',
    'rejected': '<span class="status-badge status-rejected">Rejected</span>'
  };
  return badges[status] || escapeHtml(status);
}

function getLeaveTypeName(type) {
  const types = {
    'AL': 'Annual Leave',
    'BL': 'Birthday Leave',
    'CL': 'Casual Leave',
    'CPL': 'Compensation Leave',
    'DC': 'Doctor Consultation',
    'ML': 'Maternity Leave',
    'PL': 'Paternity Leave',
    'SL': 'Sick Leave',
    'OTHER': 'Others'
  };
  return types[type] || type;
}

function formatBalanceDisplay(value) {
  const num = Number(value);
  if (!Number.isFinite(num)) return '-';
  if (Math.abs(num - Math.round(num)) < 0.0001) return String(Math.round(num));
  return num.toFixed(1);
}

// ===== Modal Functions =====
function openModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.add('active');
  }
}

function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.remove('active');
  }
}

// Close modal when clicking outside
window.addEventListener('click', (e) => {
  if (e.target.classList.contains('modal')) {
    if (e.target.id === 'leaveSubmitProcessingModal') {
      return;
    }
    if (e.target.id === 'uiDialogModal') {
      const cancelBtn = document.getElementById('uiDialogCancel');
      const okBtn = document.getElementById('uiDialogOk');
      if (cancelBtn && cancelBtn.style.display !== 'none') cancelBtn.click();
      else if (okBtn) okBtn.click();
      return;
    }
    e.target.classList.remove('active');
  }
});

// Change password submit handler
const changePasswordForm = document.getElementById('changePasswordForm');
if (changePasswordForm) {
  changePasswordForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const currentPassword = document.getElementById('currentPasswordInput').value;
    const newPassword = document.getElementById('newPasswordInput').value;
    const confirmPassword = document.getElementById('confirmNewPasswordInput').value;

    if (!currentPassword || !newPassword || !confirmPassword) {
      await uiAlert('Please fill all password fields.');
      return;
    }

    if (newPassword.length < 6) {
      await uiAlert('New password must be at least 6 characters.');
      return;
    }

    if (newPassword !== confirmPassword) {
      await uiAlert('New password and confirmation do not match.');
      return;
    }

    try {
      const response = await fetch(`${API_BASE}/change-password`, {
        method: 'POST',
        headers: getAuthHeaders(),
        body: JSON.stringify({ currentPassword, newPassword })
      });
      const result = await response.json();
      if (!response.ok) {
        await uiAlert(result.error || 'Failed to change password.');
        return;
      }

      await uiAlert('Password updated successfully.', 'Success');
      closeModal('changePasswordModal');
    } catch (error) {
      console.error('Change password error:', error);
      await uiAlert('Failed to change password. Please try again.');
    }
  });
}

// ===== Mini Calendar for Leave Form =====
async function updateMiniCalendar() {
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  const startDuration = document.getElementById('startDurationType').value;
  const endDuration = document.getElementById('endDurationType').value;
  
  const container = document.getElementById('miniCalendarContainer');
  
  if (!container) return; // Exit if element doesn't exist
  
  if (!startDate || !endDate) {
    container.innerHTML = `
      <div style="text-align: center; color: #6b7280; padding: 2rem; font-size: 0.875rem;">
        Select start and end dates to preview your leave period
      </div>
    `;
    return;
  }
  
  const start = new Date(startDate + 'T00:00:00');
  const end = new Date(endDate + 'T00:00:00');
  
  if (end < start) {
    container.innerHTML = `
      <div style="text-align: center; color: #dc2626; padding: 2rem; font-size: 0.875rem;">
        ‚ö†Ô∏è End date must be after start date
      </div>
    `;
    return;
  }
  
  const dates = [];
  let current = new Date(start);
  while (current <= end) {
    dates.push(new Date(current));
    current.setDate(current.getDate() + 1);
  }
  
  // Load holidays if not already loaded
  if (!window.holidayDates || window.holidayDates.length === 0) {
    try {
      const response = await fetch(`${API_BASE}/holidays`, {
        headers: getAuthHeaders()
      });
      window.holidayDates = await response.json();
    } catch (e) {
      console.error('Failed to load holidays:', e);
      window.holidayDates = [];
    }
  }
  
  let html = '<div style="display: grid; gap: 0.25rem;">';
  const holidaySet = new Set((window.holidayDates || []).map(h => dateOnly(h.date)).filter(Boolean));
  
  dates.forEach((date, index) => {
    const dateStr = formatLocalDateYMD(date);
    const dayOfWeek = date.getDay();
    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
    
    const isHoliday = holidaySet.has(dateStr);
    
    const isStart = index === 0;
    const isEnd = index === dates.length - 1;
    
    let bgColor = '#fff';
    let textColor = '#111827';
    let label = '';
    
    if (isWeekend || isHoliday) {
      bgColor = '#fee2e2';
      textColor = '#991b1b';
      if (isHoliday) {
        const holiday = window.holidayDates.find(h => {
          return dateOnly(h.date) === dateStr;
        });
        label = `(Holiday)`;
      } else {
        label = '(Weekend)';
      }
    } else {
      if ((isStart && startDuration !== 'FULL') || (isEnd && endDuration !== 'FULL')) {
        bgColor = '#BFDBFE';
        textColor = '#0F4C81';
        label = isStart ? `(${startDuration})` : `(${endDuration})`;
      } else {
        bgColor = '#0F766E';
        textColor = 'white';
      }
    }
    
    const dayName = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][dayOfWeek];
    const dateDisplay = date.toLocaleDateString('en-GB', { timeZone: HKT_TIMEZONE, day: '2-digit', month: 'short' });
    
    html += `
      <div style="
        background: ${bgColor}; 
        color: ${textColor}; 
        padding: 0.75rem; 
        border-radius: 0.375rem; 
        border: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.875rem;
      ">
        <div>
          <strong>${dayName}</strong> ${dateDisplay}
        </div>
        <div style="font-size: 0.75rem; opacity: 0.9;">
          ${label}
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  // Get values directly from the left panel
  const totalCalendarDays = dates.length;
  
  html += `
    <div style="margin-top: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 0.375rem; font-size: 0.875rem;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
        <span style="color: #6b7280;">Total Calendar Days:</span>
        <strong>${totalCalendarDays}</strong>
      </div>
      <div style="display: flex; justify-content: space-between;">
        <span style="color: #6b7280;">Total Working Days:</span>
        <strong style="color: #0F766E;" id="miniCalendarWorkingDays">0</strong>
      </div>
    </div>
  `;
  
  container.innerHTML = html;
  
  // NOW sync the working days value from the main display
  const workingDaysValue = document.getElementById('daysPreview').textContent;
  const miniWorkingDays = document.getElementById('miniCalendarWorkingDays');
  if (miniWorkingDays) {
    miniWorkingDays.textContent = workingDaysValue;
  }
}



// ===== Download Document with Authentication =====
async function downloadDocument(requestId, storedName, originalName) {
  try {
    const token = localStorage.getItem('token');
    const requestIdPath = encodeURIComponent(String(requestId || ''));
    const storedNamePath = encodeURIComponent(String(storedName || ''));
    
    const response = await fetch(`${API_BASE}/leave-requests/${requestIdPath}/documents/${storedNamePath}`, {
      headers: {
        'Authorization': token ? `Bearer ${token}` : ''
      }
    });
    
    if (!response.ok) {
      throw new Error('Failed to download file');
    }
    
    // Get the file as a blob
    const blob = await response.blob();
    
    // Create a temporary URL for the blob
    const url = window.URL.createObjectURL(blob);
    
    // Create a temporary link and trigger download
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = originalName || 'download';
    document.body.appendChild(a);
    a.click();
    
    // Cleanup
    setTimeout(() => {
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }, 100);
    
  } catch (error) {
    console.error('Download error:', error);
    await uiAlert('Failed to download file. Please try again.');
  }
}



// ===== Employee Management Functions =====
function setEmployeeImportStatus(message, type = 'info') {
  const statusEl = document.getElementById('employeeImportStatus');
  if (!statusEl) return;
  statusEl.style.display = 'block';
  statusEl.textContent = message || '';
  if (type === 'success') {
    statusEl.style.background = '#d1fae5';
    statusEl.style.color = '#065f46';
    statusEl.style.border = '1px solid #86efac';
  } else if (type === 'error') {
    statusEl.style.background = '#fee2e2';
    statusEl.style.color = '#991b1b';
    statusEl.style.border = '1px solid #fecaca';
  } else if (type === 'warn') {
    statusEl.style.background = '#EFF6FF';
    statusEl.style.color = '#0F4C81';
    statusEl.style.border = '1px solid #93C5FD';
  } else {
    statusEl.style.background = '#eff6ff';
    statusEl.style.color = '#1e40af';
    statusEl.style.border = '1px solid #bfdbfe';
  }
}

function setEmployeeImportBusy(isBusy) {
  employeeImportInProgress = isBusy;
  const importBtn = document.getElementById('employeeImportBtn');
  const fileInput = document.getElementById('employeeImportFile');
  const modeSelect = document.getElementById('employeeImportMode');
  if (importBtn) {
    importBtn.disabled = isBusy;
    importBtn.textContent = isBusy ? 'Importing...' : 'Import CSV';
  }
  if (fileInput) fileInput.disabled = isBusy;
  if (modeSelect) modeSelect.disabled = isBusy;
}

function normalizeCsvHeader(header) {
  return String(header || '')
    .replace(/^\ufeff/, '')
    .trim()
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '_')
    .replace(/^_+|_+$/g, '');
}

function parseCsvText(csvText) {
  const rows = [];
  let row = [];
  let cell = '';
  let inQuotes = false;
  const text = String(csvText || '');

  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    const next = text[i + 1];

    if (ch === '"') {
      if (inQuotes && next === '"') {
        cell += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
      continue;
    }

    if (!inQuotes && ch === ',') {
      row.push(cell);
      cell = '';
      continue;
    }

    if (!inQuotes && (ch === '\n' || ch === '\r')) {
      row.push(cell);
      cell = '';
      if (row.some(v => String(v || '').trim() !== '')) {
        rows.push(row);
      }
      row = [];
      if (ch === '\r' && next === '\n') i++;
      continue;
    }

    cell += ch;
  }

  row.push(cell);
  if (row.some(v => String(v || '').trim() !== '')) {
    rows.push(row);
  }

  if (rows.length === 0) {
    return { headers: [], records: [] };
  }

  const headers = rows[0].map(normalizeCsvHeader);
  const records = rows.slice(1).map((line) => {
    const record = {};
    headers.forEach((h, idx) => {
      if (!h) return;
      record[h] = String(line[idx] || '').trim();
    });
    return record;
  });

  return { headers, records };
}

function getCsvValue(row, aliases) {
  for (let i = 0; i < aliases.length; i++) {
    const key = normalizeCsvHeader(aliases[i]);
    if (Object.prototype.hasOwnProperty.call(row, key) && row[key] !== '') {
      return row[key];
    }
  }
  return '';
}

function parseOptionalNumber(value, fallbackValue = undefined) {
  const text = String(value || '').trim();
  if (text === '') return fallbackValue;
  const n = Number(text);
  if (Number.isNaN(n)) throw new Error(`Invalid number: "${text}"`);
  return n;
}

function parseOfficeFlag(row, fallbackLocation = '') {
  const rawOffice = getCsvValue(row, ['is_office_staff', 'office_staff']);
  if (rawOffice) {
    const text = rawOffice.toLowerCase();
    if (['true', '1', 'yes', 'y', 'office'].includes(text)) return true;
    if (['false', '0', 'no', 'n', 'retail'].includes(text)) return false;
  }
  const rawType = getCsvValue(row, ['type', 'employee_type']);
  if (rawType) {
    const t = rawType.toLowerCase();
    if (t.includes('retail')) return false;
    if (t.includes('office')) return true;
  }
  return !String(fallbackLocation || '').toLowerCase().includes('retail');
}

function normalizeImportRole(roleValue, existingRole = 'employee') {
  const role = String(roleValue || '').trim().toLowerCase();
  if (!role) return existingRole || 'employee';
  if (role === 'manager') return 'approver';
  if (role === 'approver') return 'approver';
  if (role === 'employee') return 'employee';
  if (role === 'admin') return 'admin';
  return existingRole || 'employee';
}

function normalizeDateYMD(value, fallback = '') {
  const text = String(value || '').trim();
  if (!text) return fallback;
  const m = text.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (!m) throw new Error(`Invalid date format: "${text}" (expected YYYY-MM-DD)`);
  return text;
}

const employeeImportColumns = [
  'mode',
  'email',
  'name',
  'staff_code',
  'role',
  'department',
  'location',
  'approver_email',
  'type',
  'hire_date',
  'annual_leave_base',
  'balance_al',
  'balance_al_carry_over',
  'balance_bl',
  'balance_cl',
  'balance_cpl',
  'balance_dc',
  'balance_ml',
  'balance_pl',
  'balance_sl',
  'carry_over_reset_month'
];

function buildEmployeeImportTemplateCsv() {
  return [
    employeeImportColumns.join(','),
    'add,jane@example.com,Sample User,OF099,employee,Sales,HQ,john@example.com,office,2026-01-15,14,,,,,,,,,,10',
    'edit,jane@example.com,Sample User,OF099,approver,Sales,HQ,leave@example.com,office,2026-01-15,14,12,2,1,0,0,0,0,0,0,10'
  ].join('\n');
}

function downloadEmployeeImportTemplate() {
  const csv = buildEmployeeImportTemplateCsv();
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'employee_import_template.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function csvEscape(value) {
  const text = String(value === null || value === undefined ? '' : value);
  if (/[",\r\n]/.test(text)) {
    return `"${text.replace(/"/g, '""')}"`;
  }
  return text;
}

function buildStaffInfoCsv(rows) {
  const lines = [employeeImportColumns.map(csvEscape).join(',')];
  (rows || []).forEach((emp) => {
    const approverEmail = emp.is_office_staff ? (emp.manager_email || '') : (emp.supervisor_email || emp.manager_email || '');
    const row = {
      mode: 'edit',
      email: emp.email || '',
      name: emp.name || '',
      staff_code: emp.staff_code || '',
      role: emp.role || '',
      department: emp.department || '',
      location: emp.location || '',
      approver_email: approverEmail,
      type: emp.is_office_staff ? 'office' : 'retail',
      hire_date: dateOnly(emp.hire_date) || emp.hire_date || '',
      annual_leave_base: emp.annual_leave_base ?? '',
      balance_al: emp.balance_al ?? '',
      balance_al_carry_over: emp.balance_al_carry_over ?? '',
      balance_bl: emp.balance_bl ?? '',
      balance_cl: emp.balance_cl ?? '',
      balance_cpl: emp.balance_cpl ?? '',
      balance_dc: emp.balance_dc ?? '',
      balance_ml: emp.balance_ml ?? '',
      balance_pl: emp.balance_pl ?? '',
      balance_sl: emp.balance_sl ?? '',
      carry_over_reset_month: emp.carry_over_reset_month ?? ''
    };
    lines.push(employeeImportColumns.map((col) => csvEscape(row[col])).join(','));
  });
  return lines.join('\r\n');
}

async function exportAllStaffInfoCsv() {
  try {
    const response = await fetch(`${API_BASE}/admin/employees`, {
      headers: getAuthHeaders()
    });
    if (!response.ok) {
      throw new Error('Failed to load employee data');
    }

    const employees = await response.json();
    const csv = buildStaffInfoCsv(employees);
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const stamp = formatLocalDateYMD(new Date()).replace(/-/g, '');
    a.href = url;
    a.download = `staff-directory-${stamp}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  } catch (error) {
    console.error('Export all staff info error:', error);
    await uiAlert('Failed to export staff info. Please try again.');
  }
}

async function importEmployeesFromCsv() {
  if (employeeImportInProgress) return;

  const fileInput = document.getElementById('employeeImportFile');
  const modeSelect = document.getElementById('employeeImportMode');
  const file = fileInput && fileInput.files && fileInput.files[0];
  const defaultMode = modeSelect ? modeSelect.value : 'add';

  if (!file) {
    await uiAlert('Please select a CSV file first.');
    return;
  }

  if (!(await uiConfirm(`Import employees in "${defaultMode}" mode now?`))) {
    return;
  }

  try {
    setEmployeeImportBusy(true);
    setEmployeeImportStatus('Reading CSV file...', 'info');

    const csvText = await file.text();
    const parsed = parseCsvText(csvText);
    const records = parsed.records || [];
    if (records.length === 0) {
      setEmployeeImportStatus('No data rows found in CSV.', 'error');
      return;
    }

    if (!employeeManagementData || employeeManagementData.length === 0) {
      await loadEmployeeManagement();
    }

    const existingMap = new Map(
      (employeeManagementData || []).map(emp => [String(emp.email || '').toLowerCase(), emp])
    );

    const results = {
      total: records.length,
      added: 0,
      edited: 0,
      failed: 0,
      errors: []
    };

    for (let i = 0; i < records.length; i++) {
      const row = records[i];
      const rowNum = i + 2;
      setEmployeeImportStatus(`Processing row ${rowNum} of ${records.length + 1}...`, 'info');

      try {
        const email = getCsvValue(row, ['email']).toLowerCase();
        if (!email) throw new Error('email is required');

        const rowModeText = getCsvValue(row, ['mode', 'action']).toLowerCase();
        const mode = rowModeText === 'add' || rowModeText === 'edit' ? rowModeText : defaultMode;
        const existing = existingMap.get(email);

        if (mode === 'add') {
          if (existing) throw new Error('employee already exists');

          const name = getCsvValue(row, ['name']);
          const staffCode = getCsvValue(row, ['staff_code', 'staffcode']);
          const hireDate = normalizeDateYMD(getCsvValue(row, ['hire_date', 'join_date', 'joined_date']));
          const role = normalizeImportRole(getCsvValue(row, ['role']), 'employee');
          const department = getCsvValue(row, ['department']);
          const location = getCsvValue(row, ['location']);
          const managerEmail = getCsvValue(row, ['approver_email', 'manager_email', 'manager']);
          const annualLeaveBase = parseOptionalNumber(getCsvValue(row, ['annual_leave_base', 'al_base']), 13);
          const isOfficeStaff = parseOfficeFlag(row, location);

          if (!name) throw new Error('name is required for add');
          if (!staffCode) throw new Error('staff_code is required for add');
          if (!hireDate) throw new Error('hire_date is required for add');

          const payload = {
            email,
            name,
            staffCode,
            role,
            department,
            location,
            managerEmail: managerEmail || null,
            isOfficeStaff,
            hireDate,
            annualLeaveBase
          };

          const resp = await fetch(`${API_BASE}/admin/employees`, {
            method: 'POST',
            headers: getAuthHeaders(),
            body: JSON.stringify(payload)
          });
          const data = await resp.json();
          if (!resp.ok) throw new Error(data.error || 'failed to add');

          results.added++;
          existingMap.set(email, { ...payload, email, is_inactive: false });
          continue;
        }

        if (!existing) throw new Error('employee does not exist for edit');

        const name = getCsvValue(row, ['name']) || existing.name || '';
        if (!name) throw new Error('name is required for edit');

        const payload = {
          name,
          department: getCsvValue(row, ['department']) || existing.department || '',
          managerEmail: getCsvValue(row, ['approver_email', 'manager_email', 'manager']) || existing.manager_email || '',
          location: getCsvValue(row, ['location']) || existing.location || '',
          staffCode: getCsvValue(row, ['staff_code', 'staffcode']) || existing.staff_code || '',
          role: normalizeImportRole(getCsvValue(row, ['role']), existing.role || 'employee'),
          isOfficeStaff: parseOfficeFlag(row, getCsvValue(row, ['location']) || existing.location || ''),
          hireDate: normalizeDateYMD(getCsvValue(row, ['hire_date', 'join_date', 'joined_date']), existing.hire_date || ''),
          annualLeaveBase: parseOptionalNumber(getCsvValue(row, ['annual_leave_base', 'al_base']), existing.annual_leave_base || 13),
          carryOverResetMonth: parseOptionalNumber(getCsvValue(row, ['carry_over_reset_month']), existing.carry_over_reset_month || 10),
          balanceAl: parseOptionalNumber(getCsvValue(row, ['balance_al']), existing.balance_al || 0),
          balanceAlCarryOver: parseOptionalNumber(getCsvValue(row, ['balance_al_carry_over']), existing.balance_al_carry_over || 0),
          balanceBl: parseOptionalNumber(getCsvValue(row, ['balance_bl']), existing.balance_bl || 0),
          balanceCl: parseOptionalNumber(getCsvValue(row, ['balance_cl']), existing.balance_cl || 0),
          balanceCpl: parseOptionalNumber(getCsvValue(row, ['balance_cpl']), existing.balance_cpl || 0),
          balanceDc: parseOptionalNumber(getCsvValue(row, ['balance_dc']), existing.balance_dc || 0),
          balanceMl: parseOptionalNumber(getCsvValue(row, ['balance_ml']), existing.balance_ml || 0),
          balancePl: parseOptionalNumber(getCsvValue(row, ['balance_pl']), existing.balance_pl || 0),
          balanceSl: parseOptionalNumber(getCsvValue(row, ['balance_sl']), existing.balance_sl || 0),
          recalculateAL: false
        };

        const resp = await fetch(`${API_BASE}/admin/employees/${encodeURIComponent(email)}`, {
          method: 'PUT',
          headers: getAuthHeaders(),
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'failed to edit');

        results.edited++;
      } catch (rowErr) {
        results.failed++;
        results.errors.push(`Row ${rowNum}: ${rowErr.message}`);
      }
    }

    await loadEmployeeManagement();

    const summary = `Import done. Added: ${results.added}, Edited: ${results.edited}, Failed: ${results.failed}, Total: ${results.total}.`;
    if (results.failed > 0) {
      setEmployeeImportStatus(summary, 'warn');
      const errorPreview = results.errors.slice(0, 10).join('\n');
      const moreText = results.errors.length > 10 ? `\n...and ${results.errors.length - 10} more error(s).` : '';
      await uiAlert(`${summary}\n\n${errorPreview}${moreText}`, 'Import Completed with Errors');
    } else {
      setEmployeeImportStatus(summary, 'success');
      await uiAlert(summary, 'Import Completed');
    }
  } catch (error) {
    console.error('Import employees CSV error:', error);
    setEmployeeImportStatus(`Import failed: ${error.message}`, 'error');
    await uiAlert('Failed to import CSV. Please check file format and try again.');
  } finally {
    setEmployeeImportBusy(false);
  }
}

async function loadEmployeeManagement() {
  try {
    const response = await fetch(`${API_BASE}/admin/employees`, {
      headers: getAuthHeaders()
    });
    
    if (!response.ok) {
      throw new Error('Failed to load employees');
    }
    
    employeeManagementData = await response.json();
    filterEmployeeManagementTable();
    
  } catch (error) {
    console.error('Error loading employees:', error);
    const tableBody = document.getElementById('employeeListTable');
    if (tableBody) {
      tableBody.innerHTML = 
        '<tr>' +
        '<td colspan="11" style="text-align: center; color: #dc2626; padding: 2rem;">' +
        'Failed to load employee list. Please try again.' +
        '</td>' +
        '</tr>';
    }
  }
}

function filterEmployeeManagementTable() {
  const input = document.getElementById('employeeSearchInput');
  const term = input ? input.value.trim().toLowerCase() : '';
  const filtered = !term
    ? employeeManagementData
    : employeeManagementData.filter(emp => String(emp.name || '').toLowerCase().includes(term));
  renderEmployeeManagementRows(filtered);
}

function renderEmployeeManagementRows(employees) {
  const tableBody = document.getElementById('employeeListTable');
  if (!tableBody) {
    console.error('Table body element not found!');
    return;
  }

  if (!employees || employees.length === 0) {
    tableBody.innerHTML =
      '<tr>' +
      '<td colspan="11" style="text-align: center; color: #6b7280; padding: 2rem;">' +
      'No employees found' +
      '</td>' +
      '</tr>';
    return;
  }

  let tableHTML = '';
  for (let i = 0; i < employees.length; i++) {
    const emp = employees[i];
    const safeEmail = String(emp.email || '');
    const emailArg = escapeHtml(JSON.stringify(safeEmail));
    const safeStaffCode = escapeHtml(emp.staff_code || '-');
    const safeName = escapeHtml(emp.name || '-');
    const safeDepartment = escapeHtml(emp.department || '-');
    const safeRole = escapeHtml(emp.role || '-');
    const safeAnnualLeaveBase = Number(emp.annual_leave_base ?? 13);
    const safeBalanceAl = Number(emp.balance_al ?? 0);
    const safeBalanceCarry = Number(emp.balance_al_carry_over ?? 0);
    const safeBalanceSl = Number(emp.balance_sl ?? 0);

    const statusBadge = emp.is_inactive
      ? '<span class="status-badge status-rejected">Inactive</span>'
      : '<span class="status-badge status-approved">Active</span>';

    const typeBadge = emp.is_office_staff
      ? '<span style="padding: 0.25rem 0.5rem; background: #dcfce7; color: #166534; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">Office</span>'
      : '<span style="padding: 0.25rem 0.5rem; background: #ffedd5; color: #9a3412; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">Retail</span>';

    const editBtn = "<button class=\"btn\" onclick='openEditEmployeeModal(" + emailArg + ")' style=\"padding: 0.5rem 1rem; font-size: 0.875rem; background: #3b82f6; color: white;\">Edit</button>";
    const resetPwdBtn = isSuperAdmin()
      ? "<button class=\"btn\" onclick='resetEmployeePassword(" + emailArg + ")' style=\"padding: 0.5rem 1rem; font-size: 0.875rem; background: #7c3aed; color: white;\">Set Password</button>"
      : '';
    const toggleBtn = emp.is_inactive
      ? "<button class=\"btn btn-success\" onclick='toggleEmployeeStatus(" + emailArg + ", false)' style=\"padding: 0.5rem 1rem; font-size: 0.875rem;\">Activate</button>"
      : "<button class=\"btn btn-danger\" onclick='toggleEmployeeStatus(" + emailArg + ", true)' style=\"padding: 0.5rem 1rem; font-size: 0.875rem;\">Deactivate</button>";
    const removeBtn = "<button class=\"btn btn-danger\" onclick='removeEmployeeAccount(" + emailArg + ")' style=\"padding: 0.5rem 1rem; font-size: 0.875rem; background: #7f1d1d;\">Remove User</button>";

    tableHTML += '<tr>' +
      '<td>' + safeStaffCode + '</td>' +
      '<td>' + safeName + '</td>' +
      '<td>' + safeDepartment + '</td>' +
      '<td><span style="text-transform: capitalize;">' + safeRole + '</span></td>' +
      '<td>' + typeBadge + '</td>' +
      '<td>' + safeAnnualLeaveBase + '</td>' +
      '<td style="font-weight: 600; color: #059669;">' + safeBalanceAl + '</td>' +
      '<td style="font-weight: 600; color: #0E7490;">' + safeBalanceCarry + '</td>' +
      '<td>' + safeBalanceSl + '</td>' +
      '<td>' + statusBadge + '</td>' +
      '<td><div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">' + editBtn + resetPwdBtn + toggleBtn + removeBtn + '</div></td>' +
      '</tr>';
  }

  tableBody.innerHTML = tableHTML;
}

async function resetEmployeePassword(email) {
  if (!isSuperAdmin()) {
    await uiAlert('Only superadmin can reset employee passwords.');
    return;
  }

  const newPassword = await uiPrompt(
    `Enter a new password for ${email}:`,
    { title: 'Set Employee Password', placeholder: 'At least 3 characters' }
  );
  if (newPassword === null) return;
  if (String(newPassword).length < 3) {
    await uiAlert('Password must be at least 3 characters.');
    return;
  }

  const confirmPassword = await uiPrompt(
    `Confirm the new password for ${email}:`,
    { title: 'Confirm Password' }
  );
  if (confirmPassword === null) return;
  if (String(newPassword) !== String(confirmPassword)) {
    await uiAlert('Passwords do not match.');
    return;
  }

  if (!(await uiConfirm(`Apply new password for ${email}?`))) {
    return;
  }

  try {
    const response = await fetch(`${API_BASE}/admin/employees/${encodeURIComponent(email)}/reset-password`, {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify({ newPassword: String(newPassword) })
    });
    const result = await response.json();
    if (!response.ok) {
      await uiAlert(result.error || 'Failed to reset password.');
      return;
    }
    await uiAlert(`Password updated for ${email}.`, 'Success');
  } catch (error) {
    console.error('Reset employee password error:', error);
    await uiAlert('Failed to reset password. Please try again.');
  }
}

async function removeEmployeeAccount(email) {
  if (!email) return;
  if (!(await uiConfirm(`Remove user account ${email}?\n\nThis will permanently delete employee profile, balances, and linked records.`))) {
    return;
  }

  try {
    const response = await fetch(`${API_BASE}/admin/employees/${encodeURIComponent(email)}`, {
      method: 'DELETE',
      headers: getAuthHeaders()
    });

    const result = await response.json();
    if (!response.ok) {
      await uiAlert(result.error || 'Failed to remove user account');
      return;
    }

    await uiAlert(result.message || 'User account removed successfully.', 'Success');
    await loadEmployeeManagement();
  } catch (error) {
    console.error('Remove employee account error:', error);
    await uiAlert('Failed to remove user account. Please try again.');
  }
}

async function loadHolidayManagement() {
  try {
    const response = await fetch(`${API_BASE}/admin/holidays`, {
      headers: getAuthHeaders()
    });
    if (!response.ok) throw new Error('Failed to load holidays');
    holidayManagementData = await response.json();
    holidayManagementData.sort((a, b) => String(b.date || '').localeCompare(String(a.date || '')));
    renderHolidayManagementRows();
  } catch (error) {
    console.error('Error loading holiday management data:', error);
    const tableBody = document.getElementById('holidayListTable');
    if (tableBody) {
      tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #dc2626; padding: 2rem;">Failed to load holidays.</td></tr>';
    }
  }
}

function renderHolidayManagementRows() {
  const tableBody = document.getElementById('holidayListTable');
  if (!tableBody) return;

  if (!holidayManagementData || holidayManagementData.length === 0) {
    tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #6b7280; padding: 2rem;">No holidays found</td></tr>';
    return;
  }

  tableBody.innerHTML = holidayManagementData.map((h) => {
    const safeDate = String(h.date || '');
    const safeName = String(h.name || '');
    const dateArg = escapeHtml(JSON.stringify(safeDate));
    const nameArg = escapeHtml(JSON.stringify(safeName));
    return (
      '<tr>' +
      `<td>${escapeHtml(safeDate)}</td>` +
      `<td>${escapeHtml(safeName)}</td>` +
      '<td>' +
      '<div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">' +
      `<button class="btn" onclick='editHoliday(${dateArg}, ${nameArg})' style="padding: 0.5rem 1rem; font-size: 0.875rem; background: #3b82f6; color: white;">Edit</button>` +
      `<button class="btn btn-danger" onclick='deleteHoliday(${dateArg})' style="padding: 0.5rem 1rem; font-size: 0.875rem;">Delete</button>` +
      '</div>' +
      '</td>' +
      '</tr>'
    );
  }).join('');
}

async function addHoliday() {
  const date = (document.getElementById('holidayDateInput')?.value || '').trim();
  const name = (document.getElementById('holidayNameInput')?.value || '').trim();
  if (!date || !name) {
    await uiAlert('Please input both holiday date and holiday name.');
    return;
  }

  try {
    const response = await fetch(`${API_BASE}/admin/holidays`, {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify({ date, name })
    });
    const result = await response.json();
    if (!response.ok) {
      await uiAlert(result.error || 'Failed to add holiday');
      return;
    }
    await uiAlert('Holiday added successfully.', 'Success');
    document.getElementById('holidayNameInput').value = '';
    await loadHolidayManagement();
    await loadCalendar();
  } catch (error) {
    console.error('Add holiday error:', error);
    await uiAlert('Failed to add holiday. Please try again.');
  }
}

async function editHoliday(oldDate, oldName) {
  const newDate = await uiPrompt('Update holiday date (YYYY-MM-DD):', {
    title: 'Edit Holiday Date',
    defaultValue: oldDate
  });
  if (newDate === null) return;

  const newName = await uiPrompt('Update holiday name:', {
    title: 'Edit Holiday Name',
    defaultValue: oldName
  });
  if (newName === null) return;

  const date = String(newDate || '').trim();
  const name = String(newName || '').trim();
  if (!date || !name) {
    await uiAlert('Holiday date and name are required.');
    return;
  }

  try {
    const response = await fetch(`${API_BASE}/admin/holidays/${encodeURIComponent(oldDate)}`, {
      method: 'PUT',
      headers: getAuthHeaders(),
      body: JSON.stringify({ date, name })
    });
    const result = await response.json();
    if (!response.ok) {
      await uiAlert(result.error || 'Failed to update holiday');
      return;
    }
    await uiAlert('Holiday updated successfully.', 'Success');
    await loadHolidayManagement();
    await loadCalendar();
  } catch (error) {
    console.error('Edit holiday error:', error);
    await uiAlert('Failed to update holiday. Please try again.');
  }
}

async function deleteHoliday(date) {
  if (!(await uiConfirm(`Delete holiday ${date}?`))) return;
  try {
    const response = await fetch(`${API_BASE}/admin/holidays/${encodeURIComponent(date)}`, {
      method: 'DELETE',
      headers: getAuthHeaders()
    });
    const result = await response.json();
    if (!response.ok) {
      await uiAlert(result.error || 'Failed to delete holiday');
      return;
    }
    await uiAlert('Holiday deleted successfully.', 'Success');
    await loadHolidayManagement();
    await loadCalendar();
  } catch (error) {
    console.error('Delete holiday error:', error);
    await uiAlert('Failed to delete holiday. Please try again.');
  }
}




function openAddEmployeeModal() {
  document.getElementById('addEmployeeForm').reset();
  const newEmployeeHireDate = document.getElementById('newEmployeeHireDate');
  if (newEmployeeHireDate) {
    newEmployeeHireDate.value = formatLocalDateYMD(new Date());
  }
  const newRoleSelect = document.getElementById('newEmployeeRole');
  if (newRoleSelect) {
    newRoleSelect.innerHTML = buildRoleOptionsHtml(isSuperAdmin());
    newRoleSelect.value = 'employee';
  }
  const newTypeSelect = document.getElementById('newEmployeeType');
  if (newTypeSelect) newTypeSelect.value = 'true';
  const newAnnualBaseInput = document.getElementById('newEmployeeAnnualLeaveBase');
  if (newAnnualBaseInput) newAnnualBaseInput.value = '12';
  openModal('addEmployeeModal');
}

async function toggleEmployeeStatus(email, setInactive) {
  const action = setInactive ? 'deactivate' : 'activate';
  
  if (!(await uiConfirm('Are you sure you want to ' + action + ' this employee?'))) {
	return;
  }
  
  try {
	const response = await fetch(`${API_BASE}/admin/employees/${encodeURIComponent(email)}/inactive`, {
	  method: 'PATCH',
	  headers: getAuthHeaders(),
	  body: JSON.stringify({
		is_inactive: setInactive
	  })
	});
	
	const data = await response.json();
	
	if (!response.ok) {
	  await uiAlert(data.error || 'Failed to update employee status');
	  return;
	}
	
	await uiAlert('Employee ' + action + 'd successfully');
	loadEmployeeManagement();
	
  } catch (error) {
	console.error('Error updating employee status:', error);
	await uiAlert('Failed to update employee status. Please try again.');
  }
}

// ===== Add Employee Form Handler =====
window.addEventListener('DOMContentLoaded', function() {
  const addEmployeeForm = document.getElementById('addEmployeeForm');
  
  if (addEmployeeForm) {
	addEmployeeForm.addEventListener('submit', async (e) => {
	  e.preventDefault();
	  
	  const email = document.getElementById('newEmployeeEmail').value.trim();
	  const name = document.getElementById('newEmployeeName').value.trim();
	  const staffCode = document.getElementById('newEmployeeStaffCode').value.trim();
	  const role = document.getElementById('newEmployeeRole').value;
		  const department = document.getElementById('newEmployeeDepartment').value.trim();
		  const location = document.getElementById('newEmployeeLocation').value.trim();
		  const managerEmail = document.getElementById('newEmployeeManager').value.trim();
		  const hireDate = document.getElementById('newEmployeeHireDate').value;
		  const isOfficeStaff = document.getElementById('newEmployeeType').value === 'true';
		  const annualLeaveBase = parseFloat(document.getElementById('newEmployeeAnnualLeaveBase').value) || 12;
	  
	  if (!email || !name || !staffCode || !hireDate) {
		await uiAlert('Please fill in all required fields');
		return;
	  }
	  
	  try {
		const response = await fetch(`${API_BASE}/admin/employees`, {
		  method: 'POST',
		  headers: getAuthHeaders(),
		  body: JSON.stringify({
			email,
			name,
			staffCode,
			role,
				department,
				location,
				managerEmail: managerEmail || null,
				isOfficeStaff,
				hireDate,
				annualLeaveBase
			  })
		});
		
		const data = await response.json();
		
		if (!response.ok) {
		  await uiAlert(data.error || 'Failed to add employee');
		  return;
		}
		
	  await uiAlert('Employee added successfully! Default password: Staff Code + "lms"');
		closeModal('addEmployeeModal');
		loadEmployeeManagement();
		
	  } catch (error) {
		console.error('Error adding employee:', error);
		await uiAlert('Failed to add employee. Please try again.');
	  }
	});
  }
});

window.addEventListener('DOMContentLoaded', function() {
  loadPublicCalendar();
});

// ===== Audit Logs Functions =====
let auditCurrentOffset = 0;
const auditPageSize = 50;

async function loadAuditLogs(offset = 0) {
  try {
    auditCurrentOffset = offset;
    
    const action = document.getElementById('filterAction')?.value || '';
    const userEmail = document.getElementById('filterUserEmail')?.value || '';
    const startDate = document.getElementById('filterStartDate')?.value || '';
    const endDate = document.getElementById('filterEndDate')?.value || '';
    
    const params = new URLSearchParams({
      limit: auditPageSize,
      offset: offset
    });
    
    if (action) params.append('action', action);
    if (userEmail) params.append('userEmail', userEmail);
    if (startDate) params.append('startDate', startDate);
    if (endDate) params.append('endDate', endDate);
    
    const response = await fetch(`${API_BASE}/admin/audit-logs?${params.toString()}`, {
      headers: getAuthHeaders()
    });
    
    if (!response.ok) {
      throw new Error('Failed to load audit logs');
    }
    
    const data = await response.json();
    
    const tableBody = document.getElementById('auditLogsTable');
    
    if (!tableBody) {
      console.error('Audit logs table body not found!');
      return;
    }
    
    if (data.logs.length === 0) {
      tableBody.innerHTML = 
        '<tr>' +
        '<td colspan="7" style="text-align: center; color: #6b7280; padding: 2rem;">' +
        'No audit logs found' +
        '</td>' +
        '</tr>';
      
      // Update pagination info
      document.getElementById('auditPaginationInfo').textContent = 'No records found';
      document.getElementById('auditPrevBtn').disabled = true;
      document.getElementById('auditNextBtn').disabled = true;
      
      return;
    }
    
    // Build table rows
    let tableHTML = '';
    
    for (let i = 0; i < data.logs.length; i++) {
      const log = data.logs[i];
      const actionText = String(log.action || '');
      const userEmailText = String(log.user_email || '-');
      const ipText = String(log.ip_address || '-');
      const createdAtText = formatDateTime(log.created_at);
      const detailsRaw = String(log.details || '');
      const userAgentRaw = String(log.user_agent || '');
      
      // Color code actions
      let actionColor = '#374151';
      let actionBg = '#f3f4f6';
      
      if (actionText.includes('EDIT') || actionText.includes('UPDATE')) {
        actionColor = '#1e40af';
        actionBg = '#dbeafe';
      } else if (actionText.includes('DELETE') || actionText.includes('REJECT')) {
        actionColor = '#991b1b';
        actionBg = '#fee2e2';
      } else if (actionText.includes('ADD') || actionText.includes('APPROVE')) {
        actionColor = '#065f46';
        actionBg = '#d1fae5';
      } else if (actionText.includes('Login')) {
        actionColor = '#6b7280';
        actionBg = '#f9fafb';
      }
      
      // Truncate user agent
      const userAgent = userAgentRaw ? (userAgentRaw.length > 50 ? userAgentRaw.substring(0, 50) + '...' : userAgentRaw) : '-';
      
      // Truncate details if too long
      const details = detailsRaw ? (detailsRaw.length > 100 ? detailsRaw.substring(0, 100) + '...' : detailsRaw) : '-';
      
      tableHTML += '<tr>' +
        '<td>' + escapeHtml(log.id) + '</td>' +
        '<td style="white-space: nowrap;">' + escapeHtml(createdAtText) + '</td>' +
        '<td>' + escapeHtml(userEmailText) + '</td>' +
        '<td>' +
        '<span style="padding: 0.25rem 0.75rem; background: ' + actionBg + '; color: ' + actionColor + '; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; white-space: nowrap;">' +
        escapeHtml(actionText || '-') +
        '</span>' +
        '</td>' +
        '<td style="font-size: 0.875rem; max-width: 300px; overflow: hidden; text-overflow: ellipsis;" title="' + escapeHtml(detailsRaw) + '">' + escapeHtml(details) + '</td>' +
        '<td style="font-family: monospace; font-size: 0.875rem;">' + escapeHtml(ipText) + '</td>' +
        '<td style="font-size: 0.75rem; color: #6b7280; max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="' + escapeHtml(userAgentRaw) + '">' + escapeHtml(userAgent) + '</td>' +
        '</tr>';
    }
    
    tableBody.innerHTML = tableHTML;
    
    // Update pagination
    const startRecord = offset + 1;
    const endRecord = Math.min(offset + data.logs.length, data.pagination.total);
    
    document.getElementById('auditPaginationInfo').textContent = 
      `Showing ${startRecord} to ${endRecord} of ${data.pagination.total} records`;
    
    document.getElementById('auditPrevBtn').disabled = offset === 0;
    document.getElementById('auditNextBtn').disabled = !data.pagination.hasMore;
    
  } catch (error) {
    console.error('Error loading audit logs:', error);
    const tableBody = document.getElementById('auditLogsTable');
    if (tableBody) {
      tableBody.innerHTML = 
        '<tr>' +
        '<td colspan="7" style="text-align: center; color: #dc2626; padding: 2rem;">' +
        'Failed to load audit logs. Please try again.' +
        '</td>' +
        '</tr>';
    }
  }
}

function loadAuditLogsPage(direction) {
  if (direction === 'prev') {
    loadAuditLogs(Math.max(0, auditCurrentOffset - auditPageSize));
  } else if (direction === 'next') {
    loadAuditLogs(auditCurrentOffset + auditPageSize);
  }
}

function resetAuditFilters() {
  document.getElementById('filterAction').value = '';
  document.getElementById('filterUserEmail').value = '';
  document.getElementById('filterStartDate').value = '';
  document.getElementById('filterEndDate').value = '';
  loadAuditLogs(0);
}

// Format date and time
function formatDateTime(dateStr) {
  if (!dateStr) return '-';
  const date = new Date(dateStr);
  if (Number.isNaN(date.getTime())) return String(dateStr);
  return date.toLocaleString('en-GB', {
    timeZone: HKT_TIMEZONE,
    year: 'numeric',
    month: 'short',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  });
}

function parseDateOnlyLocal(dateStr) {
  if (!dateStr) return null;
  const parts = String(dateStr).split('-');
  if (parts.length !== 3) return null;
  const year = Number(parts[0]);
  const month = Number(parts[1]);
  const day = Number(parts[2]);
  if (!year || !month || !day) return null;
  const d = new Date(year, month - 1, day);
  return Number.isNaN(d.getTime()) ? null : d;
}

function daysInYearLocal(year) {
  return new Date(year, 1, 29).getMonth() === 1 ? 366 : 365;
}

function round2Local(value) {
  return Math.round((Number(value) || 0) * 100) / 100;
}

function getProRatedALAsOfDateLocal(annualBase, hireDateStr, asOfDate) {
  const asOf = new Date(asOfDate.getFullYear(), asOfDate.getMonth(), asOfDate.getDate());
  const year = asOf.getFullYear();
  const yearStart = new Date(year, 0, 1);
  const hire = parseDateOnlyLocal(hireDateStr);
  const accrualStart = hire && hire > yearStart ? hire : yearStart;
  if (accrualStart > asOf) return 0;
  const elapsedDays = Math.floor((asOf - accrualStart) / 86400000);
  const entitled = (Number(annualBase) || 0) * (elapsedDays / daysInYearLocal(year));
  return round2Local(entitled);
}

function refreshEditEmployeeProRatedAL(options = {}) {
  const applyToBalance = options.applyToBalance === true;
  const hireDateEl = document.getElementById('editEmployeeHireDate');
  const baseEl = document.getElementById('editAnnualLeaveBase');
  const alEl = document.getElementById('editBalanceAl');
  const previewEl = document.getElementById('editProRatedPreview');
  if (!hireDateEl || !baseEl || !alEl) return;

  const hireDate = hireDateEl.value;
  const annualBase = parseFloat(baseEl.value) || 0;
  if (!hireDate) {
    if (previewEl) previewEl.textContent = '';
    return;
  }

  const hktToday = parseDateOnlyLocal(formatLocalDateYMD(new Date()));
  const autoAL = getProRatedALAsOfDateLocal(annualBase, hireDate, hktToday || new Date());
  if (applyToBalance) {
    alEl.value = autoAL.toFixed(2);
  }
  if (previewEl) {
    previewEl.textContent = `Auto-calculated AL as of today: ${autoAL.toFixed(2)} day(s).`;
  }
}

// ===== Open Edit Employee Modal =====
async function openEditEmployeeModal(email) {
  try {
    const response = await fetch(`${API_BASE}/admin/employees`, {
      headers: getAuthHeaders()
    });
    
    if (!response.ok) throw new Error('Failed to load employee data');
    
    const employees = await response.json();
    const emp = employees.find(e => e.email === email);
    
    if (!emp) {
      await uiAlert('Employee not found');
      return;
    }
    
    // Populate form
    document.getElementById('editEmployeeEmail').value = emp.email;
    document.getElementById('editEmployeeEmailDisplay').value = emp.email;
    document.getElementById('editEmployeeName').value = emp.name || '';
    document.getElementById('editEmployeeStaffCode').value = emp.staff_code || '';
    const editRoleSelect = document.getElementById('editEmployeeRole');
    if (editRoleSelect) {
      const allowAdminRole = isSuperAdmin();
      const isSelfSuperAdminEdit =
        allowAdminRole &&
        String(currentUser && currentUser.email ? currentUser.email : '').toLowerCase() === String(emp.email || '').toLowerCase();
      editRoleSelect.innerHTML = buildRoleOptionsHtml(allowAdminRole || emp.role === 'admin');
      editRoleSelect.value = (String(emp.email || '').toLowerCase() === 'it@example.com') ? 'admin' : (emp.role || 'employee');
      editRoleSelect.disabled = (emp.role === 'admin' && !allowAdminRole) || isSelfSuperAdminEdit;
    }
    document.getElementById('editEmployeeDepartment').value = emp.department || '';
    document.getElementById('editEmployeeLocation').value = emp.location || '';
    document.getElementById('editEmployeeManager').value = emp.manager_email || '';
    document.getElementById('editEmployeeType').value = emp.is_office_staff ? 'true' : 'false';
    document.getElementById('editEmployeeHireDate').value = emp.hire_date || '';
    document.getElementById('editOriginalHireDate').value = emp.hire_date || '';
    document.getElementById('editOriginalAnnualLeaveBase').value = emp.annual_leave_base || 13;
    document.getElementById('editAnnualLeaveBase').value = emp.annual_leave_base || 13;
    document.getElementById('editCarryOverResetMonth').value = emp.carry_over_reset_month || 10;
    document.getElementById('editBalanceAl').value = emp.balance_al || 0;
    document.getElementById('editBalanceAlCarryOver').value = emp.balance_al_carry_over || 0;
    document.getElementById('editBalanceBl').value = emp.balance_bl || 0;
    document.getElementById('editBalanceCl').value = emp.balance_cl || 0;
    document.getElementById('editBalanceCpl').value = emp.balance_cpl || 0;
    document.getElementById('editBalanceDc').value = emp.balance_dc || 0;
    document.getElementById('editBalanceMl').value = emp.balance_ml || 0;
    document.getElementById('editBalancePl').value = emp.balance_pl || 0;
    document.getElementById('editBalanceSl').value = emp.balance_sl || 0;
    refreshEditEmployeeProRatedAL({ applyToBalance: false });
    
    openModal('editEmployeeModal');
    
  } catch (error) {
    console.error('Error loading employee:', error);
    await uiAlert('Failed to load employee data');
  }
}


// ===== Handle Edit Employee Form Submission =====
window.addEventListener('DOMContentLoaded', function() {
const editForm = document.getElementById('editEmployeeForm');

if (editForm) {
  const hireDateInput = document.getElementById('editEmployeeHireDate');
  const annualBaseInput = document.getElementById('editAnnualLeaveBase');
  if (hireDateInput) hireDateInput.addEventListener('change', () => refreshEditEmployeeProRatedAL({ applyToBalance: true }));
  if (annualBaseInput) annualBaseInput.addEventListener('input', () => refreshEditEmployeeProRatedAL({ applyToBalance: true }));

  editForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('editEmployeeEmail').value;
    
    const data = {
      name: document.getElementById('editEmployeeName').value.trim(),
      department: document.getElementById('editEmployeeDepartment').value.trim(),
      managerEmail: document.getElementById('editEmployeeManager').value.trim(),
      location: document.getElementById('editEmployeeLocation').value.trim(),
      staffCode: document.getElementById('editEmployeeStaffCode').value.trim(),
      isOfficeStaff: document.getElementById('editEmployeeType').value === 'true',
      hireDate: document.getElementById('editEmployeeHireDate').value || null,
      annualLeaveBase: parseFloat(document.getElementById('editAnnualLeaveBase').value) || 13,
      carryOverResetMonth: parseInt(document.getElementById('editCarryOverResetMonth').value) || 10,
      balanceAl: parseFloat(document.getElementById('editBalanceAl').value) || 0,
      balanceAlCarryOver: parseFloat(document.getElementById('editBalanceAlCarryOver').value) || 0,
      balanceBl: parseFloat(document.getElementById('editBalanceBl').value) || 0,
      balanceCl: parseFloat(document.getElementById('editBalanceCl').value) || 0,
      balanceCpl: parseFloat(document.getElementById('editBalanceCpl').value) || 0,
      balanceDc: parseFloat(document.getElementById('editBalanceDc').value) || 0,
      balanceMl: parseFloat(document.getElementById('editBalanceMl').value) || 0,
      balancePl: parseFloat(document.getElementById('editBalancePl').value) || 0,
      balanceSl: parseFloat(document.getElementById('editBalanceSl').value) || 0
    };

    const editRoleSelect = document.getElementById('editEmployeeRole');
    if (editRoleSelect && !editRoleSelect.disabled) {
      data.role = editRoleSelect.value;
    }

    const originalHireDate = document.getElementById('editOriginalHireDate').value || '';
    const originalAnnualLeaveBase = parseFloat(document.getElementById('editOriginalAnnualLeaveBase').value) || 13;
    const joinDateChanged = originalHireDate !== (data.hireDate || '');
    const annualBaseChanged = Number(originalAnnualLeaveBase) !== Number(data.annualLeaveBase);
    data.recalculateAL = joinDateChanged || annualBaseChanged;

    if (data.recalculateAL) {
      refreshEditEmployeeProRatedAL({ applyToBalance: true });
      data.balanceAl = parseFloat(document.getElementById('editBalanceAl').value) || 0;
    }
    
    if (!data.name) {
      await uiAlert('Name is required');
      return;
    }
    
    const confirmMessage = data.recalculateAL
      ? `Join Date or AL base changed.\nAL will be auto-recalculated.\n\nContinue?`
      : 'Are you sure you want to update this employee?\n\nAll changes will be logged in the audit trail with your IP address.';

    if (!(await uiConfirm(confirmMessage))) {
      return;
    }
    
    try {
      const response = await fetch(`${API_BASE}/admin/employees/${encodeURIComponent(email)}`, {
        method: 'PUT',
        headers: getAuthHeaders(),
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      
      if (!response.ok) {
        await uiAlert(result.error || 'Failed to update employee');
        return;
      }
      
      await uiAlert('Employee updated successfully.\n\nChanges have been logged in the audit trail.', 'Success');
      closeModal('editEmployeeModal');
      loadEmployeeManagement();
      
    } catch (error) {
      console.error('Error updating employee:', error);
      await uiAlert('Failed to update employee. Please try again.');
    }
  });
}

});


// ===== SMTP Settings =====
function canEditSMTPSettings() {
  return isSuperAdmin();
}

function applySMTPAccessControl() {
  const editable = canEditSMTPSettings();
  const fieldIds = [
    'smtpHost',
    'smtpPort',
    'smtpEnabled',
    'smtpUseAuth',
    'smtpUsername',
    'smtpPassword',
    'smtpFromEmail'
  ];
  fieldIds.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.disabled = !editable;
  });

  const saveBtn = document.getElementById('smtpSaveBtn');
  if (saveBtn) saveBtn.disabled = !editable;
  const testBtn = document.getElementById('smtpTestBtn');
  if (testBtn) testBtn.disabled = !editable;
  const actionButtons = document.getElementById('smtpActionButtons');
  if (actionButtons) actionButtons.style.display = editable ? 'flex' : 'none';
  const smtpSettingsContent = document.getElementById('smtpSettingsContent');
  if (smtpSettingsContent) smtpSettingsContent.style.display = editable ? 'block' : 'none';

  const notice = document.getElementById('smtpReadOnlyNotice');
  if (notice) notice.style.display = editable ? 'none' : 'block';
}

function toggleSMTPAuthFields() {
  applySMTPAccessControl();
  if (!canEditSMTPSettings()) return;
  const useAuth = (document.getElementById('smtpUseAuth')?.value || 'true') === 'true';
  const username = document.getElementById('smtpUsername');
  const password = document.getElementById('smtpPassword');
  if (username) username.disabled = !useAuth;
  if (password) password.disabled = !useAuth;
}

async function loadSMTPConfig() {
  if (!canEditSMTPSettings()) {
    applySMTPAccessControl();
    return;
  }

  try {
    const response = await fetch(`${API_BASE}/admin/smtp-config`, {
      headers: getAuthHeaders()
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(errorData.error || 'Failed to load SMTP settings');
    }

    const config = await response.json();
    document.getElementById('smtpHost').value = (config && config.host) || '';
    document.getElementById('smtpPort').value = (config && config.port) || 587;
    document.getElementById('smtpUseAuth').value = String(config && typeof config.use_auth === 'boolean' ? config.use_auth : true);
    document.getElementById('smtpUsername').value = (config && config.username) || '';
    document.getElementById('smtpPassword').value = (config && config.password) || '';
    document.getElementById('smtpFromEmail').value = (config && config.from_email) || '';
    document.getElementById('smtpEnabled').value = String(config && typeof config.is_enabled === 'boolean' ? config.is_enabled : false);
    applySMTPAccessControl();
    toggleSMTPAuthFields();
  } catch (error) {
    console.error('Error loading SMTP settings:', error);
    await uiAlert(error.message || 'Failed to load SMTP settings.');
  }
}

async function saveSMTPSettings() {
  if (!canEditSMTPSettings()) {
    await uiAlert('Only superadmin can change SMTP settings. Please contact IT (it@example.com).');
    return;
  }

  const host = document.getElementById('smtpHost').value.trim();
  const port = parseInt(document.getElementById('smtpPort').value, 10);
  const useAuth = document.getElementById('smtpUseAuth').value === 'true';
  const username = document.getElementById('smtpUsername').value.trim();
  const password = document.getElementById('smtpPassword').value;
  const from_email = document.getElementById('smtpFromEmail').value.trim();
  const is_enabled = document.getElementById('smtpEnabled').value === 'true';

  if (!host || !port || !from_email) {
    await uiAlert('Host, Port, and From Email are required.');
    return;
  }

  if (useAuth && (!username || !password)) {
    await uiAlert('Username and Password are required when Use Auth is enabled.');
    return;
  }

  if (!(await uiConfirm('Save SMTP settings now?\n\nThis will update email sending configuration system-wide.'))) {
    return;
  }

  try {
    const response = await fetch(`${API_BASE}/admin/smtp-config`, {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify({
        host,
        port,
        use_auth: useAuth,
        username,
        password,
        from_email,
        is_enabled
      })
    });

    const result = await response.json();
    if (!response.ok) {
      throw new Error(result.error || 'Failed to save SMTP settings');
    }

    await uiAlert('SMTP settings saved successfully.', 'Success');
  } catch (error) {
    console.error('Error saving SMTP settings:', error);
    await uiAlert(`Failed to save SMTP settings: ${error.message}`);
  }
}

async function testSMTPSettings() {
  if (!canEditSMTPSettings()) {
    await uiAlert('Only superadmin can run SMTP tests. Please contact IT (it@example.com).');
    return;
  }

  const defaultTo = document.getElementById('smtpFromEmail')?.value || '';
  const toEmail = await uiPrompt('Send test email to:', { title: 'Test SMTP', defaultValue: defaultTo });
  if (toEmail === null) return;

  try {
    const response = await fetch(`${API_BASE}/admin/smtp-test`, {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify({ to_email: String(toEmail).trim() })
    });
    const result = await response.json().catch(() => ({}));
    if (!response.ok) {
      await uiAlert(result.error || 'Failed to send test email.');
      return;
    }
    await uiAlert('Test email sent successfully.', 'Success');
  } catch (error) {
    console.error('SMTP test error:', error);
    await uiAlert('Failed to send test email. Please try again.');
  }
}

// ===== CSV Exports =====
function setMonthlyApprovedReportMonthDefault() {
  const input = document.getElementById('monthlyApprovedReportMonth');
  if (!input || input.value) return;
  input.value = getCurrentHktMonthValue();
}

async function exportReport(reportType) {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch(`${API_BASE}/reports/${encodeURIComponent(reportType)}`, {
      headers: {
        'Authorization': token ? `Bearer ${token}` : ''
      }
    });

    if (!response.ok) {
      let errorMessage = 'Failed to export report';
      try {
        const err = await response.json();
        if (err && err.error) errorMessage = err.error;
      } catch (_) {}
      throw new Error(errorMessage);
    }

    const blob = await response.blob();
    const disposition = response.headers.get('content-disposition') || '';
    const filenameMatch = disposition.match(/filename="?([^"]+)"?/i);
    const filename = filenameMatch ? filenameMatch[1] : `${reportType}.csv`;

    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    link.remove();
    window.URL.revokeObjectURL(url);
  } catch (error) {
    console.error('Error exporting report:', error);
    await uiAlert(`Export failed: ${error.message}`);
  }
}

async function exportMonthlyIndividualApprovedLeaveReport() {
  const monthInput = document.getElementById('monthlyApprovedReportMonth');
  const selectedMonth = String(monthInput?.value || '').trim();
  const params = new URLSearchParams();
  if (selectedMonth) params.set('month', selectedMonth);
  const reportType = 'monthly-individual-approved-leave';
  const url = params.toString()
    ? `${API_BASE}/reports/${encodeURIComponent(reportType)}?${params.toString()}`
    : `${API_BASE}/reports/${encodeURIComponent(reportType)}`;
  try {
    const token = localStorage.getItem('token');
    const response = await fetch(url, {
      headers: {
        'Authorization': token ? `Bearer ${token}` : ''
      }
    });

    if (!response.ok) {
      let errorMessage = 'Failed to export report';
      try {
        const err = await response.json();
        if (err && err.error) errorMessage = err.error;
      } catch (_) {}
      throw new Error(errorMessage);
    }

    const blob = await response.blob();
    const disposition = response.headers.get('content-disposition') || '';
    const filenameMatch = disposition.match(/filename=\"?([^\"]+)\"?/i);
    const filename = filenameMatch ? filenameMatch[1] : `${reportType}.csv`;

    const dlUrl = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = dlUrl;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    link.remove();
    window.URL.revokeObjectURL(dlUrl);
  } catch (error) {
    console.error('Error exporting report:', error);
    await uiAlert(`Export failed: ${error.message}`);
  }
}

function readBooleanSetting(value, defaultValue = false) {
  if (value === undefined || value === null || value === '') return defaultValue;
  const text = String(value).trim().toLowerCase();
  return text === 'true' || text === '1' || text === 'yes' || text === 'on';
}

// ===== Load Carry Over Settings =====
async function loadCarryOverSettings() {
  try {
    const response = await fetch(`${API_BASE}/admin/system-settings`, {
      headers: getAuthHeaders()
    });
    
    if (!response.ok) {
      console.error('Failed to load carry over settings');
      return;
    }
    
    const settings = await response.json();
    
    document.getElementById('carryOverEnabled').value = settings.al_carry_over_enabled || 'true';
    document.getElementById('carryOverMaxDays').value = settings.al_carry_over_max_days || '99';
    document.getElementById('carryOverDeadlineMonth').value = settings.al_carry_over_deadline_month || '10';
    document.getElementById('carryOverDeadlineDay').value = settings.al_carry_over_deadline_day || '31';
    document.getElementById('carryOverForfeitEnabled').value = settings.al_carry_over_forfeit_enabled || 'false';
    document.getElementById('approvedLeaveDeleteWindowDays').value = settings.approved_leave_admin_delete_window_days || '14';
    document.getElementById('jan1ResetBlEnabled').checked = readBooleanSetting(settings.jan1_reset_bl_enabled, true);
    document.getElementById('jan1ResetClEnabled').checked = readBooleanSetting(settings.jan1_reset_cl_enabled, false);
    document.getElementById('jan1ResetCplEnabled').checked = readBooleanSetting(settings.jan1_reset_cpl_enabled, false);
    document.getElementById('jan1ResetDcEnabled').checked = readBooleanSetting(settings.jan1_reset_dc_enabled, false);
    document.getElementById('jan1ResetMlEnabled').checked = readBooleanSetting(settings.jan1_reset_ml_enabled, false);
    document.getElementById('jan1ResetPlEnabled').checked = readBooleanSetting(settings.jan1_reset_pl_enabled, false);
    document.getElementById('jan1ResetSlEnabled').checked = readBooleanSetting(settings.jan1_reset_sl_enabled, false);
    
    // Load rollover history
    loadRolloverHistory();
    
  } catch (error) {
    console.error('Error loading carry over settings:', error);
  }
}

// ===== Save Carry Over Settings =====
async function saveCarryOverSettings() {
  try {
    const settings = {
      al_carry_over_enabled: document.getElementById('carryOverEnabled').value,
      al_carry_over_max_days: document.getElementById('carryOverMaxDays').value,
      al_carry_over_deadline_month: document.getElementById('carryOverDeadlineMonth').value,
      al_carry_over_deadline_day: document.getElementById('carryOverDeadlineDay').value,
      al_carry_over_forfeit_enabled: document.getElementById('carryOverForfeitEnabled').value,
      approved_leave_admin_delete_window_days: document.getElementById('approvedLeaveDeleteWindowDays').value,
      jan1_reset_bl_enabled: String(document.getElementById('jan1ResetBlEnabled').checked),
      jan1_reset_cl_enabled: String(document.getElementById('jan1ResetClEnabled').checked),
      jan1_reset_cpl_enabled: String(document.getElementById('jan1ResetCplEnabled').checked),
      jan1_reset_dc_enabled: String(document.getElementById('jan1ResetDcEnabled').checked),
      jan1_reset_ml_enabled: String(document.getElementById('jan1ResetMlEnabled').checked),
      jan1_reset_pl_enabled: String(document.getElementById('jan1ResetPlEnabled').checked),
      jan1_reset_sl_enabled: String(document.getElementById('jan1ResetSlEnabled').checked)
    };
    
    if (!(await uiConfirm('Save these system settings?\n\nChanges will affect all employees system-wide.'))) {
      return;
    }
    
    const response = await fetch(`${API_BASE}/admin/system-settings`, {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify({ settings })
    });
    
    if (!response.ok) {
      throw new Error('Failed to save settings');
    }
    
    await uiAlert('System settings saved successfully!', 'Success');
    
  } catch (error) {
    console.error('Error saving carry over settings:', error);
    await uiAlert('Failed to save settings. Please try again.');
  }
}

// ===== Trigger Manual Rollover =====
async function triggerManualRollover() {
  const confirmation = await uiPrompt(
    '‚ö†Ô∏è WARNING: This will run the year-end rollover process NOW.\n\n' +
    'This will:\n' +
    '‚Ä¢ Transfer all unused AL to carry over for ALL active employees\n' +
    '‚Ä¢ Reset regular AL balance to completed-day pro-rata entitlement\n' +
    '‚Ä¢ Log all changes in audit trail\n\n' +
    'Type "ROLLOVER" to confirm:',
    { title: 'Manual Rollover' }
  );
  
  if (confirmation !== 'ROLLOVER') {
    await uiAlert('Rollover cancelled.');
    return;
  }
  
  try {
    const response = await fetch(`${API_BASE}/admin/trigger-rollover`, {
      method: 'POST',
      headers: getAuthHeaders()
    });
    
    const result = await response.json();
    
    if (!response.ok) {
      throw new Error(result.error || 'Failed to trigger rollover');
    }
    
    await uiAlert(`Rollover completed successfully.\n\n${result.processed} employees processed.\n\nCheck the history table below for details.`, 'Success');
    
    // Refresh history
    loadRolloverHistory();
    
  } catch (error) {
    console.error('Error triggering rollover:', error);
    await uiAlert('Failed to trigger rollover: ' + error.message);
  }
}

// ===== Load Rollover History =====
async function loadRolloverHistory() {
  try {
    const response = await fetch(`${API_BASE}/admin/rollover-history?limit=20`, {
      headers: getAuthHeaders()
    });
    
    if (!response.ok) {
      throw new Error('Failed to load history');
    }
    
    const history = await response.json();
    const tableBody = document.getElementById('rolloverHistoryTable');
    
    if (history.length === 0) {
      tableBody.innerHTML = 
        '<tr>' +
        '<td colspan="4" style="text-align: center; color: #6b7280; padding: 2rem;">' +
        'No rollover history yet' +
        '</td>' +
        '</tr>';
      return;
    }
    
    let html = '';
    history.forEach(log => {
      const date = new Date(log.created_at).toLocaleString('en-GB', { 
        timeZone: 'Asia/Hong_Kong',
        year: 'numeric',
        month: 'short',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      html += '<tr>' +
        '<td>' + escapeHtml(date) + '</td>' +
        '<td><strong>' + escapeHtml(log.action || '') + '</strong></td>' +
        '<td style="font-size: 0.875rem;">' + escapeHtml(log.details || '') + '</td>' +
        '<td>' + escapeHtml(log.user_email || 'System') + '</td>' +
        '</tr>';
    });
    
    tableBody.innerHTML = html;
    
  } catch (error) {
    console.error('Error loading rollover history:', error);
  }
}
</script>

</body>
</html>
